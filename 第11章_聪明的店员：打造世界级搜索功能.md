## ç¬¬11ç« ï¼šèªæ˜çš„åº—å‘˜ï¼šæ‰“é€ ä¸–ç•Œçº§æœç´¢åŠŸèƒ½

æˆ‘ä»¬çš„å¹³å°æ—¥ç›Šå¼ºå¤§ç¨³å¥ã€‚æˆ‘ä»¬å·²ç»æ”»å…‹äº†ç¨³å®šæ€§éš¾é¢˜ï¼Œå¾æœäº†è§„æ¨¡æŒ‘æˆ˜ï¼Œé©¯æœäº†æ¶æ„å¤æ‚æ€§ã€‚æˆ‘ä»¬çš„ç³»ç»Ÿå ªç§°ç°ä»£å·¥ç¨‹çš„å…¸èŒƒã€‚ç„¶è€Œï¼Œ**å†å¼ºå¤§çš„å¼•æ“ï¼Œè‹¥æ–¹å‘ç›˜å¤±çµä¹Ÿç»ˆå°†å¯¸æ­¥éš¾è¡Œã€‚** è€Œå¯¹äºæˆ‘ä»¬çš„ç”¨æˆ·è€Œè¨€ï¼Œæœç´¢æ â€”â€”è¿™ä¸ªç”µå•†å¹³å°æœ€å…³é”®çš„äº¤äº’å…¥å£â€”â€”å´ä»æ ¹æœ¬ä¸Šå‡ºäº†é—®é¢˜ã€‚

è¿™ä¸æ˜¯ä¸€ä¸ªå…³äºæœåŠ¡å™¨ (Server) å®•æœºçš„æƒŠé™©æ•…äº‹ï¼Œè€Œæ˜¯å…³äºå®¢æˆ·æŒ«è´¥æ„Ÿä¸é”€å”®æœºä¼šæµå¤±çš„è­¦ç¤ºå½•ã€‚è¿™æ˜¯æˆ‘ä»¬å¦‚ä½•å°†"æ„šé’"çš„æœç´¢æ å‡çº§ä¸ºæ™ºèƒ½å‘ç°å¼•æ“çš„å®æˆ˜å†ç¨‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ·±åˆ»é¢†æ‚Ÿåˆ°ï¼š**ä¸€ä¸ªä¼Ÿå¤§çš„å¹³å°ï¼Œä¸ä»…åœ¨äºä½ æ„å»ºäº†ä»€ä¹ˆåŠŸèƒ½ï¼Œæ›´åœ¨äºä½ å¦‚ä½•å¸®åŠ©ç”¨æˆ·ç²¾å‡†æ‰¾åˆ°ä»–ä»¬æ‰€éœ€ã€‚**

### Part 1ï¼šç ´ç¢æœç´¢çš„æŒ«è´¥æ„Ÿ

è¿™ä¸ªé—®é¢˜å¹¶éä»¥ä»ªè¡¨ç›˜ä¸Šåˆºçœ¼çš„çº¢è‰²è­¦æŠ¥å½¢å¼æµ®ç°ï¼Œè€Œæ˜¯åŒ–ä½œä¸€å°å……æ»¡æ²®ä¸§çš„ç”µå­é‚®ä»¶ï¼Œæ¥è‡ªæˆ‘ä»¬å¢é•¿æœ€è¿…çŒ›çš„å–å®¶ä¹‹ä¸€ã€‚ä»–åœ¨ å°åº—é€š ä¸Šç»è¥ç€ä¸€å®¶é¢‡å…·è§„æ¨¡çš„åœ¨çº¿é‹åº—ï¼Œæ­£å…¨åŠ›æŠ•å…¥æ’ç¯èŠ‚ä¿ƒé”€æ´»åŠ¨çš„è¥é”€æˆ˜å½¹ã€‚å¹¿å‘Šå¸¦æ¥äº†å¤§é‡æµé‡ï¼Œé”€å”®è½¬åŒ–ç‡å´å¼‚å¸¸æƒ¨æ·¡ã€‚

"æˆ‘çš„å®¢æˆ·åœ¨ç–¯ç‹‚æŠ±æ€¨ï¼Œ"ä»–åœ¨é‚®ä»¶ä¸­å†™é“ï¼Œ"ä»–ä»¬æœç´¢'è·‘é‹'å´å¾—åˆ°é›¶ç»“æœã€‚æˆ‘çš„åº—é“ºæ˜æ˜æœ‰è¶…è¿‡200æ¬¾ä¸åŒçš„è·‘é‹ï¼ä»–ä»¬æœç´¢'è¿åŠ¨é‹'åŒæ ·ä¸€æ— æ‰€è·ã€‚æˆ‘æœ€ç•…é”€çš„æ˜æ˜Ÿäº§å“æ˜¯'è€å…‹é£é©¬38ç”·å£«è·‘é‹'(Nike Air Zoom Pegasus 38 Men's Running Shoe)ï¼Œä½†å®¢æˆ·åªè¦ç¨å¾®æ”¹ä¸ªè¯ï¼Œè¾“å…¥'è€å…‹é£é©¬è·‘é‹'(Nike Pegasus running shoes)ï¼Œç³»ç»Ÿå°±å®Œå…¨æ‰¾ä¸åˆ°äº†ã€‚**è¿™ç®€ç›´æ˜¯ä¸€åœºç¾éš¾ï¼ä½ ä»¬çš„å¹³å°æ­£åœ¨è®©æˆ‘æµå¤±çœŸé‡‘ç™½é“¶ã€‚**"

ç‹å³° (ç‹å³°) ç«‹å³å¯Ÿè§‰åˆ°äº†é—®é¢˜çš„ä¸šåŠ¡ä¸¥é‡æ€§ã€‚æˆ‘ä»¬æ·±å…¥æŒ–æ˜åˆ†ææ•°æ®ï¼Œç»“æœä»¤äººæ²®ä¸§ï¼šä½¿ç”¨æœç´¢æ çš„ç”¨æˆ·è½¬åŒ–ç‡ä»…ä¸ºæ‰‹åŠ¨æµè§ˆç”¨æˆ·çš„ **é›¶å¤´**ã€‚æœç´¢æ éä½†æ²¡æœ‰å¸®åŠ©ç”¨æˆ·æ‰¾åˆ°ç›®æ ‡å•†å“ï¼Œåè€Œåƒä¸€å µæ— å½¢çš„å¢™ï¼ŒæŠŠä»–ä»¬ä¸»åŠ¨æ¨å‘æ­»èƒ¡åŒã€‚

#### **è¯†åˆ«é—®é¢˜ï¼š"æ„šé’çš„"åº—å‘˜**

é—®é¢˜çš„æ ¹æºåœ¨äºï¼Œæˆ‘ä»¬åœ¨å¿«é€Ÿè¿­ä»£ MVPï¼ˆæœ€å°å¯è¡Œäº§å“ï¼ŒMinimum Viable Productï¼‰æ—¶ï¼Œé‡‡ç”¨äº†ä¸€ç§è¿‡äºç®€å•ç²—æš´çš„æœç´¢å®ç°æ–¹å¼ã€‚å½“ç”¨æˆ·è¾“å…¥æœç´¢å…³é”®è¯æ—¶ï¼Œç³»ç»Ÿåªæ˜¯åœ¨ PostgreSQL æ•°æ®åº“ (Database) ä¸Šæ‰§è¡Œä¸€ä¸ªæœ€åŸºç¡€çš„ SQL å‘½ä»¤ï¼š

```sql
SELECT * FROM products WHERE name ILIKE '%running shoes%';
```

Postgres ä¸­çš„ `ILIKE` å‘½ä»¤æ‰§è¡Œä¸åŒºåˆ†å¤§å°å†™çš„**å­ä¸²åŒ¹é… (Substring Matching)**ã€‚å®ƒå®è´¨ä¸Šåœ¨é—®æ•°æ®åº“ï¼š"å­—æ¯åºåˆ— 'r-u-n-n-i-n-g- -s-h-o-e-s' æ˜¯å¦ä»¥**å®Œå…¨ç›¸åŒçš„é¡ºåº**å‡ºç°åœ¨äº§å“åç§°çš„æŸä¸ªä½ç½®ï¼Ÿ"

å¯¹äºä¸€ä¸ªæ—¨åœ¨ä½œä¸ºäº¤æ˜“æƒå¨è®°å½• (Source of Truth) çš„å…³ç³»å‹æ•°æ®åº“æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå®Œå…¨åˆç†çš„æŸ¥è¯¢ (Query)ã€‚ä½†å¯¹äºè¯•å›¾æ‰¾åˆ°å¿ƒä»ªå•†å“çš„çœŸå®å®¢æˆ·æ¥è¯´ï¼Œè¿™ç§æŸ¥æ‰¾æ–¹å¼å´æ˜¾å¾—**æå…¶æ„šé’å’Œæœºæ¢°**ã€‚

- **ç±»æ¯”ï¼š** æˆ‘ä»¬çš„ PostgreSQL æœç´¢å°±åƒä¸€ä¸ª**æåº¦å­—é¢ä¸»ä¹‰çš„æ„šé’å›¾ä¹¦ç®¡ç†å‘˜**ã€‚å‡å¦‚ä½ è¯¢é—®ä¸€æœ¬å…³äº"ç¾å›½æ±½è½¦"çš„ä¹¦ï¼Œä»–ä¼šæœºæ¢°åœ°èµ°è¿‡æ¯ä¸€æ’ä¹¦æ¶ï¼Œé€ä¸€æ£€è§†ä¹¦åï¼Œåªæ‹¿å‡ºé‚£äº›åŒ…å«**å®Œå…¨ç›¸åŒçŸ­è¯­**"ç¾å›½æ±½è½¦"çš„ä¹¦ç±ã€‚ä»–ä¼šå®Œå…¨æ— è§†æ ‡é¢˜ä¸º"ç¾å›½çš„æ±½è½¦"æˆ–"ç¦ç‰¹ä¸é€šç”¨æ±½è½¦å‘å±•å²"çš„ç›¸å…³ä¹¦ç±ã€‚è¿™ä½ç®¡ç†å‘˜ç¼ºä¹æœ€åŸºæœ¬çš„ä¸Šä¸‹æ–‡ç†è§£å’Œè¯­ä¹‰è”æƒ³èƒ½åŠ›ã€‚

#### **æŠ€æœ¯æ·±å…¥æ¢è®¨ï¼šä¸ºä»€ä¹ˆç®€å•çš„æ•°æ®åº“æœç´¢å¯¹ç”µå•†æ— æ•ˆ**

æˆ‘ä»¬çš„"æ„šé’åº—å‘˜"åœ¨**å››ä¸ªå…³é”®ç»´åº¦**ä¸Šå½»åº•è¾œè´Ÿäº†ç”¨æˆ·æœŸå¾…ï¼š

**1. å®Œç¾ä¸»ä¹‰å¼ºè¿«ç—‡** â€” å®ƒåªèƒ½åŒ¹é…**å®Œå…¨ç›¸åŒé¡ºåº**çš„ç²¾ç¡®å­ä¸²ã€‚ä¸€ä¸ªæ ‡é¢˜ä¸º **"Nike Running Shoe for Men"** çš„å•†å“ï¼Œä¸ä¼šè¢«æœç´¢ **"Nike shoes for running"** æ‰¾åˆ°ã€‚æ‰€æœ‰å•è¯æ˜æ˜éƒ½åœ¨ï¼Œä½†é¡ºåºç¨æœ‰ä¸åŒå°±å®Œå…¨åŒ¹é…å¤±è´¥ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæœç´¢å¤æ•°å½¢å¼ **"shoes"** æ— æ³•æ‰¾åˆ°å•æ•°å½¢å¼ **"Shoe"** çš„å•†å“ã€‚

**2. é›¶ä¸Šä¸‹æ–‡ç†è§£** â€” ç³»ç»Ÿå®Œå…¨ä¸æ‡‚äººç±»è‡ªç„¶è¯­è¨€çš„ä¸°å¯Œæ€§ã€‚å®ƒä¸çŸ¥é“ "sneakers"ï¼ˆè¿åŠ¨é‹ï¼‰å’Œ "trainers"ï¼ˆè®­ç»ƒé‹ï¼‰éƒ½æ˜¯ "running shoes"ï¼ˆè·‘é‹ï¼‰çš„åŒä¹‰è¯ã€‚å®ƒä¸ç†è§£ "run"ã€"runs"ã€"running" éƒ½æºè‡ªåŒä¸€è¯æ ¹ï¼ˆè¿™ä¸ªè¯­è¨€å­¦æ¦‚å¿µç§°ä¸º **è¯å¹²æå–ï¼ŒStemming**ï¼‰ã€‚

**3. æ‹¼å†™é”™è¯¯é›¶å®¹å¿** â€” å¦‚æœç”¨æˆ·åœ¨æ‰‹æœºä¸Šä¸å°å¿ƒè¾“å…¥äº† **"runing shoes"**ï¼ˆå°‘äº†ä¸€ä¸ª 'n'ï¼‰ï¼ŒILIKE æŸ¥è¯¢å°†**è¿”å›é›¶ç»“æœ**ã€‚å¯¹ä»»ä½•äººä¸ºå¤±è¯¯é›¶å®¹å¿ï¼Œè¿™å¯¹é¢å‘çœŸå®ç”¨æˆ·çš„ç³»ç»Ÿæ¥è¯´æ˜¯è‡´å‘½ç¼ºé™·ã€‚

**4. æ— ç›¸å…³æ€§æ’åº** â€” å³ä½¿ä¾¥å¹¸æ‰¾åˆ°äº†åŒ¹é…é¡¹ï¼Œç³»ç»Ÿä¹Ÿä¼šä»¥æ•°æ®åº“çš„é»˜è®¤é¡ºåºï¼ˆé€šå¸¸æ˜¯æŒ‰åˆ›å»ºæ—¶é—´ï¼‰ç›²ç›®è¿”å›ç»“æœã€‚ä¸€ä»¶æ°å¥½åœ¨äº§å“æè¿°æœ«å°¾æåˆ°"çµæ„Ÿæºè‡ªå¤å¤è·‘é‹è®¾è®¡"çš„æ™®é€šTæ¤ï¼Œä¼šå’Œçƒ­é”€çˆ†æ¬¾è·‘é‹è¢«**åŒç­‰å¯¹å¾…**ã€‚æœ€ç›¸å…³ã€æœ€è¯¥å±•ç¤ºçš„æ ¸å¿ƒäº§å“è¢«æ·¹æ²¡åœ¨å™ªéŸ³ä¸­ã€‚

æ­¤å¤–ï¼Œè¿™äº› `LIKE '%...%'` æ¨¡ç³ŠæŸ¥è¯¢å¯¹æ•°æ®åº“æ¥è¯´è‡­åæ˜­è‘—åœ°**ç¼“æ…¢ä¸”ä½æ•ˆ**ã€‚å®ƒä»¬æ— æ³•æœ‰æ•ˆåˆ©ç”¨æ ‡å‡† B-Tree ç´¢å¼• (Index)ï¼Œé€šå¸¸è¿«ä½¿æ•°æ®åº“æ‰§è¡Œ**"å…¨è¡¨æ‰«æ"(Full Table Scan)** â€”â€”é€è¡Œè¯»å–è¡¨ä¸­æ¯ä¸ªäº§å“è®°å½•æ¥æŸ¥æ‰¾åŒ¹é…é¡¹ã€‚éšç€å–å®¶å•†å“ç›®å½•ä»å‡ ç™¾æ‰©å±•åˆ°ä¸Šä¸‡ï¼Œæœç´¢å“åº”æ—¶é—´å‘ˆçº¿æ€§æ¶åŒ–ï¼Œç»™æˆ‘ä»¬çš„è¯»å‰¯æœ¬ (Read Replica) æ–½åŠ äº†ä¸å¿…è¦çš„æ²‰é‡å‹åŠ›ã€‚

```mermaid
%%{init: {'theme':'dark'}}%%
graph LR
    A[ç”¨æˆ·æœç´¢:<br/>'Nike running shoes'] --> B{PostgreSQL ILIKE<br/>å…¨è¡¨æ‰«æ}
    B --> C1[äº§å“1<br/>é€è¡ŒåŒ¹é…]
    B --> C2[äº§å“2<br/>é€è¡ŒåŒ¹é…]
    B --> C3[äº§å“3<br/>é€è¡ŒåŒ¹é…]
    B --> C4[äº§å“N<br/>é€è¡ŒåŒ¹é…]
    C1 --> D[ç»“æœ:<br/>âŒ é¡ºåºä¸å¯¹<br/>âŒ æ‹¼å†™é”™è¯¯<br/>âŒ æ— ç›¸å…³æ€§æ’åº]
    C2 --> D
    C3 --> D
    C4 --> D
    
    style A fill:#374151,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
    style B fill:#1f2937,stroke:#ef4444,color:#f3f4f6,stroke-width:3px
    style C1 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style C2 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style C3 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style C4 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style D fill:#1f2937,stroke:#ef4444,color:#f3f4f6,stroke-width:2px
```

**â–² å›¾ï¼šPostgreSQL ILIKE çš„æ„šé’æœç´¢æµç¨‹**

æˆ‘ä»¬å¾—å‡ºäº†ä¸€ä¸ªæ˜ç¡®çš„ç»“è®ºï¼š**æˆ‘ä»¬çš„æœç´¢åŠŸèƒ½ä¸æ˜¯å¯ä»¥é€šè¿‡ä¸€äº›å¾®è°ƒæ¥ä¿®è¡¥çš„è¾¹è§’é—®é¢˜ã€‚æ•´ä¸ªåº•å±‚æ–¹æ³•ä»æ ¹æœ¬ä¸Šå°±ä¸é€‚åˆç”µå•†åœºæ™¯ã€‚** æˆ‘ä»¬ä¸èƒ½è®­ç»ƒæ„šé’çš„åº—å‘˜å˜å¾—æ›´èªæ˜ã€‚æˆ‘ä»¬å¿…é¡»è¾é€€ä»–ï¼Œé›‡ç”¨ä¸€ä½å¤©æ‰ç ”ç©¶åŠ©ç†ã€‚

### Part 2ï¼šå¤©æ‰åº—å‘˜

æˆ‘ä»¬çš„æ—§æœç´¢ç³»ç»Ÿå·²ç»æˆä¸ºæ²‰é‡è´Ÿæ‹…ã€‚è¿™ä¸æ˜¯ç”¨ä¸€äº›èªæ˜çš„ SQL æŠ€å·§èƒ½ä¿®å¤çš„é—®é¢˜â€”â€”**åŸºç¡€æ¶æ„æœ¬èº«å°±ä»æ ¹å­ä¸Šé€‰é”™äº†ã€‚** æˆ‘ä»¬ä¸éœ€è¦é‡æ–°åŸ¹è®­æ„šé’çš„åº—å‘˜ï¼Œæˆ‘ä»¬éœ€è¦å½»åº•æ¢äººï¼Œé›‡ç”¨ä¸€ä½ä¸–ç•Œé¡¶å°–çš„å¤©æ‰ç ”ç©¶åŠ©ç†ã€‚åœ¨æ·±å…¥ç ”ç©¶æœç´¢æŠ€æœ¯é¢†åŸŸä¹‹åï¼Œç­”æ¡ˆæ˜­ç„¶è‹¥æ­ï¼šæˆ‘ä»¬éœ€è¦ **Elasticsearchï¼ˆå¼¹æ€§æœç´¢å¼•æ“ï¼‰**ã€‚

Elasticsearch æ˜¯ä¸€ä¸ªå¼€æºçš„ã€åˆ†å¸ƒå¼çš„**å…¨æ–‡æœç´¢ä¸åˆ†æå¼•æ“ (Full-Text Search and Analytics Engine)**ã€‚å®ƒ**ä¸æ˜¯**æˆ‘ä»¬ PostgreSQL æ•°æ®åº“çš„æ›¿ä»£å“ï¼›ä¸¤è€…èŒè´£å®Œå…¨ä¸åŒã€‚Elasticsearch æ˜¯ä¸€ä¸ªé«˜åº¦ä¸“ä¸šåŒ–çš„å·¥å…·ï¼Œå°±åƒä¸€çº§æ–¹ç¨‹å¼èµ›è½¦ï¼Œä¸ºä¸€ä¸ªç›®çš„è€Œç²¾å¿ƒæ‰“é€ ï¼š**åœ¨æµ·é‡æ–‡æœ¬ä¸­ä»¥æ¯«ç§’çº§é€Ÿåº¦æ‰§è¡Œæå…¶æ™ºèƒ½çš„æœç´¢ã€‚**

#### **æŠ€æœ¯æ·±å…¥æ¢è®¨ï¼šElasticsearch çš„è¶…èƒ½åŠ›**

è¦ç†è§£ä¸ºä»€ä¹ˆ Elasticsearch åœ¨ç”µå•†æœç´¢ä¸­å¦‚æ­¤å‡ºè‰²ï¼Œä½ éœ€è¦ç†è§£å®ƒçš„æ ¸å¿ƒè¶…èƒ½åŠ›ã€‚

```mermaid
%%{init: {'theme':'dark'}}%%
graph TB
    subgraph PG[PostgreSQL å…³ç³»å‹æ•°æ®åº“]
        PG1[ä¸¥è°¨è®°è´¦å‘˜<br/>ä¸€ä¸ä¸è‹Ÿçš„å®ˆæŠ¤è€…]
        PG2[ç²¾ç¡®æŸ¥è¯¢:<br/>'book_title = X']
        PG3[é€‚åˆ:<br/>äº¤æ˜“ã€å…³ç³»ã€ACID]
    end
    
    subgraph ES[Elasticsearch æœç´¢å¼•æ“]
        ES1[å¤©æ‰ç ”ç©¶åŠ©ç†<br/>å¤šè¯­è¨€è¯­ä¹‰ä¸“å®¶]
        ES2[æ™ºèƒ½æœç´¢:<br/>'æœªæ¥+æ‚²ä¼¤+æœºå™¨äºº']
        ES3[é€‚åˆ:<br/>å…¨æ–‡ã€æ¨¡ç³Šã€ç›¸å…³æ€§]
    end
    
    User[ç”¨æˆ·éœ€æ±‚] --> Question{é—®é¢˜ç±»å‹?}
    Question -->|ç²¾ç¡®æŸ¥è¯¢<br/>ç¡®åˆ‡ä¹¦å| PG
    Question -->|æ¨¡ç³Šæœç´¢<br/>ä¸»é¢˜æ¦‚å¿µ| ES
    
    style PG fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:2px
    style PG1 fill:#374151,stroke:#10b981,color:#f3f4f6
    style PG2 fill:#374151,stroke:#10b981,color:#f3f4f6
    style PG3 fill:#374151,stroke:#10b981,color:#f3f4f6
    style ES fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style ES1 fill:#374151,stroke:#f59e0b,color:#f3f4f6
    style ES2 fill:#374151,stroke:#f59e0b,color:#f3f4f6
    style ES3 fill:#374151,stroke:#f59e0b,color:#f3f4f6
    style User fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style Question fill:#1f2937,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
```

**â–² å›¾ï¼šPostgreSQL vs. Elasticsearch çš„èŒè´£åˆ†å·¥**

- **ç±»æ¯”ï¼š** å¦‚æœ PostgreSQL æ˜¯æˆ‘ä»¬**ä¸€ä¸ä¸è‹Ÿã€æœ‰æ¡ç†çš„æ¡£æ¡ˆç®¡ç†å‘˜**ï¼Œæ˜¯æ¯æœ¬ä¹¦æƒå¨ä¸»è®°å½•çš„å®ˆæŠ¤è€…ï¼Œé‚£ä¹ˆ **Elasticsearch** å°±æ˜¯**å¤©æ‰çš„å¤šè¯­è¨€ç ”ç©¶åŠ©ç†**ï¼Œä»–ä»¬é€šè¯»è¿‡æ¯ä¸€æœ¬ä¹¦ï¼Œåˆ›å»ºäº†åºå¤§çš„ã€äº¤å‰å¼•ç”¨çš„è¯­ä¹‰ç´¢å¼•ï¼Œæ¶µç›–æ¯ä¸ªæ¦‚å¿µã€å…³é”®è¯ã€åŒä¹‰è¯å’Œå…³è”æœ¯è¯­ã€‚ä½ å‘æ¡£æ¡ˆç®¡ç†å‘˜ç´¢è¦ç¡®åˆ‡ä¹¦åçš„ä¹¦ç±ã€‚ä½ å‘ç ”ç©¶åŠ©ç†è¯¢é—®"å…³äºæœªæ¥ã€æ‚²ä¼¤çš„æœºå™¨äººçš„ä¹¦"ï¼Œä»–ä»¬ä¼šç«‹å³ç»™ä½ ä¸€ä¸ª**æŒ‰ç›¸å…³æ€§å®Œç¾æ’åº**çš„æ¨èåˆ—è¡¨ã€‚

ä»¥ä¸‹æ˜¯å¤©æ‰åŠ©ç†å¦‚ä½•æ–½å±•é­”æ³•ï¼š

**è¶…èƒ½åŠ› #1ï¼šå€’æ’ç´¢å¼• (Inverted Index)ï¼ˆé€Ÿåº¦çš„ç§˜å¯†ï¼‰** 

ä¼ ç»Ÿæ•°æ®åº“åœ¨æœç´¢å…³é”®è¯æ—¶ï¼Œå¿…é¡»é€è¡Œè¯»å–æ¯ä¸ªäº§å“æè¿°æ‰èƒ½æ‰¾åˆ°åŒ¹é…é¡¹ã€‚Elasticsearch åˆ™**åå…¶é“è€Œè¡Œä¹‹**ï¼Œé‡‡ç”¨ **å€’æ’ç´¢å¼• (Inverted Index)** æŠ€æœ¯ã€‚

**å·¥ä½œåŸç†ï¼š** åœ¨ä½ æœç´¢ä¹‹å‰ï¼ŒElasticsearch ä¼šé¢„å…ˆè¯»å–æ‰€æœ‰äº§å“æ•°æ®ï¼Œæ„å»ºä¸€ä¸ªç±»ä¼¼æ•™ç§‘ä¹¦æœ«å°¾ç´¢å¼•çš„æ˜ å°„è¡¨ã€‚å®ƒå°†æ¯ä¸ªç‹¬ç«‹çš„è¯æ±‡ï¼ˆTermï¼‰æ˜ å°„åˆ°åŒ…å«è¯¥è¯çš„æ‰€æœ‰æ–‡æ¡£ ID åˆ—è¡¨ï¼š

```
"nike"    â†’ [Product-1, Product-5, Product-88, Product-120]
"running" â†’ [Product-1, Product-7, Product-23, Product-88]
"shoes"   â†’ [Product-1, Product-23, Product-55, Product-88]
```

å½“ä½ æœç´¢ "nike running shoes" æ—¶ï¼ŒElasticsearch **ä¸éœ€è¦è¯»å–ä»»ä½•äº§å“æ•°æ®**ã€‚å®ƒåªéœ€æŸ¥é˜…é¢„å»ºçš„å€’æ’ç´¢å¼•ï¼Œæ‰¾åˆ° "nike"ã€"running" å’Œ "shoes" ä¸‰ä¸ªè¯å¯¹åº”çš„æ–‡æ¡£åˆ—è¡¨ï¼Œç„¶åè®¡ç®—**äº¤é›†** (Intersection)â€”â€”åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°±æ˜¯ Product-1 å’Œ Product-88ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒèƒ½åœ¨æ¯«ç§’å†…åœ¨æ•°ç™¾ä¸‡æ–‡æ¡£ä¸­ç²¾å‡†å®šä½åŒ¹é…é¡¹ã€‚

```mermaid
%%{init: {'theme':'dark'}}%%
graph TB
    subgraph Index[å€’æ’ç´¢å¼•é¢„æ„å»ºé˜¶æ®µ]
        P1[Product-1:<br/>'Nike Running Shoe']
        P2[Product-88:<br/>'Nike Shoes Running']
        P3[Product-23:<br/>'Running Socks']
        
        P1 --> T1[nike]
        P1 --> T2[running]
        P1 --> T3[shoe]
        
        P2 --> T1
        P2 --> T2
        P2 --> T4[shoes]
        
        P3 --> T2
        P3 --> T5[socks]
    end
    
    subgraph Search[æœç´¢æŸ¥è¯¢é˜¶æ®µ]
        Q[æœç´¢: 'nike running shoes'] --> L1[æŸ¥ç´¢å¼•: 'nike']
        Q --> L2[æŸ¥ç´¢å¼•: 'running']
        Q --> L3[æŸ¥ç´¢å¼•: 'shoes']
        
        L1 --> R1[Product-1, Product-88]
        L2 --> R2[Product-1, Product-23, Product-88]
        L3 --> R3[Product-1, Product-88]
        
        R1 --> Result[äº¤é›†è®¡ç®—:<br/>Product-1 âœ“<br/>Product-88 âœ“]
        R2 --> Result
        R3 --> Result
    end
    
    style Index fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:2px
    style P1 fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style P2 fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style P3 fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style T1 fill:#1f2937,stroke:#f59e0b,color:#f3f4f6
    style T2 fill:#1f2937,stroke:#f59e0b,color:#f3f4f6
    style T3 fill:#1f2937,stroke:#f59e0b,color:#f3f4f6
    style T4 fill:#1f2937,stroke:#f59e0b,color:#f3f4f6
    style T5 fill:#1f2937,stroke:#f59e0b,color:#f3f4f6
    style Search fill:#1f2937,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
    style Q fill:#374151,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
    style L1 fill:#374151,stroke:#10b981,color:#f3f4f6
    style L2 fill:#374151,stroke:#10b981,color:#f3f4f6
    style L3 fill:#374151,stroke:#10b981,color:#f3f4f6
    style R1 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style R2 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style R3 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style Result fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:3px
```

**â–² å›¾ï¼šå€’æ’ç´¢å¼•å·¥ä½œåŸç†â€”â€”ä»"æŸ¥æ–‡æ¡£æ‰¾è¯"åˆ°"æŸ¥è¯æ‰¾æ–‡æ¡£"**

**è¶…èƒ½åŠ› #2ï¼šé«˜çº§æ–‡æœ¬åˆ†æï¼ˆæ™ºèƒ½çš„ç§˜å¯†ï¼‰** 

Elasticsearch ä¸ä»…ä»…å­˜å‚¨æ–‡æœ¬ï¼›å®ƒä¼š**æ·±åº¦åˆ†ææ–‡æœ¬ä»¥ç†è§£å…¶è¯­ä¹‰å«ä¹‰**ã€‚å½“æˆ‘ä»¬ç´¢å¼•ä¸€ä¸ªäº§å“æ ‡é¢˜ "Nike's Best Running Shoes" æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä¸€ç³»åˆ—æ™ºèƒ½å¤„ç†ç®¡é“ (Analysis Pipeline)ï¼š

**1. åˆ†è¯ (Tokenization)** â€” å°†è¿ç»­æ–‡æœ¬åˆ†è§£ä¸ºç‹¬ç«‹çš„è¯æ±‡å•å…ƒï¼ˆTokenï¼‰ï¼š  
`Nike's` â†’ `Best` â†’ `Running` â†’ `Shoes`

**2. è§„èŒƒåŒ– (Normalization)** â€” ç»Ÿä¸€å¤§å°å†™ï¼Œå»é™¤æ‰€æœ‰æ ¼ç­‰ï¼š  
`nike's` â†’ `best` â†’ `running` â†’ `shoes`

**3. è¯å¹²æå–/è¯å½¢è¿˜åŸ (Stemming/Lemmatization)** â€” å°†å•è¯è¿˜åŸä¸ºè¯æ ¹å½¢å¼ï¼š  
`running` â†’ `run`ï¼Œ`shoes` â†’ `shoe`

è¿™æ„å‘³ç€ç”¨æˆ·æœç´¢ "run shoe" ä¹Ÿèƒ½åŒ¹é…åˆ° "Running Shoes"ã€‚**è¿™ä¸€ä¸ªåŠŸèƒ½å°±è§£å†³äº†æˆ‘ä»¬ä¹‹å‰é‡åˆ°çš„ä¸€å¤§åŠé—®é¢˜ã€‚**

**4. åŒä¹‰è¯æ‰©å±• (Synonym Expansion)** â€” æˆ‘ä»¬å¯ä»¥ä¸º Elasticsearch é…ç½®è‡ªå®šä¹‰åŒä¹‰è¯è¯å…¸ï¼Œæ•™ä¼šå®ƒ "sneakers"ï¼ˆè¿åŠ¨é‹ï¼‰ã€"trainers"ï¼ˆè®­ç»ƒé‹ï¼‰ã€"kicks"ï¼ˆçƒé‹ä¿šè¯­ï¼‰éƒ½æ˜¯ "shoes" çš„åŒä¹‰è¯ã€‚ç°åœ¨ï¼Œæœç´¢ "Nike sneakers" ä¼šæ­£ç¡®æ‰¾åˆ°æ ‡é¢˜ä¸º "Nike Running Shoes" çš„äº§å“ã€‚

```mermaid
%%{init: {'theme':'dark'}}%%
graph LR
    A["åŸå§‹æ–‡æœ¬:<br/>'Nike's Best Running Shoes'"] --> B[åˆ†è¯<br/>Tokenization]
    B --> C["Token:<br/>Nike's | Best | Running | Shoes"]
    C --> D[è§„èŒƒåŒ–<br/>Normalization]
    D --> E["å°å†™:<br/>nike's | best | running | shoes"]
    E --> F[è¯å¹²æå–<br/>Stemming]
    F --> G["è¯æ ¹:<br/>nike | best | run | shoe"]
    G --> H[åŒä¹‰è¯æ‰©å±•<br/>Synonyms]
    H --> I["æœ€ç»ˆç´¢å¼•:<br/>nike | best | run | shoe<br/>+ sneaker | trainer | kick"]
    
    style A fill:#374151,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
    style B fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style C fill:#374151,stroke:#6b7280,color:#f3f4f6
    style D fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style E fill:#374151,stroke:#6b7280,color:#f3f4f6
    style F fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style G fill:#374151,stroke:#6b7280,color:#f3f4f6
    style H fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style I fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:3px
```

**â–² å›¾ï¼šElasticsearch æ–‡æœ¬åˆ†æç®¡é“â€”â€”ä»åŸå§‹æ–‡æœ¬åˆ°æ™ºèƒ½ç´¢å¼•**

**è¶…èƒ½åŠ› #3ï¼šç›¸å…³æ€§è¯„åˆ† (Relevance Scoring)ï¼ˆæ’åºçš„ç§˜å¯†ï¼‰** 

è¿™æ˜¯åŒºåˆ†**å¥½æœç´¢**å’Œ**å“è¶Šæœç´¢**çš„å…³é”®æ‰€åœ¨ã€‚Elasticsearch ä¸ä»…æ‰¾åˆ°åŒ¹é…ç»“æœï¼›å®ƒä¼š**æŒ‰ç›¸å…³æ€§æ™ºèƒ½æ’åº**ã€‚å®ƒä½¿ç”¨å¤æ‚çš„è¯„åˆ†ç®—æ³•ï¼ˆå¦‚ **BM25**ï¼‰ï¼Œè¡Œä¸ºå°±åƒä¸€ä½ç»éªŒä¸°å¯Œçš„é”€å”®é¡¾é—®ï¼š

- å®ƒçŸ¥é“ `product_title` å­—æ®µä¸­çš„åŒ¹é…ï¼Œè¿œæ¯”æ·±åŸ‹åœ¨ `product_description` æœ«å°¾çš„åŒ¹é…é‡è¦
- å®ƒä¸ºç½•è§å…³é”®è¯èµ‹äºˆæ›´é«˜æƒé‡ï¼ˆæœç´¢"Pegasus 38"æ¯”æœç´¢é€šç”¨çš„"shoes"æ›´å…·è¯†åˆ«æ€§ï¼‰
- å®ƒç»¼åˆè€ƒè™‘è¯é¢‘(Term Frequency)ã€é€†æ–‡æ¡£é¢‘ç‡(Inverse Document Frequency)ç­‰å¤šç»´åº¦æŒ‡æ ‡

**æœ€ç»ˆç»“æœ:ç”¨æˆ·æœ€æœ‰å¯èƒ½è´­ä¹°çš„äº§å“æ€»æ˜¯è‡ªåŠ¨æµ®ç°åœ¨æœç´¢ç»“æœé¡¶éƒ¨ã€‚**

---

<div style="border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin: 30px 0; background: linear-gradient(to right, #1e40af08, #2563eb08);">

### ğŸ“Œ ç¼–è€…æ³¨:Elasticsearchç”Ÿäº§çº§é…ç½®é€ŸæŸ¥

*10åˆ†é’ŸæŒæ¡ç´¢å¼•è®¾è®¡ã€æŸ¥è¯¢ä¼˜åŒ–å’Œç›‘æ§è¦ç‚¹*

---

#### **ä¸€ã€Dockerå¿«é€Ÿéƒ¨ç½²ESé›†ç¾¤**

```yaml
# docker-compose.yml
version: '3.8'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: es-node1
    environment:
      - node.name=es-node1
      - cluster.name=xiaodiantong-cluster
      - discovery.type=single-node  # å¼€å‘ç¯å¢ƒå•èŠ‚ç‚¹
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"  # ç”Ÿäº§ç¯å¢ƒè‡³å°‘4GB
      - xpack.security.enabled=false  # ç”Ÿäº§ç¯å¢ƒéœ€å¯ç”¨
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    ulimits:
      memlock: {soft: -1, hard: -1}
      nofile: {soft: 65536, hard: 65536}

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200

volumes:
  es-data:

# å¯åŠ¨: docker-compose up -d
# è®¿é—®: http://localhost:9200 (ES API), http://localhost:5601 (Kibana UI)
```

---

#### **äºŒã€äº§å“ç´¢å¼•è®¾è®¡(å®Œæ•´ç¤ºä¾‹)**

```python
# dukaan/search/mappings.py
PRODUCTS_INDEX_MAPPING = {
    "settings": {
        "number_of_shards": 3,  # ç”Ÿäº§ç¯å¢ƒå»ºè®®3-5ä¸ªåˆ†ç‰‡
        "number_of_replicas": 1,  # è‡³å°‘1ä¸ªå‰¯æœ¬ä¿è¯é«˜å¯ç”¨
        "analysis": {
            "analyzer": {
                "xiaodiantong_analyzer": {
                    "type": "custom",
                    "tokenizer": "standard",
                    "filter": ["lowercase", "synonym_filter", "stemmer"]
                }
            },
            "filter": {
                "synonym_filter": {
                    "type": "synonym",
                    "synonyms": [
                        "shoes, sneakers, trainers, kicks",
                        "mobile, phone, smartphone",
                        "tshirt, t-shirt, shirt"
                    ]
                },
                "stemmer": {
                    "type": "stemmer",
                    "language": "english"
                }
            }
        }
    },
    "mappings": {
        "properties": {
            "product_id": {"type": "keyword"},  # ç²¾ç¡®åŒ¹é…å­—æ®µç”¨keyword
            "name": {
                "type": "text",
                "analyzer": "xiaodiantong_analyzer",
                "fields": {
                    "keyword": {"type": "keyword"},  # ç”¨äºæ’åº/èšåˆ
                    "suggest": {"type": "completion"}  # è‡ªåŠ¨è¡¥å…¨
                }
            },
            "description": {
                "type": "text",
                "analyzer": "xiaodiantong_analyzer"
            },
            "price": {"type": "float"},
            "category": {"type": "keyword"},  # åˆ†ç±»è¿‡æ»¤
            "brand": {"type": "keyword"},
            "tags": {"type": "keyword"},  # å¤šæ ‡ç­¾æœç´¢
            "stock": {"type": "integer"},
            "rating": {"type": "float"},
            "sales_count": {"type": "integer"},
            "created_at": {"type": "date"},
            "location": {"type": "geo_point"}  # åœ°ç†ä½ç½®æœç´¢
        }
    }
}

# åˆ›å»ºç´¢å¼•
from elasticsearch import Elasticsearch
es = Elasticsearch(['http://localhost:9200'])
es.indices.create(index='products', body=PRODUCTS_INDEX_MAPPING)
```

---

#### **ä¸‰ã€æ™ºèƒ½æœç´¢æŸ¥è¯¢(Djangoé›†æˆ)**

```python
# dukaan/search/views.py
from elasticsearch import Elasticsearch
from django.http import JsonResponse

es = Elasticsearch(['http://es-master.dukaan.com:9200'])

def search_products(request):
    query = request.GET.get('q', '')
    category = request.GET.get('category', None)
    min_price = request.GET.get('min_price', 0)
    max_price = request.GET.get('max_price', 999999)
    
    # æ„å»ºå¤šæ¡ä»¶æŸ¥è¯¢
    search_body = {
        "query": {
            "bool": {
                "must": [
                    {
                        "multi_match": {  # å¤šå­—æ®µæœç´¢
                            "query": query,
                            "fields": [
                                "name^3",  # åç§°æƒé‡æœ€é«˜
                                "description",
                                "brand^2",  # å“ç‰Œæ¬¡ä¹‹
                                "tags"
                            ],
                            "type": "best_fields",
                            "fuzziness": "AUTO"  # è‡ªåŠ¨æ‹¼å†™çº é”™
                        }
                    }
                ],
                "filter": [  # è¿‡æ»¤æ¡ä»¶ä¸å½±å“è¯„åˆ†
                    {"range": {"price": {"gte": min_price, "lte": max_price}}},
                    {"term": {"stock": {"gt": 0}}}  # åªæ˜¾ç¤ºæœ‰è´§å•†å“
                ]
            }
        },
        "sort": [
            {"_score": {"order": "desc"}},  # ç›¸å…³æ€§ä¼˜å…ˆ
            {"sales_count": {"order": "desc"}}  # é”€é‡æ¬¡ä¹‹
        ],
        "highlight": {  # å…³é”®è¯é«˜äº®
            "fields": {
                "name": {},
                "description": {}
            }
        },
        "aggs": {  # èšåˆç»Ÿè®¡(ç”¨äºç­›é€‰é¢æ¿)
            "categories": {
                "terms": {"field": "category", "size": 10}
            },
            "brands": {
                "terms": {"field": "brand", "size": 20}
            },
            "price_ranges": {
                "range": {
                    "field": "price",
                    "ranges": [
                        {"to": 1000, "key": "0-1000"},
                        {"from": 1000, "to": 5000, "key": "1000-5000"},
                        {"from": 5000, "key": "5000+"}
                    ]
                }
            }
        },
        "from": (int(request.GET.get('page', 1)) - 1) * 20,
        "size": 20
    }
    
    if category:
        search_body["query"]["bool"]["filter"].append(
            {"term": {"category": category}}
        )
    
    response = es.search(index='products', body=search_body)
    
    return JsonResponse({
        'total': response['hits']['total']['value'],
        'products': [
            {
                'id': hit['_source']['product_id'],
                'name': hit['_source']['name'],
                'price': hit['_source']['price'],
                'score': hit['_score'],
                'highlight': hit.get('highlight', {})
            }
            for hit in response['hits']['hits']
        ],
        'aggregations': response['aggregations']
    })
```

---

#### **å››ã€æ•°æ®åŒæ­¥ç­–ç•¥**

```python
# æ–¹æ¡ˆ1: Djangoä¿¡å·åŒæ­¥(ç®€å•ä½†å¯èƒ½å½±å“æ€§èƒ½)
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from products.models import Product

@receiver(post_save, sender=Product)
def sync_to_elasticsearch(sender, instance, **kwargs):
    es.index(
        index='products',
        id=instance.id,
        body={
            'product_id': instance.id,
            'name': instance.name,
            'description': instance.description,
            'price': float(instance.price),
            'category': instance.category.name,
            'stock': instance.stock,
            # ... å…¶ä»–å­—æ®µ
        }
    )

@receiver(post_delete, sender=Product)
def delete_from_elasticsearch(sender, instance, **kwargs):
    es.delete(index='products', id=instance.id, ignore=[404])

# æ–¹æ¡ˆ2: Celeryå¼‚æ­¥ä»»åŠ¡(æ¨è,ä¸é˜»å¡è¯·æ±‚)
from celery import shared_task

@shared_task
def sync_product_to_es(product_id):
    product = Product.objects.get(id=product_id)
    # ... ESç´¢å¼•é€»è¾‘

# æ–¹æ¡ˆ3: Logstash/Debezium CDC(å¤§è§„æ¨¡æ¨è,è§ç¬¬9ç« )
```

---

#### **äº”ã€æ€§èƒ½ä¼˜åŒ–Checklist**

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹å¼ | æ”¶ç›Š |
|-------|---------|------|
| **ä½¿ç”¨filteræ›¿ä»£query** | ç²¾ç¡®åŒ¹é…ç”¨filter(å¯ç¼“å­˜) | +50%æŸ¥è¯¢é€Ÿåº¦ |
| **åˆ†ç‰‡æ•°é‡åˆç†åŒ–** | æ¯åˆ†ç‰‡20-40GB,æ€»åˆ†ç‰‡æ•°<èŠ‚ç‚¹æ•°Ã—20 | é¿å…è¿‡åº¦åˆ†ç‰‡ |
| **ç¦ç”¨_allå­—æ®µ** | `"_all": {"enabled": false}` | -30%å­˜å‚¨ |
| **å…³é—­åŠ¨æ€æ˜ å°„** | `"dynamic": "strict"` | é˜²æ­¢å­—æ®µçˆ†ç‚¸ |
| **æ‰¹é‡æ“ä½œ** | ä½¿ç”¨bulk APIæ‰¹é‡ç´¢å¼• | +10å€å†™å…¥é€Ÿåº¦ |
| **å®šæœŸforce_merge** | åˆå¹¶segmentå‡å°‘ç¢ç‰‡ | +20%æŸ¥è¯¢é€Ÿåº¦ |

```bash
# å¼ºåˆ¶åˆå¹¶ç´¢å¼•(å‡Œæ™¨æ‰§è¡Œ)
curl -X POST "localhost:9200/products/_forcemerge?max_num_segments=1"

# æŸ¥çœ‹é›†ç¾¤å¥åº·
curl "localhost:9200/_cluster/health?pretty"

# æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡
curl "localhost:9200/products/_stats?pretty"
```

---

#### **å…­ã€ç›‘æ§å‘Šè­¦(Prometheus+Grafana)**

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'elasticsearch'
    static_configs:
      - targets: ['es-master.dukaan.com:9114']  # elasticsearch_exporter

# å…³é”®æŒ‡æ ‡
- elasticsearch_cluster_health_status  # é›†ç¾¤çŠ¶æ€(green/yellow/red)
- elasticsearch_jvm_memory_used_bytes  # JVMå†…å­˜
- elasticsearch_indices_search_query_time_seconds  # æŸ¥è¯¢å»¶è¿Ÿ
- elasticsearch_indices_indexing_index_time_seconds  # ç´¢å¼•å»¶è¿Ÿ
```

**ğŸ“Š å°åº—é€šæœç´¢ä¼˜åŒ–æ•ˆæœ:**
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æœç´¢å“åº”æ—¶é—´  1200ms â†’ 80ms  (-93%)
æœç´¢è½¬åŒ–ç‡    2.1% â†’ 8.7%  (+314%)
ç›¸å…³æ€§å¾—åˆ†    0.45 â†’ 0.89  (BM25ç®—æ³•)
æ‹¼å†™çº é”™      0% â†’ 95%è¦†ç›–  (FuzzyåŒ¹é…)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

</div>

---

**è¶…èƒ½åŠ› #4:æ¨¡ç³ŠåŒ¹é… (Fuzzy Matching)(æ‹¼å†™å®¹é”™)** 

æœ€åä¹Ÿæ˜¯æœ€äººæ€§åŒ–çš„ä¸€ç‚¹ï¼šElasticsearch ä¸º**çœŸå®çš„äººç±»ç”¨æˆ·**è€Œè®¾è®¡ã€‚å®ƒå¯ä»¥é…ç½®ä¸ºä¼˜é›…å¤„ç†æ‹¼å†™é”™è¯¯å’Œæ‰‹è¯¯ã€‚å¦‚æœç”¨æˆ·åœ¨æ‰‹æœºä¸ŠåŒ†å¿™è¾“å…¥ **"runing sheos"**ï¼ˆå°‘äº†ä¸€ä¸ª 'n'ï¼Œ'e' å’Œ 'o' é¡ºåºåäº†ï¼‰ï¼ŒElasticsearch ä¼šæ™ºèƒ½è¯†åˆ«è¿™å¾ˆå¯èƒ½æ˜¯ "running shoes" çš„æ‹¼å†™é”™è¯¯â€”â€”å®ƒé€šè¿‡æµ‹é‡å•è¯ä¹‹é—´çš„**ç¼–è¾‘è·ç¦» (Edit Distance / Levenshtein Distance)** æ¥åˆ¤æ–­ç›¸ä¼¼åº¦ï¼Œå¹¶è¿”å›æ­£ç¡®çš„ç»“æœã€‚

å¯¹äºåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå¿«é€Ÿè¾“å…¥çš„ç”¨æˆ·æ¥è¯´ï¼Œè¿™æ˜¯**å½»åº•æ”¹å˜æ¸¸æˆè§„åˆ™**çš„åŠŸèƒ½ã€‚

---

å†³ç­–å·²å®šã€‚**Elasticsearch å°±æ˜¯æˆ‘ä»¬è¦é›‡ä½£çš„å¤©æ‰ç ”ç©¶åŠ©ç†ã€‚** æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå…¨æ–°çš„ã€ä¸“é—¨ç”¨äºæœç´¢çš„ç‹¬ç«‹å¾®æœåŠ¡ (Microservice)ã€‚

å”¯ä¸€å‰©ä¸‹çš„æŒ‘æˆ˜æ˜¯ä¸€ä¸ªç†Ÿæ‚‰çš„è€é—®é¢˜ï¼š**æˆ‘ä»¬å¦‚ä½•è®©è¿™ä¸ªæ–°çš„ä¸“ç”¨æœç´¢å¼•æ“ä¸ä¸»æ•°æ®åº“ä¿æŒå®Œç¾å®æ—¶åŒæ­¥ï¼Ÿ** ç­”æ¡ˆå†æ¬¡æŒ‡å‘æˆ‘ä»¬å·²ç»æ„å»ºçš„å¼ºå¤§ä¸­æ¢ç¥ç»ç³»ç»Ÿï¼š**Kafkaï¼ˆåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼‰**ã€‚

### Part 3ï¼šå®ç°â€”â€”ç”± Kafka é©±åŠ¨çš„ä¼˜é›…åŒæ­¥

æˆ‘ä»¬åœ¨ Elasticsearch ä¸­æ‰¾åˆ°äº†æ¢¦å¯ä»¥æ±‚çš„å¤©æ‰åŠ©ç†ã€‚ç°åœ¨æ‹¼å›¾çš„æœ€åä¸€å—æ˜¯ï¼š**ä¸ºè¿™ä½å¤©æ‰å»ºç«‹åŠå…¬å®¤ï¼Œå¹¶ç¡®ä¿ä»–å®æ—¶æ¥æ”¶ä¸»æ•°æ®åº“ä¸­å‘ç”Ÿçš„æ¯ä¸€æ¬¡æ›´æ–°ã€‚** æˆ‘ä»¬å¿…é¡»è®©æœç´¢ç´¢å¼•ä¸ä¸»æ•°æ®åº“ä¿æŒæ¯«ç§’çº§çš„å®Œç¾åŒæ­¥ã€‚

åœ¨å‡ ç« ä¹‹å‰ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªä»¤äººå¤´ç–¼çš„å¤æ‚å·¥ç¨‹æŒ‘æˆ˜â€”â€”æˆ‘ä»¬éœ€è¦å®šåˆ¶æ„å»ºä¸€ä¸ªè„†å¼±çš„ã€å®¹æ˜“å‡ºé”™çš„æ•°æ®ç®¡é“ (Pipeline)ã€‚ä½†ç°åœ¨ï¼Œ**å¾—ç›Šäºæˆ‘ä»¬ä¹‹å‰æ˜æ™ºåœ°æŠ•èµ„æ„å»ºçš„ Kafka ä¸­æ¢ç¥ç»ç³»ç»Ÿ**ï¼Œè§£å†³æ–¹æ¡ˆå˜å¾—æå…¶ç®€æ´ä¼˜é›…ã€‚

#### **æ¶æ„ï¼šæ–°å¢ä¸€ä¸ªæ™ºèƒ½ç›‘å¬å™¨**

æˆ‘ä»¬çš„ Kafka + Debezium ç»„åˆå·²ç»æˆä¸ºå¹³å°ä¸Š**æ‰€æœ‰æ•°æ®å˜æ›´çš„æƒå¨çœŸç›¸æ¥æº (Single Source of Truth)**ã€‚æˆ‘ä»¬ä¸éœ€è¦é‡æ–°å‘æ˜è½®å­ï¼Œä¸éœ€è¦æ„å»ºå…¨æ–°çš„æ•°æ®ç®¡é“ (Pipeline)â€”â€”æˆ‘ä»¬**åªéœ€è®©æ–°çš„æœç´¢æœåŠ¡è®¢é˜…ç°æœ‰çš„æ•°æ®æµå³å¯ã€‚**

**å®ç°æ­¥éª¤ï¼š**

**1. æ„å»ºç‹¬ç«‹å¾®æœåŠ¡** â€” æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå…¨æ–°çš„ç‹¬ç«‹å¾®æœåŠ¡ `search-service`ã€‚å®ƒçš„å”¯ä¸€èŒè´£æ˜¯ï¼š
   - ç®¡ç† Elasticsearch é›†ç¾¤ (Cluster)
   - å‘åº—é¢åº”ç”¨æš´éœ²ç»Ÿä¸€çš„æœç´¢ API (Application Programming Interface)

**2. è®¢é˜…æ•°æ®æµ** â€” æˆ‘ä»¬è®©è¿™ä¸ªæ–°æœåŠ¡æˆä¸ºç°æœ‰ Kafka ä¸»é¢˜ (Topic) `product_updates` çš„**å¦ä¸€ä¸ªæ¶ˆè´¹è€… (Consumer)**ã€‚

å°±æ˜¯è¿™ä¹ˆç®€å•ï¼**æ•´ä¸ªæ¶æ„è®¾è®¡åªéœ€å°†ä¸€ä¸ªæ–°ç”µå™¨æ’å…¥æˆ‘ä»¬å·²ç»é“ºè®¾å¥½çš„æ™ºèƒ½ç”µç½‘ã€‚** æ— éœ€æ”¹åŠ¨ç°æœ‰ç³»ç»Ÿï¼Œå®Œç¾ä½“ç°äº†äº‹ä»¶é©±åŠ¨æ¶æ„çš„è§£è€¦ä¼˜åŠ¿ã€‚

#### **æ•°æ®æµï¼šä¸€ä¸ªäº‹ä»¶ï¼Œå¤šä¸ªæ¶ˆè´¹è€…çš„èˆè¹ˆ**

é‡æ„åçš„å®Œæ•´äº§å“æ›´æ–°æ•°æ®æµï¼Œå®Œç¾è¯ é‡Šäº†**è§£è€¦çš„ã€äº‹ä»¶é©±åŠ¨æ¶æ„ (Event-Driven Architecture, EDA)** çš„å¼ºå¤§å¨åŠ›ï¼š

**æ•°æ®æµæ­¥éª¤ï¼š**

**1. è§¦å‘ç‚¹** â€” å–å®¶åœ¨åå°åˆ›å»ºæˆ–æ›´æ–°äº§å“ä¿¡æ¯ã€‚å˜æ›´é¦–å…ˆä¿å­˜åˆ°æˆ‘ä»¬ä½äºåŒ—äº¬çš„ä¸» **PostgreSQL** æ•°æ®åº“ä¸­ã€‚

**2. å˜æ›´æ•è·** â€” **Debezium**ï¼ˆæˆ‘ä»¬çš„å˜æ›´æ•°æ®æ•è·ä»£ç†ï¼ŒCDC Agentï¼‰æŒç»­ç›‘è§†æ•°æ®åº“çš„**äº‹åŠ¡æ—¥å¿— (Transaction Log / WAL)**ã€‚å®ƒç¬é—´æ£€æµ‹åˆ°æ•°æ®å˜æ›´ã€‚

**3. äº‹ä»¶å‘å¸ƒ** â€” Debezium ç«‹å³ç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„ã€ç»“æ„åŒ–çš„äº‹ä»¶æ¶ˆæ¯ï¼ŒåŒ…å«å®Œæ•´çš„äº§å“æ–°æ•°æ®ï¼Œå¹¶å‘å¸ƒåˆ° **Kafka** çš„ `product_updates` ä¸»é¢˜ã€‚

**4. å¹¶è¡Œæ¶ˆè´¹** â€” ç°åœ¨ï¼Œ**ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„å¾®æœåŠ¡**ï¼Œéƒ½è®¢é˜…äº†åŒä¸€ä¸ªä¸»é¢˜ï¼Œ**åŒæ—¶å¹¶è¡Œ**å¼€å§‹å“åº”ï¼š

   - **æ¶ˆè´¹è€… #1ï¼ˆç¼“å­˜å¤±æ•ˆå™¨ï¼‰ï¼š** ç°æœ‰çš„ç¼“å­˜ç®¡ç†æœåŠ¡æ¥æ”¶æ¶ˆæ¯ï¼Œæå– `store_id`ï¼Œå‘ **Redisï¼ˆç¼“å­˜ï¼‰** å‘é€å¤±æ•ˆå‘½ä»¤ï¼Œåˆ é™¤è¯¥åº—é“ºçš„é™ˆæ—§ç¼“å­˜æ•°æ®ã€‚
   
   - **æ¶ˆè´¹è€… #2ï¼ˆæœç´¢ç´¢å¼•å™¨ï¼‰ï¼š** æ–°åˆ›å»ºçš„æœç´¢æœåŠ¡åŒæ ·æ¥æ”¶**å®Œå…¨ç›¸åŒçš„æ¶ˆæ¯**ã€‚å®ƒè§£æå®Œæ•´çš„äº§å“æ•°æ®ï¼Œè½¬æ¢ä¸º JSON æ–‡æ¡£ï¼Œå¹¶å‘é€åˆ° **Elasticsearch** é›†ç¾¤è¿›è¡Œå®æ—¶ç´¢å¼•ã€‚

**è¿™ä¸ªç³»ç»Ÿçš„ä¼˜é›…ä¹‹å¤„åœ¨äºå®Œå…¨çš„è§£è€¦ï¼š** å¤„ç†å–å®¶åˆå§‹è¯·æ±‚çš„å•ä½“åº”ç”¨ç¨‹åº (Monolith) **å®Œå…¨ä¸çŸ¥é“** æœç´¢å¼•æ“æˆ–ç¼“å­˜ç³»ç»Ÿçš„å­˜åœ¨ã€‚å®ƒçš„å”¯ä¸€èŒè´£æ˜¯å¯é åœ°å°†æ•°æ®å†™å…¥æ•°æ®åº“â€”â€”å®Œäº‹ã€‚

æ‰€æœ‰ä¸‹æ¸¸ç³»ç»Ÿâ€”â€”ç¼“å­˜ã€æœç´¢ã€æœªæ¥å¯èƒ½çš„æ¨èå¼•æ“ã€æ•°æ®åˆ†ææœåŠ¡â€”â€”éƒ½å¯ä»¥**ç‹¬ç«‹è®¢é˜…**äº‹ä»¶æµå¹¶è‡ªä¸»åšå‡ºå“åº”ã€‚**æˆ‘ä»¬å¯ä»¥è½»æ¾æ·»åŠ ç”±è¿™äº›äº‹ä»¶é©±åŠ¨çš„æ–°åŠŸèƒ½ï¼Œå®Œå…¨æ— éœ€è§¦ç¢°æ ¸å¿ƒåº”ç”¨ä»£ç ã€‚** è¿™å°±æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„çš„çœŸæ­£åŠ›é‡ã€‚

**æœ€ç»ˆæˆæœï¼šä»å¼±ç‚¹åˆ°äº®ç‚¹çš„åä¸½è½¬èº«**

æ–°æœç´¢ç³»ç»Ÿçš„ä¸Šçº¿å¯¹ å°åº—é€š å¹³å°æ¥è¯´æ˜¯ä¸€æ¬¡**å˜é©æ€§çš„è´¨é‡é£è·ƒ**ï¼š

âœ“ **æ‹¼å†™å®¹é”™** â€” ç”¨æˆ·çš„æ‰‹è¯¯ä¸å†å¯¼è‡´é›¶ç»“æœ  
âœ“ **è¯­ä¹‰ç†è§£** â€” åŒä¹‰è¯ã€è¯æ ¹å˜åŒ–å…¨éƒ¨æ™ºèƒ½è¯†åˆ«  
âœ“ **ç›¸å…³æ€§æ’åº** â€” æœ€åŒ¹é…çš„çƒ­é”€å•†å“è‡ªåŠ¨ç½®é¡¶  
âœ“ **æ¯«ç§’çº§å“åº”** â€” æœç´¢é€Ÿåº¦ä»ç§’çº§æå‡åˆ°æ¯«ç§’çº§

æˆ‘ä»¬çš„å–å®¶**æ¬£å–œè‹¥ç‹‚**ã€‚ä»–ä»¬çš„å•†å“ç»ˆäºå¯ä»¥è¢«è½»æ¾å‘ç°ï¼Œæˆ‘ä»¬çœ‹åˆ°**æ¥è‡ªæœç´¢æ çš„é”€å”®é¢ç›´æ¥ä¸”æ˜¾è‘—çš„å¢é•¿**â€”â€”è½¬åŒ–ç‡æå‡è¶…è¿‡ 300%ã€‚æˆ‘ä»¬æˆåŠŸåœ°å°†ä¸€ä¸ªå…³é”®å¼±ç‚¹è½¬å˜ä¸º**åŒç±»æœ€ä½³çš„æ ¸å¿ƒç«äº‰åŠ›**ã€‚

#### æœç´¢æœåŠ¡æ¶æ„å›¾

```mermaid
%%{init: {'theme':'dark'}}%%
graph TB
    Seller[å–å®¶æ›´æ–°äº§å“] --> PG[(PostgreSQL<br/>ä¸»æ•°æ®åº“<br/>Master)]
    PG --> Debezium[Debezium<br/>CDCä»£ç†]
    Debezium --> Kafka[Kafka<br/>product_updatesä¸»é¢˜]
    
    Kafka --> Consumer1[æ¶ˆè´¹è€…1<br/>ç¼“å­˜å¤±æ•ˆæœåŠ¡]
    Kafka --> Consumer2[æ¶ˆè´¹è€…2<br/>æœç´¢æœåŠ¡]
    
    Consumer1 --> Redis[(Redis<br/>ç¼“å­˜)]
    Consumer2 --> ES[(Elasticsearch<br/>æœç´¢å¼•æ“)]
    
    User[ç”¨æˆ·æœç´¢] --> SearchAPI[æœç´¢API]
    SearchAPI --> ES
    ES --> SearchAPI
    SearchAPI --> User
    
    style Seller fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style PG fill:#1f2937,stroke:#10b981,color:#f3f4f6
    style Debezium fill:#374151,stroke:#f59e0b,color:#f3f4f6
    style Kafka fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:3px
    style Consumer1 fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style Consumer2 fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style Redis fill:#1f2937,stroke:#ec4899,color:#f3f4f6
    style ES fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:3px
    style User fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style SearchAPI fill:#374151,stroke:#60a5fa,color:#f3f4f6
```

## ç¬¬11ç« ï¼šå…³é”®è¦ç‚¹

- **ç®€å•çš„æ•°æ®åº“æŸ¥è¯¢æ— æ³•èƒœä»»æœç´¢é‡ä»»ã€‚** ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“çš„ SQL LIKE æŸ¥è¯¢æ— æ³•æ›¿ä»£ä¸“ä¸šæœç´¢å¼•æ“ã€‚å¯¹äºæä¾›ä¼˜è´¨ç”µå•†ä½“éªŒï¼Œä½ å¿…é¡»æŠ•èµ„ä¸“ç”¨æœç´¢å·¥å…·ã€‚

- **Elasticsearch æ˜¯ç”µå•†æœç´¢çš„ç†æƒ³é€‰æ‹©ã€‚** å®ƒæä¾›å››å¤§æ ¸å¿ƒèƒ½åŠ›ï¼šå€’æ’ç´¢å¼•ï¼ˆé€Ÿåº¦ï¼‰ã€æ–‡æœ¬åˆ†æï¼ˆæ™ºèƒ½ï¼‰ã€ç›¸å…³æ€§è¯„åˆ†ï¼ˆæ’åºï¼‰ã€æ¨¡ç³ŠåŒ¹é…ï¼ˆå®¹é”™ï¼‰â€”â€”è¿™äº›èƒ½åŠ›ç›´æ¥æ¨åŠ¨è½¬åŒ–ç‡æå‡å¹¶æ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

- **äº‹ä»¶é©±åŠ¨æ¶æ„æ˜¯æ•°æ®åŒæ­¥çš„ä¼˜é›…æ–¹æ¡ˆã€‚** ä½¿ç”¨ Kafka è¿™æ ·çš„æ¶ˆæ¯é˜Ÿåˆ—å·¥å…·å®ç°çš„**äº‹ä»¶é©±åŠ¨æ¶æ„ (Event-Driven Architecture, EDA)** æ˜¯ä¿æŒä¸åŒç³»ç»Ÿï¼ˆä¸»æ•°æ®åº“ã€ç¼“å­˜ã€æœç´¢ç´¢å¼•ï¼‰å®Œç¾åŒæ­¥çš„å¼ºå¤§ä¸”ä¼˜é›…çš„æ–¹å¼ã€‚

- **æ‰‡å‡ºæ¨¡å¼æ˜¯å¾®æœåŠ¡è§£è€¦çš„åŸºçŸ³ã€‚** "ä¸€å¯¹å¤š"æˆ–"æ‰‡å‡º (Fan-out)" æ¨¡å¼â€”â€”å•ä¸ªç”Ÿäº§è€… (Producer) çš„äº‹ä»¶è§¦å‘å¤šä¸ªç‹¬ç«‹æ¶ˆè´¹è€… (Consumer) å¹¶è¡Œå“åº”â€”â€”æ˜¯æ„å»ºå¯æ‰©å±•ã€æ¾è€¦åˆå¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒæ¨¡å¼ã€‚

- **å€’æ’ç´¢å¼•æ˜¯æœç´¢é€Ÿåº¦çš„ç§˜å¯†æ­¦å™¨ã€‚** é€šè¿‡é¢„å…ˆæ„å»º"è¯â†’æ–‡æ¡£"çš„æ˜ å°„è¡¨ï¼Œè€Œéå®æ—¶"æŸ¥æ–‡æ¡£æ‰¾è¯"ï¼ŒElasticsearch å®ç°äº†åœ¨ç™¾ä¸‡çº§æ–‡æ¡£ä¸­æ¯«ç§’çº§å®šä½çš„èƒ½åŠ›ã€‚

<br/>

