## ç¬¬13ç« ï¼šæŒ‡æŒ¥å®¶ï¼šç”¨ Kubernetes ç¼–æ’å®¹å™¨äº¤å“ä¹

Docker å½»åº•æ”¹å˜äº†æˆ‘ä»¬çš„ä¸–ç•Œã€‚é‚£ä¸ªè‡­åæ˜­è‘—çš„"åœ¨æˆ‘çš„æœºå™¨ä¸Šæ˜æ˜å¯ä»¥å·¥ä½œ"çš„é—®é¢˜çƒŸæ¶ˆäº‘æ•£ã€‚æˆ‘ä»¬çš„éƒ¨ç½² (Deployment) å˜å¾—é«˜åº¦ä¸€è‡´ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨ (Server) èµ„æºåˆ©ç”¨ç‡æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½æ›´é«˜æ•ˆã€‚**æˆ‘ä»¬æ„Ÿè§‰è‡ªå·±å‘ç°äº†ä¸€ç§è¶…èƒ½åŠ›** â€”â€”å¯ä»¥å°†åº”ç”¨ç¨‹åºçš„ä»»ä½•éƒ¨åˆ†æ‰“åŒ…æˆä¸€ä¸ªæ•´æ´ã€å¯ç§»æ¤çš„æ ‡å‡†å®¹å™¨ï¼Œå¹¶åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œå®ƒã€‚

ä½†æˆ‘ä»¬å¾ˆå¿«å‘ç°äº†è¿™ç§æ–°åŠ›é‡çš„**é˜´æš—é¢**ã€‚æˆ‘ä»¬ç”¨ä¸€æ”¯ç”±**æ•°ç™¾ä¸ª**æ•´æ´ã€æœ‰åºçš„å®¹å™¨ (Container) ç»„æˆçš„åºå¤§å†›é˜Ÿï¼Œæ›¿æ¢æ‰äº†åŸæœ¬å‡ åå°æ··ä¹±çš„è™šæ‹Ÿæœºã€‚ç„¶è€Œï¼Œ**ä¸€æ”¯å†›é˜Ÿéœ€è¦ä¸€ä½å°†å†›ï¼Œä¸€æ”¯èˆ°é˜Ÿéœ€è¦ä¸€ä½æµ·å†›ä¸Šå°†ã€‚** æˆ‘ä»¬æ–°çš„å®¹å™¨åŒ–ä¸–ç•Œæ¼”å˜æˆäº†ä¸€ç§**æ–°å½¢å¼çš„æ··ä¹±**ï¼Œè€Œæˆ‘ä»¬æ­£è¯•å›¾çº¯æ‰‹å·¥ç®¡ç†è¿™ä¸€åˆ‡â€”â€”è¿™æ ¹æœ¬ä¸å¯æŒç»­ã€‚

æœ¬ç« è®²è¿°çš„æ˜¯æˆ‘ä»¬è¿›å…¥å¤æ‚ä½†å¼ºå¤§çš„**å®¹å™¨ç¼–æ’ (Container Orchestration)** ä¸–ç•Œçš„å¾ç¨‹ï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•ä¸ºå®¹å™¨äº¤å“ä¹å›¢æ‰¾åˆ°çœŸæ­£çš„æŒ‡æŒ¥å®¶ï¼š**Kubernetesï¼ˆK8sï¼Œå®¹å™¨ç¼–æ’å¹³å°ï¼‰**ã€‚

### Part 1ï¼šæ²¡æœ‰æŒ‡æŒ¥å®¶çš„ç®¡å¼¦ä¹é˜Ÿ

åœ¨æˆ‘ä»¬é‡‡ç”¨ Docker ä¹‹åçš„å‰å‡ ä¸ªæœˆæ„Ÿè§‰åƒæ˜¯ç”Ÿäº§åŠ›çš„çˆ†å‘ã€‚ä½†éšç€æˆ‘ä»¬ä»å•ä½“æ¶æ„ (Monolith) ä¸­åˆ†ç¦»å‡ºæ›´å¤šæœåŠ¡ï¼Œæˆ‘ä»¬çš„å®¹å™¨æ•°é‡ä»åå‡ ä¸ªå¢é•¿åˆ°ä¸€ç™¾å¤šä¸ªï¼Œè¿è¥çš„ç°å®å¼€å§‹å˜æˆä¸€åœºå™©æ¢¦ã€‚æˆ‘æˆäº†å…¬å¸è–ªé…¬æœ€é«˜ã€å‹åŠ›æœ€å¤§çš„æ‰‹å·¥ç å¤´å·¥äººã€‚

å´©æºƒç‚¹å‡ºç°åœ¨å‘¨å…­å‡Œæ™¨2ç‚¹ã€‚

ä¸€ä¸ªè­¦æŠ¥æŠŠæˆ‘æƒŠé†’ï¼š"ä¸»æœºæ— æ³•è®¿é—®ï¼šapp-server-07"ã€‚æˆ‘ä»¬çš„ä¸€å° EC2 å®ä¾‹é­é‡ç¡¬ä»¶æ•…éšœå¹¶ç¦»çº¿äº†ã€‚åœ¨è¿‡å»ï¼Œè¿™æœ¬æ¥æ˜¯ä¸€ä¸ªç”¨æˆ‘ä»¬çš„è´Ÿè½½å‡è¡¡å™¨ (Load Balancer) å°±èƒ½è§£å†³çš„ç®€å•é—®é¢˜ã€‚ä½†è¿™å°æœåŠ¡å™¨ä¸€ç›´åœ¨ä¸ºå„ç§æœåŠ¡è¿è¡Œ 30 ä¸ªä¸åŒçš„å®¹å™¨â€”â€”éƒ¨åˆ† APIã€ç¼“å­˜å¤±æ•ˆå™¨ã€å›¾åƒè°ƒæ•´å¤§å°æœåŠ¡ç­‰ç­‰ã€‚

æˆ‘çš„"ä¿®å¤"æ˜¯ä¸€åœºç–¯ç‹‚çš„æ‰‹åŠ¨æŠ¢æ•‘ã€‚

- å¯åŠ¨ä¸€ä¸ªæ–°çš„ã€ç©ºçš„ EC2 å®ä¾‹ã€‚
- SSH è¿›å…¥å®ƒå¹¶å®‰è£… Dockerã€‚
- è¯•å›¾è®°ä½å“ª 30 ä¸ªå®¹å™¨åœ¨æ­»æ‰çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚
- æ‰‹åŠ¨è¾“å…¥ 30 ä¸ªä¸åŒçš„ docker run ... å‘½ä»¤ï¼Œè¯•å›¾åœ¨å‡Œæ™¨2ç‚¹ä¸åœ¨é•¿é•œåƒåç§°æˆ–ç«¯å£æ˜ å°„ä¸­æ‰“é”™å­—ã€‚

æˆ‘èŠ±äº†å°†è¿‘ä¸€ä¸ªå°æ—¶è¿›è¡Œå‹åŠ›å¤§ã€å®¹æ˜“å‡ºé”™çš„å·¥ä½œæ¥æ¢å¤æœåŠ¡ã€‚ç³»ç»Ÿå¯ä»¥å·¥ä½œï¼Œä½†è¿‡ç¨‹å¾ˆè„†å¼±ï¼Œä¾èµ–äºæˆ‘çš„è®°å¿†å’Œæ‰“å­—æŠ€èƒ½ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„è§£å†³æ–¹æ¡ˆã€‚

éƒ¨ç½²åŒæ ·ä»¤äººææƒ§ã€‚å‘å¸ƒ storefront-service çš„æ–°ç‰ˆæœ¬ç°åœ¨æ„å‘³ç€æ›´æ–°æˆ‘ä»¬æœåŠ¡å™¨ç¾¤ä¸­çš„ 50 ä¸ªè¿è¡Œå®¹å™¨ã€‚æˆ‘ä»¬å¿…é¡»è¿›è¡Œå¤æ‚çš„æ‰‹åŠ¨èˆè¹ˆï¼Œåœæ­¢æ—§å®¹å™¨ï¼Œå¯åŠ¨æ–°å®¹å™¨ï¼Œç­‰å¾…å®ƒå¥åº·ï¼Œç„¶åç§»åˆ°ä¸‹ä¸€ä¸ªï¼Œå¸Œæœ›æˆ‘ä»¬ä¸ä¼šç»™ç”¨æˆ·é€ æˆä»»ä½•åœæœºæ—¶é—´ (Downtime)ã€‚

ç‹å³° (ç‹å³°) èƒ½çœ‹å‡ºå‹åŠ›ã€‚"ä½ çœ‹èµ·æ¥å¥½åƒä¸€å‘¨æ²¡ç¡è§‰äº†ï¼Œ"ä»–åœ¨æˆ‘ä»¬çš„ä¸€æ¬¡é€šè¯ä¸­è¯´ã€‚"æˆ‘ä»¬äº¤ä»˜å¾—æ›´å¿«äº†ï¼Œä½†ä½ å·²ç»æˆä¸ºç“¶é¢ˆ (Bottleneck)ã€‚æˆ‘ä»¬ä¸èƒ½è®©æ•´ä¸ªå…¬å¸çš„ç¨³å®šæ€§ä¾èµ–äºä½ æ‰‹åŠ¨åœ¨ç»ˆç«¯ä¸­è¾“å…¥å‘½ä»¤ã€‚"

ä»–æ˜¯å¯¹çš„ã€‚æˆ‘æŠŠæ™šä¸Šçš„æ—¶é—´èŠ±åœ¨æ‰‘ç­è¿è¥ç«ç¾ä¸Šï¼Œè€Œä¸æ˜¯ç™½å¤©æ„å»ºæ›´å¥½çš„äº§å“ã€‚æˆ‘å¼€å§‹ç ”ç©¶å…¶ä»–å…¬å¸å¦‚ä½•å¤§è§„æ¨¡ç®¡ç†å®¹å™¨ã€‚ä¸€ä¸ªåå­—ä¸æ–­å‡ºç°ï¼Œä¸€ä¸ªçœ‹èµ·æ¥ä¸å¯èƒ½å¤æ‚å’Œä»¤äººç”Ÿç•çš„åå­—ï¼š**Kubernetes**ã€‚

å­¦ä¹ æ›²çº¿çœ‹èµ·æ¥åƒä¸€å µå‚ç›´çš„å¢™ã€‚æ–‡æ¡£å……æ»¡äº†å¥‡æ€ªçš„æ–°è¯ï¼šPodã€Deploymentã€Serviceã€Ingressã€ReplicaSetã€YAML æ–‡ä»¶ã€‚æ„Ÿè§‰åƒæ˜¯åœ¨å­¦ä¹ ä¸€ç§æ–°çš„ã€å¤–æ˜Ÿçš„è¯­è¨€ã€‚ä½†æ‰¿è¯ºå¤ªå¤§äº†ï¼Œæ— æ³•å¿½è§†ã€‚ä¸€ä¸ªè‡ªåŠ¨åŒ–ã€è‡ªæˆ‘ä¿®å¤çš„ç³»ç»Ÿçš„æ‰¿è¯ºã€‚

æˆ‘å‘Šè¯‰ç‹å³°ï¼Œ"æˆ‘éœ€è¦æ¶ˆå¤±ä¸€å‘¨ã€‚æˆ‘è¦æŠŠè‡ªå·±é”åœ¨æˆ¿é—´é‡Œå­¦ä¹ è¿™ä¸ª Kubernetes ä¸œè¥¿ã€‚æˆ‘è®¤ä¸ºè¿™æ˜¯æˆ‘ä»¬èƒ½åœ¨ä¸‹ä¸€é˜¶æ®µå¢é•¿ä¸­å­˜æ´»ä¸‹æ¥çš„å”¯ä¸€æ–¹å¼ã€‚"

#### **è¯†åˆ«é—®é¢˜ï¼šæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®¹å™¨ç®¡ç†å™¨**

æˆ‘ä¸ºæœŸä¸€å‘¨çš„æ·±å…¥ç ”ç©¶ Kubernetes å…”å­æ´ä¹‹æ—…è¯å®äº†æˆ‘çš„æ€€ç–‘ã€‚æˆ‘ä»¬ä¸åªæ˜¯ç¼ºå°‘ä¸€ä¸ªå·¥å…·ï¼›æˆ‘ä»¬ç¼ºå°‘æ•´æ•´ä¸€ç±»è½¯ä»¶ã€‚æˆ‘ä»¬çš„æ‰‹åŠ¨è¿‡ç¨‹åœ¨å››ä¸ªå…³é”®æ–¹é¢å¤±è´¥ï¼š

- **æ²¡æœ‰è‡ªæˆ‘ä¿®å¤ï¼š** å½“å®¹å™¨å´©æºƒæ—¶ï¼Œå®ƒä¼šä¸€ç›´æ­»æ‰ï¼Œç›´åˆ°äººç±»é‡æ–°å¯åŠ¨å®ƒã€‚å½“æœåŠ¡å™¨æ­»æ‰æ—¶ï¼Œå®ƒçš„å®¹å™¨æ°¸è¿œæ¶ˆå¤±äº†ï¼Œç›´åˆ°äººç±»åœ¨åˆ«å¤„é‡å»ºå®ƒä»¬ã€‚
- **æ²¡æœ‰æ™ºèƒ½è°ƒåº¦ï¼š** æˆ‘ä»¬æ‰‹åŠ¨å†³å®šå“ªäº›å®¹å™¨åº”è¯¥åœ¨å“ªä¸ªæœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå¯¼è‡´æ•ˆç‡ä½ä¸‹ã€‚
- **æ²¡æœ‰è‡ªåŠ¨åŒ–æ¨å‡ºï¼š** éƒ¨ç½²æ–°ä»£ç æ˜¯ä¸€ä¸ªæœ‰é£é™©çš„ã€æ‰‹åŠ¨çš„åœæ­¢å’Œå¯åŠ¨å®¹å™¨çš„è¿‡ç¨‹ã€‚
- **æ²¡æœ‰æœåŠ¡å‘ç°ï¼š** å½“ order-service å®¹å™¨å¯ä»¥åœ¨ä»»ä½•æ—¶å€™åœ¨æœåŠ¡å™¨ä¹‹é—´å¯åŠ¨ã€åœæ­¢å’Œç§»åŠ¨æ—¶ï¼Œå®ƒå¦‚ä½•å¯é åœ°æ‰¾åˆ°å¹¶ä¸ 50 ä¸ª user-service å®¹å™¨ä¸­çš„ä¸€ä¸ªé€šä¿¡ï¼Ÿ

æˆ‘ä»¬ä¸ä»…éœ€è¦_è¿è¡Œ_å®¹å™¨ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç³»ç»Ÿæ¥è‡ªåŠ¨_ç®¡ç†_å®ƒä»¬çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®¹å™¨ç¼–æ’å™¨ã€‚

<br/>

#### **æŠ€æœ¯æ·±å…¥æ¢è®¨ï¼šä»€ä¹ˆæ˜¯å®¹å™¨ç¼–æ’ï¼Ÿ**

å®¹å™¨ç¼–æ’ (Container Orchestration) çš„æœ€ä½³ç±»æ¯”æ˜¯**äº¤å“ä¹å›¢ä¸æŒ‡æŒ¥å®¶**ã€‚

```mermaid
%%{init: {'theme':'dark'}}%%
graph TB
    subgraph æ— æŒ‡æŒ¥å®¶[âŒ æ— æŒ‡æŒ¥å®¶: æ··ä¹±çš„éŸ³ä¹å®¶]
        M1[å°æç´æ‰‹<br/>storefrontå®¹å™¨]
        M2[å¤§æç´æ‰‹<br/>databaseå®¹å™¨]
        M3[æ‰“å‡»ä¹æ‰‹<br/>cacheå®¹å™¨]
        M4[é•¿ç¬›æ‰‹<br/>apiå®¹å™¨]
        
        M1 -.->|å„è‡ªä¸ºæ”¿| Chaos[å™ªéŸ³æ··ä¹±<br/>æ— æ³•åä½œ]
        M2 -.->|å„è‡ªä¸ºæ”¿| Chaos
        M3 -.->|å„è‡ªä¸ºæ”¿| Chaos
        M4 -.->|å„è‡ªä¸ºæ”¿| Chaos
    end
    
    subgraph æœ‰æŒ‡æŒ¥å®¶[âœ… æœ‰æŒ‡æŒ¥å®¶: Kubernetes ç¼–æ’]
        Conductor[æŒ‡æŒ¥å®¶<br/>Kubernetes<br/>Control Plane]
        Sheet[ä¹è°±<br/>YAMLé…ç½®<br/>æœŸæœ›çŠ¶æ€]
        
        Conductor --> V1[å°æç´1<br/>Podå‰¯æœ¬1]
        Conductor --> V2[å°æç´2<br/>Podå‰¯æœ¬2]
        Conductor --> C1[å¤§æç´1<br/>DB Pod]
        Conductor --> P1[æ‰“å‡»ä¹1<br/>Cache Pod]
        
        Sheet -.->|å£°æ˜æœŸæœ›| Conductor
        
        V1 --> Music[å’Œè°äº¤å“ä¹<br/>åè°ƒè¿è¡Œçš„åº”ç”¨]
        V2 --> Music
        C1 --> Music
        P1 --> Music
    end
    
    style æ— æŒ‡æŒ¥å®¶ fill:#1f2937,stroke:#ef4444,color:#f3f4f6,stroke-width:2px
    style M1 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style M2 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style M3 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style M4 fill:#374151,stroke:#6b7280,color:#f3f4f6
    style Chaos fill:#1f2937,stroke:#ef4444,color:#f3f4f6,stroke-width:2px
    
    style æœ‰æŒ‡æŒ¥å®¶ fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:2px
    style Conductor fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:3px
    style Sheet fill:#374151,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
    style V1 fill:#374151,stroke:#10b981,color:#f3f4f6
    style V2 fill:#374151,stroke:#10b981,color:#f3f4f6
    style C1 fill:#374151,stroke:#10b981,color:#f3f4f6
    style P1 fill:#374151,stroke:#10b981,color:#f3f4f6
    style Music fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:3px
```

**â–² å›¾ï¼šæ— æŒ‡æŒ¥å®¶çš„æ··ä¹± vs. Kubernetes çš„å’Œè°ç¼–æ’**

**ç±»æ¯”å±•å¼€ï¼š**

- **å„ä¸ªå®¹å™¨ = éŸ³ä¹å®¶** â€” æ¯ä¸ªå®¹å™¨éƒ½æ˜¯ä¸€ä½ä¸“ä¸šæ¼”å¥å®¶ã€‚`storefront-service` å®¹å™¨æ˜¯å°æç´æ‰‹ï¼Œ`database-connector` æ˜¯å¤§æç´æ‰‹ï¼Œ`image-resizer` æ˜¯æ‰“å‡»ä¹æ‰‹ã€‚
  
- **æ²¡æœ‰æŒ‡æŒ¥å®¶çš„ç¾éš¾** â€” å¦‚æœä½ åªæ˜¯æŠŠè¿™ 100 ä½æ‰åæ¨ªæº¢çš„éŸ³ä¹å®¶æ‰”è¿›ä¸€ä¸ªæˆ¿é—´ï¼Œå‘Šè¯‰ä»–ä»¬"å¼€å§‹æ¼”å¥"ï¼Œä½ ä¼šå¾—åˆ°çš„æ˜¯**å¯æ€•çš„ã€åˆºè€³çš„æ··ä¹±å™ªéŸ³**ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬æ‰‹å·¥ç®¡ç†å®¹å™¨æ—¶çš„çœŸå®å†™ç…§ã€‚

**è¦åˆ›é€ ç¾å¦™çš„éŸ³ä¹ï¼Œä½ éœ€è¦ä¸€ä½æŒ‡æŒ¥å®¶ (Conductor)ï¼š**

âœ“ **æŒæœ‰ä¹è°±ï¼ˆæœŸæœ›çŠ¶æ€ï¼‰** â€” æŒ‡æŒ¥å®¶çŸ¥é“æ¯ä¸ªä¹ç« åº”è¯¥å¦‚ä½•æ¼”å¥  
âœ“ **åè°ƒæ¼”å¥æ—¶æœº** â€” ä»–ä»¬å‘Šè¯‰å°æç´ä½•æ—¶å¼€å§‹ã€ä½•æ—¶åœæ­¢  
âœ“ **æ§åˆ¶èŠ‚å¥éŸ³é‡** â€” ç¡®ä¿æ•´ä½“å’Œè°ï¼Œä¸ä¼šæœ‰äººæŠ¢æ‹æˆ–è·‘è°ƒ  
âœ“ **åº”æ€¥å“åº”æœºåˆ¶** â€” å¦‚æœå°æç´æ‰‹çš„ç´å¼¦æ–­äº†ï¼ˆå®¹å™¨å´©æºƒï¼‰ï¼ŒæŒ‡æŒ¥å®¶ä¼šæ— ç¼åœ°ç¤ºæ„å¦ä¸€ä½å°æç´æ‰‹ç«‹å³æ¥æ›¿

**Kubernetes å°±æ˜¯æˆ‘ä»¬å®¹å™¨ç®¡å¼¦ä¹é˜Ÿçš„æŒ‡æŒ¥å®¶ã€‚**

**å…³é”®ç†è§£ï¼š** Kubernetes **ä¸ä¼šæ›¿ä»£** Dockerã€‚Docker ä»ç„¶æ˜¯æ¯ä½éŸ³ä¹å®¶æ¼”å¥çš„ä¹å™¨ï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ã€‚Kubernetes æ˜¯**ä¸»å¤§è„‘**ï¼Œå®ƒå‘Šè¯‰æœåŠ¡å™¨é›†ç¾¤ä¸­çš„æ‰€æœ‰ Docker å®ä¾‹è¯¥åšä»€ä¹ˆã€‚å®ƒç¡®ä¿æœ€ç»ˆçš„è¡¨æ¼”â€”â€”æˆ‘ä»¬è¿è¡Œçš„åº”ç”¨ç³»ç»Ÿâ€”â€”**ç²¾ç¡®åŒ¹é…ä¹è°±ï¼ˆYAML é…ç½®æ–‡ä»¶ï¼‰æ‰€æè¿°çš„æœŸæœ›çŠ¶æ€**ã€‚

---

æˆ‘ä»¬æ‰¾åˆ°äº†æ¢¦å¯ä»¥æ±‚çš„æŒ‡æŒ¥å®¶ã€‚ç°åœ¨ï¼Œæ˜¯æ—¶å€™å­¦ä¹ å¦‚ä½•é˜…è¯»å’Œç¼–å†™ä»–çš„éŸ³ä¹è¯­è¨€â€”â€”ç†è§£ **Podã€Serviceã€Deployment** ç­‰ Kubernetes æ ¸å¿ƒæ¦‚å¿µã€‚

### Part 2ï¼šå­¦ä¹ ä¹è°±

æˆ‘ä¸ºæœŸä¸€å‘¨çš„æ·±å…¥ç ”ç©¶ Kubernetes æ˜¯ä¸€æ¬¡è°¦å‘çš„ç»å†ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™æ˜¯è§£å†³æˆ‘ä»¬é—®é¢˜çš„ç­”æ¡ˆï¼Œä½†æ¦‚å¿µæ˜¯æŠ½è±¡çš„ï¼Œæœ¯è¯­æ˜¯é™Œç”Ÿçš„ã€‚è¦æŒ‡æŒ¥æˆ‘ä»¬æ–°çš„å®¹å™¨ç®¡å¼¦ä¹é˜Ÿï¼Œæˆ‘é¦–å…ˆå¿…é¡»å­¦ä¹ æŒ‡æŒ¥å®¶çš„è¯­è¨€ã€‚

æˆ‘å‘ç° Kubernetes å»ºç«‹åœ¨å‡ ä¸ªç®€å•ã€å¼ºå¤§çš„æƒ³æ³•ä¸Šã€‚ä¸€æ—¦ä½ ç†è§£äº†è¿™äº›æ ¸å¿ƒæ„å»ºå—ï¼Œæ•´ä¸ªç³»ç»Ÿå°±å¼€å§‹å˜å¾—æœ‰æ„ä¹‰ã€‚

#### **æŠ€æœ¯æ·±å…¥æ¢è®¨ï¼šæ ¸å¿ƒ Kubernetes ç»„ä»¶**

è®©æˆ‘ä»¬åˆ†è§£ Kubernetes çš„åŸºæœ¬è¯æ±‡ã€‚

**1. èŠ‚ç‚¹ (Node)ï¼šéŸ³ä¹å®¶çš„æ¤…å­**

ä¸€ä¸ª **èŠ‚ç‚¹ (Node)** æ˜¯å•ä¸ªæœåŠ¡å™¨â€”â€”ä½œä¸ºæˆ‘ä»¬èˆ°é˜Ÿä¸€éƒ¨åˆ†çš„ç‰©ç†æˆ–è™šæ‹Ÿæœºã€‚å®ƒæ˜¯ä¸€å°å·¥ä½œæœºå™¨ï¼Œå·²é…ç½®ä¸º Kubernetes "é›†ç¾¤ (Cluster)" çš„ä¸€éƒ¨åˆ†ã€‚å®ƒçš„å·¥ä½œæ˜¯å‡†å¤‡å¥½å¹¶ç­‰å¾…æ¥è‡ªæŒ‡æŒ¥å®¶çš„æŒ‡ä»¤ã€‚

- **ç±»æ¯”ï¼š** **èŠ‚ç‚¹**æ˜¯ç®¡å¼¦ä¹é˜Ÿèˆå°ä¸Šçš„æ¤…å­ã€‚å®ƒä»¬æ˜¯éŸ³ä¹å®¶å°†åä¸‹æ¥æ¼”å¥çš„ç‰©ç†ä½ç½®ã€‚æˆ‘ä»¬æ‹¿å‡ºæˆ‘ä»¬çš„ EC2 å®ä¾‹ç¾¤ï¼Œåœ¨å®ƒä»¬ä¸Šå®‰è£…å¿…è¦çš„ Kubernetes è½¯ä»¶ï¼Œå®ƒä»¬å°±æˆä¸ºäº†æˆ‘ä»¬æ–°é›†ç¾¤ä¸­çš„èŠ‚ç‚¹â€”â€”ä¸€ç»„ç©ºçš„ã€å‡†å¤‡ä½¿ç”¨çš„æ¤…å­ã€‚

**2. Podï¼šéŸ³ä¹å®¶**

è¿™æ˜¯æœ€åŸºæœ¬çš„æ¦‚å¿µã€‚åœ¨ Docker ä¸–ç•Œä¸­ï¼Œæœ€å°çš„å•å…ƒæ˜¯å®¹å™¨ã€‚åœ¨ Kubernetes ä¸–ç•Œä¸­ï¼Œæœ€å°çš„å¯éƒ¨ç½²å•å…ƒæ˜¯ **Pod**ã€‚

Pod æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„åŒ…è£…å™¨ã€‚å¯¹äº 99% çš„æƒ…å†µï¼Œæœ€ç®€å•çš„æ˜¯å°† **Pod è§†ä¸ºå•ä¸ªè¿è¡Œçš„å®¹å™¨**ã€‚

- **ç±»æ¯”ï¼š** **Pod** æ˜¯**ååœ¨æ¤…å­ä¸Šçš„å•ä¸ªéŸ³ä¹å®¶**ã€‚Pod ä¸ºå®¹å™¨æä¾›ç›´æ¥ç¯å¢ƒâ€”â€”ç½‘ç»œã€å­˜å‚¨ã€å­˜åœ¨çš„ç©ºé—´ã€‚æˆ‘ä»¬ä»ä¸å‘Šè¯‰ Kubernetes "è¿è¡Œå®¹å™¨"ã€‚æˆ‘ä»¬æ€»æ˜¯å‘Šè¯‰å®ƒ"åˆ›å»º Pod"ï¼ŒPod çš„é…ç½®æŒ‡å®šåœ¨å…¶ä¸­è¿è¡Œå“ªä¸ªå®¹å™¨é•œåƒ (Image)ã€‚è¿™ä¸ªé¢å¤–çš„æŠ½è±¡å±‚æ˜¯ Kubernetes åŠ›é‡çš„æ¥æºã€‚

**3. æœåŠ¡ (Service)ï¼šéƒ¨é—¨è·¯æ ‡**

Pod æ˜¯å‡¡äººã€‚å®ƒä»¬å¯ä»¥å´©æºƒå¹¶è¢«æ›¿æ¢ã€‚å½“ Kubernetes æ›¿æ¢å´©æºƒçš„ Pod æ—¶ï¼Œæ–°çš„ Pod å°†æœ‰ä¸€ä¸ªå…¨æ–°çš„ã€ä¸åŒçš„å†…éƒ¨ IP åœ°å€ (IP Address)ã€‚è¿™äº§ç”Ÿäº†ä¸€ä¸ªå·¨å¤§çš„é—®é¢˜ï¼šå¦‚æœæˆ‘ä»¬çš„ storefront-service Pod éœ€è¦ä¸æˆ‘ä»¬çš„ api-service Pod é€šä¿¡ï¼Œå½“å®ƒä»¬çš„åœ°å€ä¸æ–­å˜åŒ–æ—¶ï¼Œå®ƒä»¬å¦‚ä½•æ‰¾åˆ°å®ƒä»¬ï¼Ÿ

ç­”æ¡ˆæ˜¯ **æœåŠ¡ (Service)**ã€‚Service ä¸ºä¸€ç»„ Pod æä¾›å•ä¸ªã€ç¨³å®šçš„ç½‘ç»œç«¯ç‚¹ï¼ˆä¸€è‡´çš„ IP åœ°å€å’Œ DNS åç§°ï¼‰ã€‚

- **ç±»æ¯”ï¼š** ä¹å›¢æœ‰ 20 ä½å°æç´æ‰‹ï¼ˆPodï¼‰ã€‚æ‚¨ä¸å¸Œæœ›æŒ‡æŒ¥å®¶å¿…é¡»è·Ÿè¸ªæ¯ä½å°æç´æ‰‹çš„ä¸ªäººå§“åã€‚ç›¸åï¼Œåœ¨ä»–ä»¬çš„éƒ¨é—¨å‰é¢æœ‰ä¸€ä¸ªå¤§è·¯æ ‡ï¼Œä¸Šé¢å†™ç€"**å°æç´ (Violins)**"ï¼ˆæœåŠ¡ï¼‰ã€‚Service çŸ¥é“å“ªäº›å°æç´æ‰‹ç›®å‰æ˜¯å¥åº·å’Œåœ¨åœºçš„ã€‚å½“ storefront-service æƒ³è¦ä¸ API é€šä¿¡æ—¶ï¼Œå®ƒä¸ä¼šè¦æ±‚ç‰¹å®šçš„ Podï¼›å®ƒåªæ˜¯å‘ "api-service" çš„ç¨³å®šåœ°å€å‘é€è¯·æ±‚ã€‚Service å……å½“å†…éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œæ¥æ”¶è¯·æ±‚å¹¶å°†å…¶è½¬å‘åˆ°åé¢çš„ä¸€ä¸ªå¥åº·çš„ API Podã€‚å¦‚æœä¸€ä¸ª API Pod æ­»äº¡å¹¶è¢«æ›¿æ¢ï¼ŒService ä¼šè‡ªåŠ¨æ›´æ–°å…¶å¥åº·ç«¯ç‚¹åˆ—è¡¨ã€‚storefront æ°¸è¿œä¸çŸ¥é“æˆ–ä¸å…³å¿ƒã€‚

**4. éƒ¨ç½² (Deployment)ï¼šä¹è°±**

è¿™æ˜¯æ‰€æœ‰ä¸€åˆ‡æ±‡èšçš„åœ°æ–¹ã€‚**Deploymentï¼ˆéƒ¨ç½²ï¼‰** æ˜¯æˆ‘ä»¬äººç±»æè¿°æˆ‘ä»¬æœŸæœ›çŠ¶æ€çš„åœ°æ–¹ã€‚å®ƒæ˜¯å‘Šè¯‰æŒ‡æŒ¥å®¶æˆ‘ä»¬å¸Œæœ›ä¹å›¢æ¼”å¥ä»€ä¹ˆçš„è“å›¾ã€‚

- **ç±»æ¯”ï¼š** **Deployment** æ˜¯äº¤ç»™æŒ‡æŒ¥å®¶çš„**ä¹è°±**ã€‚è¿™ä¸ªä¹è°±åŒ…å«æ‰€æœ‰å…³é”®æŒ‡ä»¤ï¼š
  - **"æˆ‘éœ€è¦ 50 ä¸ª storefront-service Pod çš„å‰¯æœ¬ã€‚"**ï¼ˆè¿™ä¸ªéƒ¨é—¨åº”è¯¥æœ‰å¤šå°‘éŸ³ä¹å®¶ï¼‰ã€‚
  - **"å®ƒä»¬å¿…é¡»ä½¿ç”¨ Docker é•œåƒ dukaan/storefront:v2.1ã€‚"**ï¼ˆä»–ä»¬åº”è¯¥æ¼”å¥å“ªä¸ªç‰ˆæœ¬çš„ä¹å™¨ï¼‰ã€‚
  - **"å½“æˆ‘ç»™ä½ æ–°ç‰ˆæœ¬çš„éŸ³ä¹æ—¶ï¼Œæ‰§è¡Œæ»šåŠ¨æ›´æ–°ï¼šä¸€ä¸ªä¸€ä¸ªåœ°æ›´æ¢éŸ³ä¹å®¶ï¼Œè¿™æ ·éŸ³ä¹æ°¸è¿œä¸ä¼šåœæ­¢ã€‚"**ï¼ˆåœ¨ä¸åœæœºçš„æƒ…å†µä¸‹éƒ¨ç½²æ–°ä»£ç çš„ç­–ç•¥ï¼‰ã€‚

Kubernetes çš„çœŸæ­£é­”åŠ›åœ¨äºå®ƒå¦‚ä½•å¤„ç†è¿™ä¸ªä¹è°±ã€‚æŒ‡æŒ¥å®¶ï¼ˆKubernetes æ§åˆ¶å¹³é¢ï¼‰å¤„äºä¸€ä¸ªæ’å®šçš„å¾ªç¯ä¸­ï¼Œå°† Deploymentï¼ˆæœŸæœ›çŠ¶æ€ï¼‰ä¸èˆå°ä¸Šå®é™…å‘ç”Ÿçš„æƒ…å†µï¼ˆå½“å‰çŠ¶æ€ï¼‰è¿›è¡Œæ¯”è¾ƒã€‚

å¦‚æœä¹è°±è¯´åº”è¯¥æœ‰ 50 ä¸ª storefront Podï¼Œä½†æŒ‡æŒ¥å®¶åªæ•°åˆ° 49 ä¸ªï¼Œå› ä¸ºä¸€ä¸ªåˆšåˆšå´©æºƒäº†ï¼Œå®ƒä¸ä¼šææ…Œã€‚å®ƒåªæ˜¯è¯´ï¼Œ"å½“å‰çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€ä¸åŒ¹é…"ï¼Œå¹¶ç«‹å³åœ¨å¥åº·çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ storefront Podï¼Œå°†è®¡æ•°æ¢å¤åˆ° 50ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ¢¦å¯ä»¥æ±‚çš„è‡ªæˆ‘ä¿®å¤èƒ½åŠ›ã€‚

æˆ‘ä»¬ç†è§£äº†è¿™äº›æ¦‚å¿µã€‚æˆ‘ä»¬æœ‰è¯æ±‡æ¥æè¿°æˆ‘ä»¬çš„éœ€æ±‚ï¼šæˆ‘ä»¬æƒ³è¦ä¸€ä¸ª **Deployment** æ¥ç®¡ç†åœ¨æˆ‘ä»¬çš„ **èŠ‚ç‚¹**ä¸Šè¿è¡Œçš„ä¸€ç»„ **Pod**ï¼Œä»¥åŠä¸€ä¸ª **Service** è®©å®ƒä»¬å½¼æ­¤é€šä¿¡ã€‚

ç°åœ¨ï¼Œæ˜¯æ—¶å€™å­¦ä¹ å¦‚ä½•ç¼–å†™ä¹è°±æœ¬èº«äº†ã€‚

### Part 3ï¼šç¼–å†™ä¹è°± (YAML)

æˆ‘ä»¬å·²ç»å­¦ä¹ äº†æ¦‚å¿µã€‚æˆ‘ä»¬çŸ¥é“ Kubernetes æ˜¯æŒ‡æŒ¥å®¶ï¼Œå°†ä½¿ç”¨æˆ‘ä»¬æœŸæœ›çŠ¶æ€çš„"ä¹è°±"æ¥ç®¡ç†æˆ‘ä»¬çš„å®¹å™¨ç®¡å¼¦ä¹é˜Ÿã€‚ç°åœ¨æ˜¯æ—¶å€™å­¦ä¹ å¦‚ä½•ç¼–å†™é‚£ä¸ªéŸ³ä¹äº†ã€‚è¿™æ„å‘³ç€æ¥å—ä¸€ç§å…³äºåŸºç¡€è®¾æ–½çš„æ–°æ€ç»´æ–¹å¼ï¼Œå¹¶å­¦ä¹  Kubernetes çš„è¯­è¨€ï¼š**YAML**ã€‚

#### **æŠ€æœ¯æ·±å…¥æ¢è®¨ï¼šå£°æ˜å¼ vs å‘½ä»¤å¼**

è¿™æ˜¯è¿ç§»åˆ° Kubernetes æ—¶æœ€é‡è¦çš„å“²å­¦è½¬å˜ã€‚

- **æ—§æ–¹å¼ï¼ˆå‘½ä»¤å¼ï¼ŒImperativeï¼‰ï¼š** è¿™æ˜¯æˆ‘ä»¬ä¸€ç›´åœ¨å·¥ä½œçš„æ–¹å¼ã€‚æˆ‘ä»¬ç»™ç³»ç»Ÿä¸€ç³»åˆ—é€æ­¥çš„å‘½ä»¤ã€‚"SSH è¿›å…¥æœåŠ¡å™¨ Aã€‚è¿è¡Œè¿™ä¸ª docker run å‘½ä»¤ã€‚ç°åœ¨ SSH è¿›å…¥æœåŠ¡å™¨ Bã€‚è¿è¡Œè¿™ä¸ªå…¶ä»–çš„ docker run å‘½ä»¤ã€‚"
  - **ç±»æ¯”ï¼š** ä½ æ˜¯ä¸€ä¸ªå¾®è§‚ç®¡ç†è€…ï¼Œå‘Šè¯‰å­¦å¾’_å¦‚ä½•_å»ºé€ æ¤…å­ã€‚"é¦–å…ˆï¼Œæ‹¿å››æ¡è…¿ã€‚æ¥ä¸‹æ¥ï¼Œæ‰¾åˆ°åº§ä½ã€‚ç°åœ¨ï¼Œç”¨ä¸‰ä¸ªèºä¸å›ºå®šå·¦å‰è…¿......"è¿™å¾ˆä¹å‘³ï¼Œå®¹æ˜“å‡ºé”™ï¼Œè€Œä¸”å¦‚æœå‡ºäº†é—®é¢˜å°±ä¸èƒ½é€‚åº”ã€‚
- **Kubernetes æ–¹å¼ï¼ˆå£°æ˜å¼ï¼ŒDeclarativeï¼‰ï¼š** è¿™æ˜¯å®Œå…¨ä¸åŒçš„ã€‚ä½ ä¸å‘Šè¯‰ Kubernetes _å¦‚ä½•_åšæŸäº‹ã€‚ä½ åªæ˜¯æè¿°ä½ æƒ³è¦å®ç°çš„**æœ€ç»ˆçŠ¶æ€**ï¼Œç„¶åè®© Kubernetes æ‰¾å‡ºåˆ°è¾¾é‚£é‡Œçš„æœ€ä½³æ–¹å¼ã€‚
  - **ç±»æ¯”ï¼š** ä½ æ˜¯ä¸€ä¸ªå®¢æˆ·ï¼Œç»™ä¸“å®¶æœ¨åŒ ä¸€å¼ æ¤…å­çš„è¯¦ç»†è“å›¾ã€‚ä½ è¯´ï¼Œ"æˆ‘æƒ³è¦ä¸€æŠŠçœ‹èµ·æ¥å®Œå…¨åƒè¿™æ ·çš„æ¤…å­ã€‚å®ƒå¿…é¡»æœ‰å››æ¡è…¿ï¼Œæ¶‚æˆè“è‰²ï¼Œé«˜ 20 è‹±å¯¸ã€‚"ä½ ä¸å‘Šè¯‰ä»–ä»¬å…ˆå›ºå®šå“ªæ¡è…¿ã€‚ä¸“å®¶æœ¨åŒ ï¼ˆKubernetesï¼‰æ‹¿ç€ä½ çš„è“å›¾ï¼ˆä½ çš„é…ç½®æ–‡ä»¶ï¼‰å¹¶ä½¿å…¶æˆä¸ºç°å®ã€‚å¦‚æœä»–ä»¬å»ºé€ å®ƒå¹¶æ³¨æ„åˆ°ä¸€æ¡è…¿æ‘‡æ™ƒï¼Œä»–ä»¬ä¼šä¿®å¤å®ƒã€‚å¦‚æœä»–ä»¬æ³¨æ„åˆ°é¢œè‰²ä¸å¯¹ï¼Œä»–ä»¬ä¼šé‡æ–°ç²‰åˆ·ã€‚ä»–ä»¬çš„å…¨éƒ¨å·¥ä½œå°±æ˜¯ä¸æ–­åŠªåŠ›ä½¿ç°å®ä¸è“å›¾ç›¸åŒ¹é…ã€‚

è¿™å°±æ˜¯é­”åŠ›ã€‚ä½ å£°æ˜ä½ çš„æœŸæœ›çŠ¶æ€ï¼ŒKubernetes åœ¨åå°ä¸çŸ¥ç–²å€¦åœ°å·¥ä½œï¼Œä½œä¸ºä¸€ä¸ª"åè°ƒå¼•æ“"æ¥å¼ºåˆ¶æ‰§è¡Œå®ƒã€‚è¿™ä¸ªå£°æ˜å¼æ¨¡å‹çš„è“å›¾æ˜¯ç”¨ä¸€ç§ç§°ä¸º **YAML** çš„æ ¼å¼ç¼–å†™çš„ã€‚YAML æ˜¯ä¸€ç§äººç±»å¯è¯»çš„æ•°æ®æ ¼å¼ï¼Œä½¿ç”¨ç®€å•çš„ç¼©è¿›å’Œé”®å€¼å¯¹æ¥æè¿°é…ç½®ã€‚

#### **æŠ€æœ¯æ·±å…¥æ¢è®¨ï¼šæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª Deployment YAML**

æ˜¯æ—¶å€™ä¸ºæˆ‘ä»¬çš„ storefront-service ç¼–å†™ä¹è°±äº†ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º storefront-deployment.yaml çš„æ–‡ä»¶ã€‚ä¸€å¼€å§‹çœ‹èµ·æ¥å¾ˆå“äººï¼Œä½†å®ƒåªæ˜¯å¯¹æˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿çš„ç²¾ç¡®æè¿°ã€‚

è®©æˆ‘ä»¬é€è¡Œåˆ†è§£æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª Deployment è“å›¾ã€‚

```yaml
# 1. API ç‰ˆæœ¬å’Œ Kind å‘Šè¯‰ Kubernetes è¿™æ˜¯ä»€ä¹ˆç±»å‹çš„å¯¹è±¡ã€‚
# æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ª "Deployment"ã€‚
apiVersion: apps/v1
kind: Deployment

# 2. Metadata æ˜¯å…³äºå¯¹è±¡æœ¬èº«çš„æ•°æ®ï¼Œæ¯”å¦‚å®ƒçš„åç§°ã€‚
metadata:
  name: storefront-deployment

# 3. Specï¼ˆè§„èŒƒï¼‰æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ã€‚
# è¿™æ˜¯æˆ‘ä»¬çš„æœŸæœ›çŠ¶æ€â€”â€”æ¤…å­çš„è“å›¾ã€‚
spec:
  # 4. æˆ‘ä»¬æƒ³è¦è¿è¡Œ 50 ä¸ªç›¸åŒçš„åº”ç”¨ç¨‹åºå‰¯æœ¬ã€‚
  replicas: 50

  # 5. è¿™å‘Šè¯‰ Deployment å¦‚ä½•æ‰¾åˆ°å®ƒåº”è¯¥ç®¡ç†çš„ Podã€‚
  # å®ƒå¯»æ‰¾ä»»ä½•å…·æœ‰æ ‡ç­¾ "app: storefront" çš„ Podã€‚
  selector:
    matchLabels:
      app: storefront

  # 6. è¿™æ˜¯ Pod æœ¬èº«çš„æ¨¡æ¿æˆ–è“å›¾ã€‚
  # Deployment å°†åŸºäºæ­¤æ¨¡æ¿åˆ›å»º 50 ä¸ª Podã€‚
  template:
    metadata:
      # 7. æˆ‘ä»¬ç»™ Pod ä¸€ä¸ªæ ‡ç­¾ï¼Œä»¥ä¾¿ Deployment å¯ä»¥æ‰¾åˆ°å®ƒä»¬ã€‚
      labels:
        app: storefront

    spec:
      # 8. æœ¬èŠ‚å®šä¹‰è¦åœ¨ Pod å†…è¿è¡Œçš„å®¹å™¨ã€‚
      containers:
        - name: storefront-container
          # 9. è¿™æ˜¯æœ€å…³é”®çš„ä¸€è¡Œï¼šè¦è¿è¡Œçš„ç‰¹å®š Docker é•œåƒã€‚
          image: dukaan/storefront:v2.1

          # 10. å‘Šè¯‰ Kubernetes æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåœ¨å®¹å™¨å†…ç›‘å¬å“ªä¸ªç«¯å£ã€‚
          ports:
            - containerPort: 8000
```

#### **kubectl apply çš„é­”åŠ›**

è¿™ä¸ª YAML æ–‡ä»¶åªæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ã€‚å®ƒæœ¬èº«ä»€ä¹ˆä¹Ÿä¸åšã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•å°†è¿™ä¸ªä¹è°±äº¤ç»™æˆ‘ä»¬çš„æŒ‡æŒ¥å®¶ã€‚æ‰§è¡Œæ­¤æ“ä½œçš„å‘½ä»¤æ˜¯ kubectlï¼ˆå‘éŸ³ä¸º"koob-control"ï¼‰ï¼Œè¿™æ˜¯ä¸ Kubernetes é›†ç¾¤äº¤äº’çš„ä¸»è¦å·¥å…·ã€‚

æˆ‘ä»¬è¿è¡Œäº†ä¸€ä¸ªå‘½ä»¤ï¼š

> kubectl apply -f storefront-deployment.yaml

ç„¶åï¼Œé­”æ³•å¼€å§‹äº†ã€‚

Kubernetes è¯»å–äº†æˆ‘ä»¬çš„æ–‡ä»¶ã€‚å®ƒçœ‹åˆ°æœŸæœ›çŠ¶æ€æ˜¯"è¿è¡Œ dukaan/storefront:v2.1 é•œåƒçš„ 50 ä¸ª Pod"ã€‚å®ƒæŸ¥çœ‹äº†é›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œçœ‹åˆ°"0 ä¸ªåŒ¹é…çš„ Pod"ã€‚åè°ƒå¾ªç¯å¯åŠ¨äº†ã€‚Kubernetes çš„è°ƒåº¦å™¨ (Scheduler) æ™ºèƒ½åœ°åœ¨æˆ‘ä»¬çš„å„ä¸ªèŠ‚ç‚¹ä¸Šæ‰¾åˆ°ç©ºé—´ï¼Œå¹¶åœ¨æ¥ä¸‹æ¥çš„å‡ ç§’é’Ÿå†…å¯åŠ¨äº†æˆ‘ä»¬ storefront Pod çš„ 50 ä¸ªå‰¯æœ¬ã€‚

å½“æˆ‘ä»¬éœ€è¦éƒ¨ç½²æ›´æ–°æ—¶ï¼ŒçœŸæ­£çš„åŠ›é‡å˜å¾—æ¸…æ™°äº†ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„ä»£ç ï¼Œv2.2ã€‚æˆ‘ä»¬åªæ˜¯ç¼–è¾‘äº† YAML æ–‡ä»¶å¹¶æ›´æ”¹äº†ä¸€è¡Œï¼šimage: dukaan/storefront:v2.2ã€‚

ç„¶åï¼Œæˆ‘ä»¬è¿è¡Œäº†**å®Œå…¨ç›¸åŒçš„å‘½ä»¤**ï¼škubectl apply -f storefront-deployment.yamlã€‚

æˆ‘ä»¬ä¸å¿…å‘Šè¯‰ Kubernetes å¦‚ä½•æ‰§è¡Œæ›´æ–°ã€‚å®ƒæŸ¥çœ‹äº†æ–°è“å›¾ï¼Œå°†å…¶ä¸è¿è¡Œç³»ç»Ÿè¿›è¡Œæ¯”è¾ƒï¼Œå¹¶ç†è§£äº†å·®å¼‚ã€‚å®ƒè‡ªåŠ¨å¯åŠ¨äº†"æ»šåŠ¨æ›´æ–°"ï¼Œæ€æ­»ä¸€ä¸ªæ—§çš„ v2.1 Pod å¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„ v2.2 Podï¼Œç­‰å¾…å®ƒå¥åº·åå†ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªã€‚å®ƒåœ¨æ‰€æœ‰ 50 ä¸ªå‰¯æœ¬ä¸Šæ‰§è¡Œæ­¤æ“ä½œï¼Œæ²¡æœ‰ä»»ä½•åœæœºæ—¶é—´ã€‚è¿™æ˜¯æˆ‘ä»¬ä¸€ç›´æ¢¦æƒ³çš„å®‰å…¨ã€è‡ªåŠ¨åŒ–å’Œæ— èŠçš„éƒ¨ç½²è¿‡ç¨‹ã€‚

æˆ‘ä»¬å·²ç»æŠŠä¹è°±äº¤ç»™äº†æŒ‡æŒ¥å®¶ï¼Œç®¡å¼¦ä¹é˜Ÿå¼€å§‹æ¼”å¥ã€‚ä½†åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä»–ä»¬åœ¨ä¸€ä¸ªéš”éŸ³çš„æˆ¿é—´é‡Œæ¼”å¥ã€‚æˆ‘ä»¬ä»ç„¶éœ€è¦ä¸€ç§æ–¹æ³•æ¥æ‰“å¼€é—¨ï¼Œè®©è§‚ä¼—â€”â€”æˆ‘ä»¬çš„ç”¨æˆ·â€”â€”å¬åˆ°éŸ³ä¹ã€‚

### Part 4ï¼šæ‰“å¼€éŸ³ä¹å…çš„å¤§é—¨

æˆ‘ä»¬å·²ç»æˆåŠŸåœ°æŠŠä¹è°±äº¤ç»™äº†æŒ‡æŒ¥å®¶ã€‚æˆ‘ä»¬çš„ Kubernetes é›†ç¾¤ (Cluster) æ˜¯æ´»çš„ï¼Œæˆ‘ä»¬çš„ storefront-deployment æ­£åœ¨å°½èŒåœ°ç»´æŠ¤æ­£å¥½ 50 ä¸ªè¿è¡Œçš„ Podï¼Œæ ¹æ®éœ€è¦ä¿®å¤å’Œæ›¿æ¢å®ƒä»¬ã€‚ç®¡å¼¦ä¹é˜Ÿæ¼”å¥å¾—å¾ˆå®Œç¾ã€‚

åªæœ‰ä¸€ä¸ªé—®é¢˜ï¼šä»–ä»¬åœ¨ä¸€ä¸ªå®Œå…¨éš”éŸ³çš„æˆ¿é—´é‡Œæ¼”å¥ã€‚

æˆ‘ä»¬çš„ Pod åœ¨é›†ç¾¤å†…çš„ç§æœ‰å†…éƒ¨ç½‘ç»œä¸Šè¿è¡Œã€‚å¤–éƒ¨äº’è”ç½‘ä¸Šçš„ä»»ä½•äººéƒ½æ— æ³•è®¿é—®å®ƒä»¬ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªæ²¡æœ‰è§‚ä¼—çš„ç®¡å¼¦ä¹é˜Ÿã€‚æœ€åä¸€æ­¥æ˜¯åˆ›å»ºä¸€ç§å®‰å…¨å¯é çš„æ–¹å¼æ¥æ‰“å¼€é—¨ï¼Œè®©æˆ‘ä»¬çš„ç”¨æˆ·è¿›æ¥å¬éŸ³ä¹ã€‚è¿™æ˜¯ Kubernetes **æœåŠ¡ (Service)** çš„å·¥ä½œã€‚

æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡ Service å¦‚ä½•ä¸º Pod æä¾›ç¨³å®šçš„å†…éƒ¨åœ°å€ä»¥ä¾¿å½¼æ­¤_é€šä¿¡_ã€‚ä½† Service ä¹Ÿå¯ä»¥é…ç½®ä¸ºå‘å¤–éƒ¨ä¸–ç•Œå…¬å¼€è¿™äº› Podã€‚è¿™å°±æ˜¯ä½ å¿…é¡»é€‰æ‹©**æœåŠ¡ç±»å‹ (Service Type)** çš„åœ°æ–¹ã€‚

#### **æŠ€æœ¯æ·±å…¥æ¢è®¨ï¼šKubernetes æœåŠ¡ç±»å‹è§£é‡Š**

Kubernetes æä¾›äº†å‡ ç§æ‰“å¼€é—¨çš„æ–¹å¼ï¼Œæ¯ç§éƒ½æ˜¯ä¸ºä¸åŒçš„ç”¨ä¾‹è®¾è®¡çš„ã€‚é€‰æ‹©æ­£ç¡®çš„æ–¹å¼å¯¹äºæ„å»ºå®‰å…¨ä¸”å…·æœ‰æˆæœ¬æ•ˆç›Šçš„ç³»ç»Ÿè‡³å…³é‡è¦ã€‚

**1. ClusterIPï¼šç§äººå¯¹è®²æœº**

è¿™æ˜¯é»˜è®¤çš„ Service ç±»å‹ã€‚å®ƒæä¾›ä¸€ä¸ª**ä»…ä»é›†ç¾¤å†…éƒ¨å¯è®¿é—®**çš„ç¨³å®š IP åœ°å€ã€‚

- **ç±»æ¯”ï¼š** è¿™æ˜¯éŸ³ä¹å…å†…çš„ç§äºº**å¯¹è®²ç³»ç»Ÿ**ã€‚æŒ‡æŒ¥å®¶å¯ä»¥ç”¨å®ƒä¸"å°æç´"éƒ¨é—¨é€šè¯ï¼Œ"å°æç´"å¯ä»¥ç”¨å®ƒä¸"æ‰“å‡»ä¹"éƒ¨é—¨é€šè¯ã€‚ä½†ç«™åœ¨éŸ³ä¹å…å¤–é¢è¡—é“ä¸Šçš„äººæ— æ³•è®¿é—®è¿™ä¸ªå¯¹è®²ç³»ç»Ÿã€‚
- **ç”¨ä¾‹ï¼š** è¿™æ˜¯æ‰€æœ‰å†…éƒ¨æœåŠ¡åˆ°æœåŠ¡é€šä¿¡çš„ä¸»åŠ›ã€‚å½“æˆ‘ä»¬çš„ order-service éœ€è¦ä»æˆ‘ä»¬çš„ user-service è·å–æ•°æ®æ—¶ï¼Œå®ƒå°†ä¸ user-service çš„ ClusterIP é€šä¿¡ã€‚è¿™æ˜¯æœ€å¸¸è§å’Œæœ€å®‰å…¨çš„æœåŠ¡ç±»å‹ã€‚

**2. NodePortï¼šæ¶ˆé˜²é€šé“**

NodePort æœåŠ¡å°†å†…éƒ¨ ClusterIP æš´éœ²åœ¨é›†ç¾¤ä¸­**æ¯ä¸ªèŠ‚ç‚¹**çš„ç‰¹å®šé«˜ç¼–å·ç«¯å£ä¸Šã€‚

- **ç±»æ¯”ï¼š** è¿™å°±åƒåœ¨æ¯ä¸ªéŸ³ä¹å®¶çš„æ¤…å­ï¼ˆèŠ‚ç‚¹ï¼‰æ—è¾¹æ‰“å¼€ä¸€ä¸ª**æ¶ˆé˜²é€šé“é—¨**ã€‚å¦‚æœä½ çŸ¥é“å»ºç­‘ç‰©çš„ä¸»åœ°å€å’Œç‰¹å®šçš„æ¶ˆé˜²é€šé“é—¨å·ï¼ˆä¾‹å¦‚ï¼ŒNode_IP:30080ï¼‰ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®è¯¥æœåŠ¡ã€‚è¿™æœ‰ç‚¹ç¬¨æ‹™ï¼Œä½ å¿…é¡»çŸ¥é“å»å“ªæ ‹æ¥¼ï¼Œä½†è¿™æ˜¯ä¸€ç§å¿«é€Ÿè¿›å…¥çš„æ–¹å¼ã€‚
- **ç”¨ä¾‹ï¼š** è¿™ä¸»è¦ç”¨äº**è°ƒè¯• (Debugging) æˆ–ä¸´æ—¶è®¿é—®**ã€‚å¼€å‘äººå‘˜å¯èƒ½ä½¿ç”¨ NodePort å¿«é€Ÿæµ‹è¯•æ–°æœåŠ¡ï¼Œè€Œæ— éœ€è®¾ç½®é€‚å½“çš„è´Ÿè½½å‡è¡¡å™¨çš„éº»çƒ¦ã€‚å®ƒé€šå¸¸ä¸ç”¨äºçœŸæ­£çš„ç”Ÿäº§æµé‡ï¼Œå› ä¸ºå®ƒä¸å®‰å…¨ï¼Œå¹¶ä¸”éœ€è¦å®¢æˆ·ç«¯çŸ¥é“ç‰¹å®šèŠ‚ç‚¹çš„ IPã€‚

**3. LoadBalancerï¼šä¸»å…¥å£**

è¿™æ˜¯åœ¨ é˜¿é‡Œäº‘ æˆ– è…¾è®¯äº‘ ç­‰äº‘æä¾›å•†ä¸Šå°†æœåŠ¡å…¬å¼€åˆ°äº’è”ç½‘çš„æ ‡å‡†ã€æœ€å¸¸è§çš„æ–¹å¼ã€‚å½“æ‚¨åˆ›å»º LoadBalancer ç±»å‹çš„ Service æ—¶ï¼Œæ‚¨ä¼šè·å¾— NodePort æä¾›çš„æ‰€æœ‰å†…å®¹ï¼Œä½† Kubernetes è¿˜ä¼šè‡ªåŠ¨ä¸ºæ‚¨é…ç½®ä¸€ä¸ªçœŸå®çš„å¤–éƒ¨äº‘è´Ÿè½½å‡è¡¡å™¨ã€‚

- **ç±»æ¯”ï¼š** è¿™æ˜¯éŸ³ä¹å…çš„å®ä¼Ÿ**ä¸»å…¥å£å’Œå”®ç¥¨æŸœå°**ã€‚äº‘æä¾›å•†æ„å»ºäº†ä¸€ä¸ªé€‚å½“çš„ã€é¢å‘å…¬ä¼—çš„å…¥å£ï¼ˆå…·æœ‰å…¬å…± IP åœ°å€çš„è´Ÿè½½å‡è¡¡å™¨ï¼‰ã€‚è¿™ä¸ªå…¥å£æ¥æ”¶æ‰€æœ‰è¿›æ¥çš„è§‚ä¼—ï¼ˆäº’è”ç½‘æµé‡ï¼‰ï¼Œå¹¶è‡ªåŠ¨å°†ä»–ä»¬å¼•å¯¼åˆ°ä¸€ä¸ªå¯ç”¨çš„æ¶ˆé˜²é€šé“é—¨ï¼ˆNodePortï¼‰ï¼Œç„¶åå¼•å¯¼ä»–ä»¬åˆ°æ­£ç¡®çš„éŸ³ä¹å®¶ï¼ˆPodï¼‰ã€‚
- **ç”¨ä¾‹ï¼š** è¿™æ˜¯å‘äº’è”ç½‘å…¬å¼€å•ä¸ªæœåŠ¡çš„å®Œç¾æ–¹å¼ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªä¸»è¦çš„ APIï¼Œä½ ä¸ºå®ƒåˆ›å»ºä¸€ä¸ª LoadBalancer ç±»å‹çš„ Serviceï¼Œä½ çš„äº‘æä¾›å•†ä¼šç»™ä½ ä¸€ä¸ªå•ä¸€çš„ã€ç¨³å®šçš„ IP åœ°å€ï¼Œä½ å¯ä»¥å°†ä½ çš„åŸŸåæŒ‡å‘å®ƒã€‚

**4. Ingressï¼šæ™ºèƒ½ç¤¼å®¾å‘˜**

LoadBalancer æœåŠ¡å¾ˆæ£’ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼šæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ—¶ï¼Œä½ éƒ½ä¼šé…ç½®ä¸€ä¸ªæ–°çš„äº‘è´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™å¯èƒ½ä¼šå˜å¾—æ˜‚è´µã€‚å¦‚æœä½ æœ‰ 10 ä¸ªä¸åŒçš„æœåŠ¡æƒ³è¦å…¬å¼€æ€ä¹ˆåŠï¼Ÿä½ ä¸æƒ³ä¸º 10 ä¸ªå•ç‹¬çš„è´Ÿè½½å‡è¡¡å™¨ä»˜è´¹ã€‚

è¿™å°±æ˜¯ **Ingress** çš„ç”¨æ­¦ä¹‹åœ°ã€‚Ingress æœ¬èº«ä¸æ˜¯ä¸€ç§ Service ç±»å‹ï¼Œè€Œæ˜¯ä½äºå¤šä¸ªæœåŠ¡å‰é¢çš„æ›´æ™ºèƒ½ã€æ›´å¼ºå¤§çš„å±‚ã€‚

- **ç±»æ¯”ï¼š** **Ingress** å°±åƒä¸€ä¸ªåºå¤§å»ºç­‘ç‰©å‰å°çš„æ™ºèƒ½**ç¤¼å®¾å‘˜**ï¼Œè¯¥å»ºç­‘ç‰©å®¹çº³å¤šä¸ªéŸ³ä¹å…ã€‚è§‚ä¼—æ¥åˆ°ä¸€ä¸ªå•ä¸€çš„ä¸»å…¥å£ï¼ˆä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼‰ã€‚ä»–ä»¬å‘ç¤¼å®¾å‘˜å‡ºç¤ºä»–ä»¬çš„ç¥¨ã€‚ç¤¼å®¾å‘˜çœ‹ç€ç¥¨è¯´ï¼Œ"å•Šï¼Œä½ æ˜¯æ¥å¬æ‘‡æ»šéŸ³ä¹ä¼šçš„ï¼ˆ/rockï¼‰ï¼Œè¯·å» A å…ã€‚ä½ æ˜¯æ¥å¬å¤å…¸æ¼”å‡ºçš„ï¼ˆ/classicalï¼‰ï¼Œè¯·å» B å…ã€‚"
- **ç”¨ä¾‹ï¼š** è¿™æ˜¯ç®¡ç†å¾®æœåŠ¡æ¶æ„ (Microservices Architecture) å¤–éƒ¨è®¿é—®çš„æœ€å…·æˆæœ¬æ•ˆç›Šå’Œæœ€å¼ºå¤§çš„æ–¹å¼ã€‚ä½ ä½¿ç”¨ä¸€ä¸ª LoadBalancer æœåŠ¡å°†æµé‡å¼•å…¥ä½ çš„ Ingress æ§åˆ¶å™¨ã€‚ç„¶å Ingress ä½¿ç”¨ä¸€ç»„è§„åˆ™æ ¹æ® URL è·¯å¾„ï¼ˆ/apiã€/storefrontï¼‰æˆ–ä¸»æœºåï¼ˆapi.xiaodiantong.comã€store.xiaodiantong.comï¼‰å°†æµé‡è·¯ç”±åˆ°ä¸åŒçš„å†…éƒ¨ ClusterIP æœåŠ¡ã€‚

#### **æˆ‘ä»¬çš„å®ç°**

å¯¹äºæˆ‘ä»¬çš„ storefront-serviceï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Ingressã€‚è¿™æ˜¯å®Œç¾çš„é€‰æ‹©ã€‚æˆ‘ä»¬ä¸ºæ•´ä¸ªé›†ç¾¤æä¾›äº†ä¸€ä¸ªä¸»è´Ÿè½½å‡è¡¡å™¨ï¼Œæˆ‘ä»¬çš„ Ingress æ§åˆ¶å™¨å……å½“æ™ºèƒ½ç¤¼å®¾å‘˜ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€æ¡è§„åˆ™ï¼Œè¯´"ä»»ä½•åˆ° xiaodiantong.com/store/\* çš„æµé‡éƒ½åº”è¯¥è·¯ç”±åˆ° storefront-service çš„å†…éƒ¨ ClusterIPã€‚"

æˆ‘ä»¬ä¸º Ingress è§„åˆ™åˆå†™äº†ä¸€ä¸ª YAML æ–‡ä»¶ï¼Œè¿è¡Œ kubectl applyï¼Œå°±è¿™æ ·ï¼ŒéŸ³ä¹å…çš„å¤§é—¨æ‰“å¼€äº†ã€‚å…¬å…±äº’è”ç½‘ç°åœ¨å¯ä»¥è®¿é—®æˆ‘ä»¬çš„ storefront-serviceï¼Œå®ƒåœ¨æˆ‘ä»¬æ–°çš„ Kubernetes é›†ç¾¤å†…ä½œä¸º 50 ä¸ªè‡ªæˆ‘ä¿®å¤ã€è‡ªåŠ¨ç®¡ç†çš„ Pod è¿è¡Œã€‚

æˆ‘ä»¬åšåˆ°äº†ã€‚æˆ‘ä»¬é©¯æœäº†æ•°ç™¾ä¸ªå®¹å™¨çš„æ··ä¹±ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªç®¡å¼¦ä¹é˜Ÿçš„æŒ‡æŒ¥å®¶ã€‚

---

<div style="border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin: 30px 0; background: linear-gradient(to right, #1e40af08, #2563eb08);">

### ğŸ“Œ ç¼–è€…æ³¨:Kubernetesç”Ÿäº§çº§å®æˆ˜é€ŸæŸ¥

*20åˆ†é’ŸæŒæ¡kubectlå‘½ä»¤ã€YAMLé…ç½®å’Œæ•…éšœæ’æŸ¥*

---

#### **ä¸€ã€æœ¬åœ°K8sç¯å¢ƒå¿«é€Ÿæ­å»º**

```bash
# æ–¹æ¡ˆ1: k3d (æ¨è,æœ€è½»é‡)
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
k3d cluster create xiaodiantong-dev --agents 2 --port 8080:80@loadbalancer

# æ–¹æ¡ˆ2: Minikube (åŠŸèƒ½å®Œæ•´)
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
minikube start --cpus=4 --memory=8192 --driver=docker

# å®‰è£…kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# éªŒè¯å®‰è£…
kubectl cluster-info
kubectl get nodes
```

---

#### **äºŒã€storefront-serviceå®Œæ•´éƒ¨ç½²é…ç½®**

```yaml
# storefront-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storefront-service
  namespace: production
  labels:
    app: storefront
    version: v2.1
spec:
  replicas: 5  # å‰¯æœ¬æ•°é‡
  strategy:
    type: RollingUpdate  # æ»šåŠ¨æ›´æ–°ç­–ç•¥
    rollingUpdate:
      maxSurge: 2        # æ›´æ–°æ—¶æœ€å¤šå¤š2ä¸ªPod
      maxUnavailable: 1  # æ›´æ–°æ—¶æœ€å¤š1ä¸ªPodä¸å¯ç”¨
  selector:
    matchLabels:
      app: storefront
  template:
    metadata:
      labels:
        app: storefront
        version: v2.1
    spec:
      # åäº²å’Œæ€§(Podåˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹)
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - storefront
              topologyKey: kubernetes.io/hostname
      
      containers:
      - name: storefront
        image: dukaan/storefront:v2.1
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8000
          name: http
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: url
        - name: REDIS_URL
          value: redis://redis-master:6379/0
        - name: DJANGO_SETTINGS_MODULE
          value: dukaan.settings_prod
        
        # èµ„æºé™åˆ¶(å…³é”®!)
        resources:
          requests:
            cpu: 500m      # æœ€å°‘éœ€è¦0.5æ ¸
            memory: 512Mi  # æœ€å°‘éœ€è¦512MB
          limits:
            cpu: 1000m     # æœ€å¤šä½¿ç”¨1æ ¸
            memory: 1Gi    # æœ€å¤šä½¿ç”¨1GB
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:   # å­˜æ´»æ¢é’ˆ(å¤±è´¥åˆ™é‡å¯Pod)
          httpGet:
            path: /health/
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        
        readinessProbe:  # å°±ç»ªæ¢é’ˆ(å¤±è´¥åˆ™ä»Serviceç§»é™¤)
          httpGet:
            path: /health/ready/
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 2
        
        # æŒ‚è½½é…ç½®æ–‡ä»¶
        volumeMounts:
        - name: config
          mountPath: /app/config
          readOnly: true
      
      volumes:
      - name: config
        configMap:
          name: storefront-config

---
# storefront-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: storefront-service
  namespace: production
spec:
  type: ClusterIP
  selector:
    app: storefront
  ports:
  - port: 80
    targetPort: 8000
    protocol: TCP
    name: http
  sessionAffinity: ClientIP  # ä¼šè¯ä¿æŒ(å¯é€‰)

---
# storefront-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: storefront-ingress
  namespace: production
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "100"  # é™æµ
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - xiaodiantong.com
    secretName: xiaodiantong-tls
  rules:
  - host: xiaodiantong.com
    http:
      paths:
      - path: /store(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: storefront-service
            port:
              number: 80

---
# storefront-hpa.yaml (æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: storefront-hpa
  namespace: production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: storefront-service
  minReplicas: 5
  maxReplicas: 50
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # CPUè¶…è¿‡70%åˆ™æ‰©å®¹
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:  # æ‰©ç¼©å®¹ç­–ç•¥
    scaleDown:
      stabilizationWindowSeconds: 300  # ç¼©å®¹å‰ç¨³å®š5åˆ†é’Ÿ
      policies:
      - type: Percent
        value: 50  # æ¯æ¬¡æœ€å¤šç¼©å®¹50%
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0  # ç«‹å³æ‰©å®¹
      policies:
      - type: Percent
        value: 100  # æ¯æ¬¡æœ€å¤šæ‰©å®¹100%
        periodSeconds: 15

# éƒ¨ç½²å‘½ä»¤
# kubectl apply -f storefront-deployment.yaml
# kubectl apply -f storefront-service.yaml
# kubectl apply -f storefront-ingress.yaml
# kubectl apply -f storefront-hpa.yaml
```

---

#### **ä¸‰ã€kubectlæ ¸å¿ƒå‘½ä»¤é€ŸæŸ¥**

```bash
# === æŸ¥çœ‹èµ„æº ===
kubectl get pods -n production               # æŸ¥çœ‹Podåˆ—è¡¨
kubectl get pods -o wide                     # æ˜¾ç¤ºæ›´å¤šä¿¡æ¯(èŠ‚ç‚¹/IP)
kubectl get pods -w                          # å®æ—¶ç›‘æ§
kubectl get pods --selector app=storefront   # æŒ‰æ ‡ç­¾ç­›é€‰
kubectl describe pod storefront-abc123       # è¯¦ç»†ä¿¡æ¯
kubectl logs storefront-abc123 -f            # æŸ¥çœ‹æ—¥å¿—(å®æ—¶)
kubectl logs storefront-abc123 --previous    # æŸ¥çœ‹å‰ä¸€ä¸ªå®¹å™¨æ—¥å¿—(å´©æºƒæ—¶)
kubectl top pods                             # æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ

# === è°ƒè¯•æ“ä½œ ===
kubectl exec -it storefront-abc123 -- bash   # è¿›å…¥å®¹å™¨
kubectl port-forward pod/storefront-abc123 8000:8000  # ç«¯å£è½¬å‘
kubectl cp storefront-abc123:/app/logs/error.log ./local.log  # å¤åˆ¶æ–‡ä»¶

# === éƒ¨ç½²ç®¡ç† ===
kubectl apply -f deployment.yaml             # åˆ›å»º/æ›´æ–°èµ„æº
kubectl rollout status deployment/storefront # æŸ¥çœ‹æ»šåŠ¨æ›´æ–°çŠ¶æ€
kubectl rollout history deployment/storefront # æŸ¥çœ‹å†å²ç‰ˆæœ¬
kubectl rollout undo deployment/storefront   # å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/storefront --to-revision=3  # å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl scale deployment storefront --replicas=10  # æ‰‹åŠ¨æ‰©å®¹

# === æ•…éšœæ’æŸ¥ ===
kubectl get events --sort-by='.lastTimestamp'  # æŸ¥çœ‹é›†ç¾¤äº‹ä»¶
kubectl get pod storefront-abc123 -o yaml      # æŸ¥çœ‹Podå®Œæ•´é…ç½®
kubectl delete pod storefront-abc123           # åˆ é™¤Pod(ä¼šè‡ªåŠ¨é‡å»º)
kubectl drain node-1 --ignore-daemonsets --delete-emptydir-data  # é©±é€èŠ‚ç‚¹(ç»´æŠ¤æ—¶)

# === ConfigMap & Secret ===
kubectl create configmap storefront-config --from-file=config.yaml
kubectl create secret generic db-credentials \
  --from-literal=url=postgresql://user:pass@db:5432/dukaan
kubectl get secret db-credentials -o jsonpath='{.data.url}' | base64 -d  # æŸ¥çœ‹Secretå†…å®¹

# === å¿«æ·åˆ«å(æ·»åŠ åˆ°~/.bashrc) ===
alias k='kubectl'
alias kgp='kubectl get pods'
alias kgs='kubectl get svc'
alias kgd='kubectl get deployments'
alias kdp='kubectl describe pod'
alias kl='kubectl logs -f'
alias kex='kubectl exec -it'
```

---

#### **å››ã€å¸¸è§æ•…éšœæ’æŸ¥æµç¨‹**

| é—®é¢˜ç—‡çŠ¶ | æ’æŸ¥å‘½ä»¤ | å¯èƒ½åŸå›  |
|---------|---------|---------|
| **Podä¸€ç›´Pending** | `kubectl describe pod` | èµ„æºä¸è¶³,è°ƒåº¦å¤±è´¥,PVCæœªç»‘å®š |
| **Podå´©æºƒé‡å¯(CrashLoopBackOff)** | `kubectl logs --previous` | åº”ç”¨å¯åŠ¨å¤±è´¥,å¥åº·æ£€æŸ¥å¤±è´¥ |
| **PodçŠ¶æ€ImagePullBackOff** | `kubectl describe pod` | é•œåƒä¸å­˜åœ¨,ç§æœ‰ä»“åº“è®¤è¯å¤±è´¥ |
| **æœåŠ¡æ— æ³•è®¿é—®** | `kubectl get endpoints` | Selectorä¸åŒ¹é…,Podæœªå°±ç»ª |
| **HPAä¸ç”Ÿæ•ˆ** | `kubectl get hpa`,`kubectl top pods` | Metrics Serveræœªå®‰è£…,èµ„æºæœªè¾¾é˜ˆå€¼ |

```bash
# å®Œæ•´æ’æŸ¥æµç¨‹ç¤ºä¾‹
# 1. æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n production | grep storefront

# 2. æŸ¥çœ‹è¯¦ç»†äº‹ä»¶
kubectl describe pod storefront-abc123 -n production | tail -20

# 3. æŸ¥çœ‹æ—¥å¿—
kubectl logs storefront-abc123 -n production --tail=100

# 4. æ£€æŸ¥å¥åº·æ£€æŸ¥ç«¯ç‚¹
kubectl exec storefront-abc123 -n production -- curl -s http://localhost:8000/health/

# 5. æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl top pod storefront-abc123 -n production

# 6. æŸ¥çœ‹Service endpoints
kubectl get endpoints storefront-service -n production

# 7. æµ‹è¯•Serviceè¿é€šæ€§
kubectl run test-pod --rm -it --image=curlimages/curl -- \
  curl http://storefront-service.production.svc.cluster.local/health/
```

---

#### **äº”ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µChecklist**

**èµ„æºç®¡ç†:**
- [ ] æ‰€æœ‰Podè®¾ç½®`requests`å’Œ`limits`(é˜²æ­¢èµ„æºäº‰æŠ¢)
- [ ] ä½¿ç”¨HPAè‡ªåŠ¨æ‰©ç¼©å®¹
- [ ] è®¾ç½®PodDisruptionBudget(ä¿è¯æœ€å°å¯ç”¨å‰¯æœ¬æ•°)
- [ ] é…ç½®ResourceQuotaé™åˆ¶å‘½åç©ºé—´èµ„æº

**é«˜å¯ç”¨:**
- [ ] ç”Ÿäº§ç¯å¢ƒè‡³å°‘3ä¸ªå‰¯æœ¬
- [ ] é…ç½®Podåäº²å’Œæ€§(åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹)
- [ ] è®¾ç½®åˆç†çš„å¥åº·æ£€æŸ¥(liveness/readiness)
- [ ] ä½¿ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥(`RollingUpdate`)

**å®‰å…¨:**
- [ ] ä½¿ç”¨Secretå­˜å‚¨æ•æ„Ÿä¿¡æ¯(ä¸ç”¨ConfigMap)
- [ ] å¯ç”¨RBACæƒé™æ§åˆ¶
- [ ] é•œåƒä½¿ç”¨æ˜ç¡®ç‰ˆæœ¬æ ‡ç­¾(ä¸ç”¨`:latest`)
- [ ] å®šæœŸæ‰«æé•œåƒæ¼æ´

**ç›‘æ§å‘Šè­¦:**
- [ ] éƒ¨ç½²Prometheus+Grafana
- [ ] é…ç½®å…³é”®æŒ‡æ ‡å‘Šè­¦(CPU/å†…å­˜/é‡å¯æ¬¡æ•°)
- [ ] é›†æˆæ—¥å¿—èšåˆ(ELK/Loki)
- [ ] è®¾ç½®PagerDuty/Slackå‘Šè­¦é€šçŸ¥

```yaml
# PodDisruptionBudgetç¤ºä¾‹
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: storefront-pdb
spec:
  minAvailable: 3  # è‡³å°‘ä¿è¯3ä¸ªPodå¯ç”¨
  selector:
    matchLabels:
      app: storefront
```

---

#### **å…­ã€ç›‘æ§é›†æˆ(Prometheus)**

```yaml
# servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: storefront-monitor
  namespace: production
spec:
  selector:
    matchLabels:
      app: storefront
  endpoints:
  - port: http
    path: /metrics
    interval: 15s

# å…³é”®æŒ‡æ ‡
- kube_pod_status_phase{phase="Running"}  # PodçŠ¶æ€
- kube_pod_container_resource_requests   # èµ„æºè¯·æ±‚
- kube_pod_container_resource_limits     # èµ„æºé™åˆ¶
- container_cpu_usage_seconds_total      # CPUä½¿ç”¨
- container_memory_working_set_bytes     # å†…å­˜ä½¿ç”¨
- kube_deployment_status_replicas        # å‰¯æœ¬æ•°
```

---

**ğŸ“Š å°åº—é€š K8sæ”¶ç›Š:**
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è‡ªåŠ¨æ‰©å®¹        æ‰‹åŠ¨ â†’ è‡ªåŠ¨HPA  (å“åº”æ—¶é—´<30s)
èµ„æºåˆ©ç”¨ç‡      35% â†’ 78%  (+123%)
éƒ¨ç½²é€Ÿåº¦        15min â†’ 2min  (-87%)
æœåŠ¡å¯ç”¨æ€§      99.5% â†’ 99.95%  (+0.45%)
è¿ç»´äººåŠ›æˆæœ¬    -60%  (è‡ªåŠ¨åŒ–è¿ç»´)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

</div>

---

#### Kubernetes æ¶æ„å›¾

```mermaid
%%{init: {'theme':'dark'}}%%
graph TB
    subgraph Kubernetesé›†ç¾¤[Kubernetes é›†ç¾¤]
        subgraph æ§åˆ¶å¹³é¢[æ§åˆ¶å¹³é¢]
            API[API Server]
            Scheduler[è°ƒåº¦å™¨<br/>Scheduler]
            Controller[æ§åˆ¶å™¨<br/>Controller Manager]
        end
        
        subgraph Node1[èŠ‚ç‚¹ 1]
            Pod1[Pod<br/>storefront-v2.1]
            Pod2[Pod<br/>storefront-v2.1]
        end
        
        subgraph Node2[èŠ‚ç‚¹ 2]
            Pod3[Pod<br/>storefront-v2.1]
            Pod4[Pod<br/>storefront-v2.1]
        end
        
        subgraph Node3[èŠ‚ç‚¹ 3]
            Pod5[Pod<br/>storefront-v2.1]
            Pod6[Pod<br/>storefront-v2.1]
        end
        
        Service[Service<br/>ClusterIP<br/>ç¨³å®šå†…éƒ¨åœ°å€]
        Ingress[Ingress<br/>æ™ºèƒ½è·¯ç”±]
    end
    
    Dev[å¼€å‘è€…] -->|kubectl apply<br/>YAML| API
    API --> Scheduler
    Scheduler --> Node1
    Scheduler --> Node2
    Scheduler --> Node3
    
    Controller -->|ç›‘æ§çŠ¶æ€<br/>è‡ªåŠ¨ä¿®å¤| Node1
    Controller -->|ç›‘æ§çŠ¶æ€<br/>è‡ªåŠ¨ä¿®å¤| Node2
    Controller -->|ç›‘æ§çŠ¶æ€<br/>è‡ªåŠ¨ä¿®å¤| Node3
    
    Pod1 --> Service
    Pod2 --> Service
    Pod3 --> Service
    Pod4 --> Service
    Pod5 --> Service
    Pod6 --> Service
    
    Service --> Ingress
    
    LB[è´Ÿè½½å‡è¡¡å™¨<br/>Load Balancer] --> Ingress
    User[ç”¨æˆ·è¯·æ±‚] --> LB
    
    style Dev fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style API fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:3px
    style Scheduler fill:#374151,stroke:#f59e0b,color:#f3f4f6
    style Controller fill:#374151,stroke:#f59e0b,color:#f3f4f6
    style Pod1 fill:#1f2937,stroke:#60a5fa,color:#f3f4f6
    style Pod2 fill:#1f2937,stroke:#60a5fa,color:#f3f4f6
    style Pod3 fill:#1f2937,stroke:#60a5fa,color:#f3f4f6
    style Pod4 fill:#1f2937,stroke:#60a5fa,color:#f3f4f6
    style Pod5 fill:#1f2937,stroke:#60a5fa,color:#f3f4f6
    style Pod6 fill:#1f2937,stroke:#60a5fa,color:#f3f4f6
    style Service fill:#1f2937,stroke:#ec4899,color:#f3f4f6,stroke-width:3px
    style Ingress fill:#1f2937,stroke:#10b981,color:#f3f4f6,stroke-width:3px
    style LB fill:#374151,stroke:#60a5fa,color:#f3f4f6
    style User fill:#374151,stroke:#60a5fa,color:#f3f4f6
```

## ç¬¬13ç« ï¼šå…³é”®è¦ç‚¹

- **Kubernetes æ˜¯å®¹å™¨äº¤å“ä¹å›¢çš„æŒ‡æŒ¥å®¶ã€‚** å®ƒç”¨è‡ªåŠ¨åŒ–çš„ã€å£°æ˜å¼çš„æ™ºèƒ½ç¼–æ’ï¼Œæ›¿ä»£äº†æ‰‹åŠ¨çš„ã€å®¹æ˜“å‡ºé”™çš„è¿ç»´è‹¦åŠ›æ´»ï¼Œå°†è¿ç»´å·¥ç¨‹å¸ˆä»çç¢é‡å¤ä¸­è§£æ”¾å‡ºæ¥ã€‚

- **æ‹¥æŠ±å£°æ˜å¼é…ç½®æ€ç»´æ¨¡å¼ã€‚** ä¸è¦å‘Šè¯‰ Kubernetes **å¦‚ä½• (How)** åšæŸäº‹ï¼ˆå‘½ä»¤å¼ï¼‰ï¼Œè€Œæ˜¯ç”¨ YAML æ–‡ä»¶æè¿°ä½ æƒ³è¦çš„**æœ€ç»ˆçŠ¶æ€ (What)**ï¼ˆå£°æ˜å¼ï¼‰ï¼ŒKubernetes çš„åè°ƒå¼•æ“ä¼šä¸çŸ¥ç–²å€¦åœ°å·¥ä½œï¼Œç¡®ä¿ç°å®å§‹ç»ˆåŒ¹é…æœŸæœ›ã€‚

- **ç†è§£å››å¤§æ ¸å¿ƒç»„ä»¶ï¼š**  
  â€¢ **Nodeï¼ˆèŠ‚ç‚¹ï¼‰** â€” å·¥ä½œæœºå™¨/æœåŠ¡å™¨  
  â€¢ **Pod** â€” æœ€å°éƒ¨ç½²å•å…ƒï¼Œé€šå¸¸åŒ…å«ä¸€ä¸ªå®¹å™¨  
  â€¢ **Deployment** â€” ç®¡ç† Pod å‰¯æœ¬çš„è“å›¾å’Œæ§åˆ¶å™¨  
  â€¢ **Service** â€” ä¸º Pod æä¾›ç¨³å®šç½‘ç»œç«¯ç‚¹çš„æŠ½è±¡å±‚

- **è‡ªæˆ‘ä¿®å¤æ˜¯å†…ç½®è¶…èƒ½åŠ›ã€‚** å¦‚æœ Pod å´©æºƒæˆ–èŠ‚ç‚¹å®•æœºï¼ŒDeployment æ§åˆ¶å™¨ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ›¿æ¢æ•…éšœå®ä¾‹ï¼Œæ— éœ€äººå·¥å¹²é¢„ï¼Œå§‹ç»ˆç»´æŒå£°æ˜çš„å‰¯æœ¬æ•°é‡ã€‚

- **é€‰æ‹©åˆé€‚çš„æœåŠ¡æš´éœ²æ–¹å¼ï¼š**  
  â€¢ **ClusterIP** â€” ä»…é›†ç¾¤å†…éƒ¨é€šä¿¡ï¼ˆé»˜è®¤ï¼‰  
  â€¢ **NodePort** â€” å¼€å‘è°ƒè¯•ä¸´æ—¶è®¿é—®  
  â€¢ **LoadBalancer** â€” å•ä¸ªæœåŠ¡çš„äº‘è´Ÿè½½å‡è¡¡å™¨  
  â€¢ **Ingress** â€” å¤šæœåŠ¡çš„æ™ºèƒ½è·¯ç”±ç½‘å…³ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰

- **å£°æ˜å¼ vs. å‘½ä»¤å¼æ˜¯å“²å­¦è½¬å˜ã€‚** ä»"SSH ç™»å½•æ‰§è¡Œè„šæœ¬"ï¼ˆå‘½ä»¤å¼ï¼‰è½¬å‘"å®šä¹‰æœŸæœ›çŠ¶æ€ YAML"ï¼ˆå£°æ˜å¼ï¼‰ï¼Œè¿™æ˜¯åŸºç¡€è®¾æ–½ç®¡ç†çš„èŒƒå¼é©å‘½â€”â€”Infrastructure as Code çš„ç»ˆæå½¢æ€ã€‚

### Part 4ï¼šè¿½æ±‚æé€Ÿï¼ˆæ„å»ºä¸–ç•Œçº§è¾¹ç¼˜ç½‘ç»œï¼‰

æˆ‘ä»¬ä»å¤´å¼€å§‹é‡å»ºäº†å…¬å¸çš„å¼•æ“ã€‚æˆ‘ä»¬ä»ä¸€ä¸ªå•ä¸€çš„ã€æº…å°„çš„æœåŠ¡å™¨å˜æˆäº†ä¸€ä¸ªç”± Kubernetes ç®¡ç†çš„å¼¹æ€§çš„ã€è‡ªæˆ‘ä¿®å¤çš„ã€å¯æ‰©å±•çš„å®¹å™¨ç®¡å¼¦ä¹é˜Ÿã€‚æˆ‘ä»¬è§£å†³äº†ç¨³å®šæ€§ã€ä¸€è‡´æ€§å’Œå·¥ä½œæµçš„é—®é¢˜ã€‚æˆ‘ä»¬å»ºé€ äº†ä¸€åº§å ¡å’ï¼Œæˆ‘ä»¬ç›¸ä¿¡å®ƒå¯ä»¥ç»å—ä»»ä½•é£æš´ã€‚

æœ¬ä¹¦çš„è¿™ä¸€éƒ¨åˆ†æ˜¯å…³äºæ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆã€‚è¿™æ˜¯å…³äºä¸€åœºæ„å¤–çš„é£“é£è¢­å‡»æˆ‘ä»¬å ¡å’çš„æ—¶åˆ»ï¼Œä»¥åŠå®ƒä¿æŒå±¹ç«‹ä¸å€’çš„æƒŠäººåŸå› ã€‚è¿™æ˜¯å…³äºæˆ‘ä»¬å¦‚ä½•å‘ç°åœ¨æ½®æ±ä¸­ç”Ÿå­˜çš„ç§˜å¯†ä¸æ˜¯æ›´å¤§çš„å¢™ï¼Œè€Œæ˜¯æ›´å¥½çš„æµ·å²¸çº¿çš„æ•…äº‹ã€‚

<br/>

