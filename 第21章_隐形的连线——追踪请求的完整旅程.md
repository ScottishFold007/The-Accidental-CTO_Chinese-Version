## ç¬¬21ç« :éšå½¢çš„è¿çº¿â€”â€”è¿½è¸ªè¯·æ±‚çš„å®Œæ•´æ—…ç¨‹

### Part 1:çœ‹å¾—è§çš„å¤±è´¥vs.çœ‹ä¸è§çš„ç¼“æ…¢

æœ‰äº†ç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿå,æˆ‘ä»¬çš„æ•…éšœå®šä½é€Ÿåº¦å¤§å¤§æå‡ã€‚ä½†å¾ˆå¿«,æˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªæ—¥å¿—æ— æ³•è§£å†³çš„æ–°é—®é¢˜ã€‚

é‚£æ˜¯ä¸€ä¸ªå‘¨äº”ä¸‹åˆ,å®¢æˆ·æˆåŠŸå›¢é˜Ÿçš„å°å¼ åˆæ‰¾åˆ°äº†æˆ‘ã€‚

"é™ˆæµ©,æœ‰ä¸ªVIPå•†æˆ·æŠ•è¯‰è¯´ä»–ä»¬çš„åº—é“ºé¡µé¢åŠ è½½å¾ˆæ…¢ã€‚æœ‰æ—¶å€™éœ€è¦20ç§’æ‰èƒ½æ˜¾ç¤ºå•†å“åˆ—è¡¨ã€‚"

æˆ‘ç«‹å³æ‰“å¼€Grafana,æŸ¥è¯¢StorefrontæœåŠ¡çš„æ—¥å¿—:

```promql
{app="storefront", user_id="87654"}
```

æ—¥å¿—æ˜¾ç¤ºè¯·æ±‚å¤„ç†æ—¶é—´:**127æ¯«ç§’**ã€‚

"å°å¼ ,æ ¹æ®æ—¥å¿—,StorefrontæœåŠ¡å¤„ç†å¾—å¾ˆå¿«,åªç”¨äº†127æ¯«ç§’ã€‚å¯èƒ½æ˜¯ç”¨æˆ·çš„ç½‘ç»œé—®é¢˜?"

"ä¸,é™ˆæµ©ã€‚ä»–ä»¬å½•å±äº†,ç¡®å®å¾ˆæ…¢ã€‚è€Œä¸”ä¸æ˜¯ä¸ªä¾‹,å·²ç»æœ‰5ä¸ªå•†æˆ·æŠ¥å‘Šäº†ç±»ä¼¼é—®é¢˜ã€‚"

æˆ‘çš±èµ·çœ‰å¤´ã€‚è¿™æ˜¯æœ€ä»¤äººæ²®ä¸§çš„é—®é¢˜ç±»å‹:**é—´æ­‡æ€§çš„ã€éš¾ä»¥å¤ç°çš„æ€§èƒ½é—®é¢˜**ã€‚

æˆ‘å¼€å§‹äº†æ¼«é•¿çš„è°ƒæŸ¥:

**æ­¥éª¤1:æ£€æŸ¥StorefrontæœåŠ¡æ—¥å¿—**
```
è¯·æ±‚å¤„ç†æ—¶é—´:127ms âœ… æ­£å¸¸
```

**æ­¥éª¤2:æ£€æŸ¥PaymentæœåŠ¡æ—¥å¿—**
```
æ”¯ä»˜éªŒè¯æ—¶é—´:89ms âœ… æ­£å¸¸
```

**æ­¥éª¤3:æ£€æŸ¥InventoryæœåŠ¡æ—¥å¿—**
```
åº“å­˜æŸ¥è¯¢æ—¶é—´:45ms âœ… æ­£å¸¸
```

æ¯ä¸ªæœåŠ¡çœ‹èµ·æ¥éƒ½å¾ˆå¿«,ä½†ç”¨æˆ·ä½“éªŒçš„æ€»æ—¶é—´æ˜¯20ç§’!å°±åƒä¸€ä¸ªä¾¦æ¢æ¡ˆä»¶:æ¯ä¸ªå«Œç–‘äººéƒ½æœ‰ä¸åœ¨åœºè¯æ˜,ä½†è°‹æ€ç¡®å®å‘ç”Ÿäº†ã€‚

ä¸¤ä¸ªå°æ—¶å,æˆ‘ç»ˆäºåœ¨InventoryæœåŠ¡çš„æ—¥å¿—ä¸­å‘ç°äº†ä¸€æ¡ä¸èµ·çœ¼çš„çº¿ç´¢:

```
2023-12-15T15:34:52.103Z [DEBUG] app=inventory
  msg="ç­‰å¾…æ•°æ®åº“è¿æ¥" duration=18234ms
```

**æ‰¾åˆ°äº†!** InventoryæœåŠ¡æœ¬èº«å¤„ç†å¾ˆå¿«(45ms),ä½†åœ¨è·å–æ•°æ®åº“è¿æ¥æ—¶ç­‰å¾…äº†18ç§’!ç”±äºè¿™æ˜¯è¿æ¥æ± å±‚é¢çš„ç­‰å¾…,è€Œä¸æ˜¯ä¸šåŠ¡é€»è¾‘å¤„ç†,å®ƒæ²¡æœ‰è¢«è®°å½•ä¸º"å¤„ç†æ—¶é—´"ã€‚

ä½†æˆ‘èŠ±äº†ä¸¤ä¸ªå°æ—¶æ‰æ‰¾åˆ°è¿™æ¡æ—¥å¿—ã€‚æ›´ç³Ÿç³•çš„æ˜¯,æˆ‘ä¸çŸ¥é“è¿™ä¸ªé—®é¢˜å½±å“äº†å¤šå°‘ç”¨æˆ·,å‘ç”Ÿé¢‘ç‡æœ‰å¤šé«˜,æ˜¯å¦è¿˜æœ‰å…¶ä»–ç±»ä¼¼çš„éšè—ç“¶é¢ˆã€‚

**æ—¥å¿—ç³»ç»Ÿçš„å±€é™æ€§æš´éœ²äº†:**

æ—¥å¿—å‘Šè¯‰ä½ "å‘ç”Ÿäº†ä»€ä¹ˆ",ä½†å®ƒä¸å‘Šè¯‰ä½ :
- âŒ ä¸€ä¸ªè¯·æ±‚ç»è¿‡äº†å“ªäº›æœåŠ¡
- âŒ æ¯ä¸ªæœåŠ¡èŠ±äº†å¤šå°‘æ—¶é—´
- âŒ ç“¶é¢ˆåœ¨å“ªé‡Œ
- âŒ å“ªäº›è¯·æ±‚æ…¢,å“ªäº›å¿«

è¿™å°±åƒä½ æœ‰ä¸€ä»½çŠ¯ç½ªç°åœºçš„æ–‡å­—æŠ¥å‘Š,ä½†æ²¡æœ‰ç›‘æ§å½•åƒã€‚ä½ èƒ½è¯»æ‡‚ç»†èŠ‚,ä½†çœ‹ä¸åˆ°å…¨å±€ã€‚

æˆ‘ä»¬éœ€è¦çš„æ˜¯:**åˆ†å¸ƒå¼è¿½è¸ª**ã€‚

### Part 2:è¿½è¸ªçš„è§£å‰–â€”â€”ä»è¯·æ±‚åˆ°Span

å‘¨ä¸€æ—©ä¸Š,æˆ‘å¬é›†äº†æ ¸å¿ƒæŠ€æœ¯å›¢é˜Ÿã€‚ç™½æ¿ä¸Š,æˆ‘ç”»å‡ºäº†ä¸€ä¸ªå…¸å‹çš„å°åº—é€šç”¨æˆ·è¯·æ±‚çš„æµç¨‹:

```mermaid
%%{init: {'theme':'dark'}}%%
graph LR
    User[ç”¨æˆ·æµè§ˆå™¨] --> LB[è´Ÿè½½å‡è¡¡å™¨<br/>Nginx]
    LB --> SF[StorefrontæœåŠ¡<br/>Django]
    SF --> Cache{Redisç¼“å­˜<br/>å‘½ä¸­?}
    Cache -->|æœªå‘½ä¸­| Inv[InventoryæœåŠ¡<br/>åº“å­˜æŸ¥è¯¢]
    Cache -->|å‘½ä¸­| Return1[è¿”å›ç¼“å­˜ç»“æœ]
    Inv --> DB[(PostgreSQL<br/>ä¸»åº“)]
    DB --> Return2[è¿”å›æŸ¥è¯¢ç»“æœ]
    Return2 --> SF
    Return1 --> SF
    SF --> User
    
    style User fill:#1f2937,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
    style SF fill:#374151,stroke:#10b981,color:#f3f4f6,stroke-width:2px
    style Inv fill:#374151,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style DB fill:#1f2937,stroke:#ef4444,color:#f3f4f6,stroke-width:3px
```

"çœ‹è¿™ä¸ªæµç¨‹,"æˆ‘æŒ‡ç€å›¾è¯´ã€‚"ä¸€ä¸ªç®€å•çš„å•†å“åˆ—è¡¨è¯·æ±‚å¯èƒ½ç»è¿‡5-6ä¸ªç»„ä»¶ã€‚å½“æ€»ä½“å“åº”æ—¶é—´æ˜¯20ç§’æ—¶,æˆ‘ä»¬å¦‚ä½•çŸ¥é“æ˜¯å“ªä¸ªç¯èŠ‚æ…¢äº†?"

"æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç³»ç»Ÿ,èƒ½å¤Ÿ:**è¿½è¸ªå•ä¸ªè¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**,è®°å½•å®ƒåœ¨æ¯ä¸ªç»„ä»¶ä¸­èŠ±è´¹çš„æ—¶é—´ã€‚"

æˆ‘ä»¬çš„DevOpsè´Ÿè´£äººæèŠ³ç‚¹ç‚¹å¤´ã€‚"è¿™å°±æ˜¯åˆ†å¸ƒå¼è¿½è¸ªã€‚ä¸šç•Œæ ‡å‡†æ˜¯**OpenTelemetry**,å¯ä»¥å¯¼å‡ºåˆ°Jaegeræˆ–Zipkinç­‰å·¥å…·ã€‚"

#### **æ ¸å¿ƒæ¦‚å¿µ:Traceã€Spanå’ŒContext Propagation**

æèŠ³åœ¨ç™½æ¿ä¸Šè§£é‡Šäº†åˆ†å¸ƒå¼è¿½è¸ªçš„æ ¸å¿ƒæ¦‚å¿µ:

**æ¦‚å¿µ1:Trace(è¿½è¸ª)**

ä¸€ä¸ª**Trace**ä»£è¡¨ä¸€æ¬¡å®Œæ•´çš„ç”¨æˆ·è¯·æ±‚,ä»å¼€å§‹åˆ°ç»“æŸçš„æ•´ä¸ªæ—…ç¨‹ã€‚æ¯ä¸ªTraceæœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„**Trace ID**ã€‚

```
Trace ID: 4bf92f3577b34da6a3ce929d0e0e4736
è¯·æ±‚: GET /store/myshop/products
æ€»è€—æ—¶: 20.3ç§’
çŠ¶æ€: æˆåŠŸ
```

**æ¦‚å¿µ2:Span(è·¨åº¦)**

ä¸€ä¸ªTraceç”±å¤šä¸ª**Span**ç»„æˆã€‚æ¯ä¸ªSpanä»£è¡¨è¯·æ±‚ä¸­çš„ä¸€ä¸ªæ“ä½œ,æ¯”å¦‚:
- ä¸€æ¬¡HTTPè°ƒç”¨
- ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢
- ä¸€æ¬¡Redisæ“ä½œ
- ä¸€ä¸ªä¸šåŠ¡å‡½æ•°çš„æ‰§è¡Œ

æ¯ä¸ªSpanè®°å½•:
- **Span ID**(åœ¨Traceå†…å”¯ä¸€)
- **Parent Span ID**(çˆ¶æ“ä½œçš„ID,å½¢æˆè°ƒç”¨æ ‘)
- **Operation Name**(æ“ä½œåç§°)
- **Start Time & Duration**(å¼€å§‹æ—¶é—´å’ŒæŒç»­æ—¶é—´)
- **Tags**(æ ‡ç­¾,å¦‚http.method=GETã€db.statement=SELECT...)
- **Logs**(äº‹ä»¶æ—¥å¿—)

**æ¦‚å¿µ3:Context Propagation(ä¸Šä¸‹æ–‡ä¼ æ’­)**

è¿™æ˜¯åˆ†å¸ƒå¼è¿½è¸ªçš„é­”æ³•æ ¸å¿ƒã€‚å½“StorefrontæœåŠ¡è°ƒç”¨InventoryæœåŠ¡æ—¶,å®ƒå¿…é¡»ä¼ é€’**Trace ID**å’Œ**Span ID**,è¿™æ ·InventoryæœåŠ¡çŸ¥é“è‡ªå·±æ˜¯åŒä¸€ä¸ªè¿½è¸ªçš„ä¸€éƒ¨åˆ†ã€‚

è¿™æ˜¯é€šè¿‡HTTP Headerå®ç°çš„:

```http
GET /api/inventory/check HTTP/1.1
Host: inventory-service
traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01
```

è¿™ä¸ª`traceparent` headeråŒ…å«äº†:
- Trace ID:4bf92f3577b34da6a3ce929d0e0e4736
- Parent Span ID:00f067aa0ba902b7
- Trace Flags:01(é‡‡æ ·)

#### **è¿½è¸ªçš„å¯è§†åŒ–:ç€‘å¸ƒå›¾**

"è¿½è¸ªæ•°æ®æœ€å¼ºå¤§çš„åœ°æ–¹,"æèŠ³ç»§ç»­è¯´,"æ˜¯å®ƒçš„å¯è§†åŒ–ã€‚Jaegerä¼šå°†Traceæ˜¾ç¤ºä¸º**ç€‘å¸ƒå›¾**,è®©ä½ ä¸€çœ¼çœ‹å‡ºç“¶é¢ˆã€‚"

å¥¹ç”»å‡ºäº†ä¸€ä¸ªç¤ºä¾‹:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Trace: GET /store/myshop/products (æ€»è€—æ—¶: 20.3ç§’)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
0s    5s    10s   15s   20s   25s
â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚

â–ˆ Storefront: HTTP Handler                   [127ms]
â”‚
â”œâ”€â–ˆ Redis: GET products:myshop               [12ms]
â”‚ â””â”€ MISS(ç¼“å­˜æœªå‘½ä¸­)
â”‚
â”œâ”€â–ˆ Inventory: Check Stock                   [18.5s] âš ï¸
â”‚ â”‚
â”‚ â”œâ”€â–ˆ Database: Get Connection               [18.2s] âš ï¸âš ï¸âš ï¸
â”‚ â”‚   â””â”€ è¿æ¥æ± è€—å°½!ç­‰å¾…å¯ç”¨è¿æ¥
â”‚ â”‚
â”‚ â””â”€â–ˆ Database: SELECT query                 [45ms]
â”‚
â””â”€â–ˆ Storefront: Render Response              [23ms]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç“¶é¢ˆ:æ•°æ®åº“è¿æ¥æ± è€—å°½,ç­‰å¾…18.2ç§’!
```

"è¿™!"æˆ‘æ¿€åŠ¨åœ°æŒ‡ç€å›¾,"è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ã€‚ä¸æ˜¯æ–‡å­—æ—¥å¿—,è€Œæ˜¯å¯è§†åŒ–çš„æ—¶é—´çº¿,æ¸…æ™°åœ°æ˜¾ç¤ºæ¯ä¸ªæ“ä½œçš„è€—æ—¶ã€‚"

å›¢é˜Ÿè¢«è¯´æœäº†ã€‚æˆ‘ä»¬å†³å®šå¼•å…¥OpenTelemetryå’ŒJaegerã€‚

### Part 3:éƒ¨ç½²Jaegerâ€”â€”è¿½è¸ªç³»ç»Ÿçš„å¿ƒè„

Jaegeræ˜¯Uberå¼€å‘å¹¶å¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ,ç°åœ¨æ˜¯CNCFçš„æ¯•ä¸šé¡¹ç›®ã€‚å®ƒç”±å‡ ä¸ªç»„ä»¶ç»„æˆ:

```mermaid
%%{init: {'theme':'dark'}}%%
graph TB
    subgraph Application[åº”ç”¨ç¨‹åº]
        App1[StorefrontæœåŠ¡<br/>OpenTelemetry SDK]
        App2[PaymentæœåŠ¡<br/>OpenTelemetry SDK]
        App3[InventoryæœåŠ¡<br/>OpenTelemetry SDK]
    end
    
    Agent[Jaeger Agent<br/>æœ¬åœ°æ”¶é›†ä»£ç†<br/>UDP:6831]
    
    Collector[Jaeger Collector<br/>æ¥æ”¶å’Œå¤„ç†Span<br/>HTTP:14268]
    
    Storage[(å­˜å‚¨åç«¯<br/>Cassandra/Elasticsearch<br/>æˆ–BadgeråµŒå…¥å¼)]
    
    Query[Jaeger Query<br/>æŸ¥è¯¢æœåŠ¡<br/>HTTP:16686]
    
    UI[Jaeger UI<br/>Webç•Œé¢]
    
    App1 -.->|å‘é€Span<br/>UDP| Agent
    App2 -.->|å‘é€Span<br/>UDP| Agent
    App3 -.->|å‘é€Span<br/>UDP| Agent
    
    Agent -->|æ‰¹é‡è½¬å‘| Collector
    Collector -->|å­˜å‚¨| Storage
    Query -->|æŸ¥è¯¢| Storage
    UI -->|è®¿é—®| Query
    
    style Agent fill:#374151,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style Collector fill:#374151,stroke:#10b981,color:#f3f4f6,stroke-width:2px
    style Storage fill:#1f2937,stroke:#8b5cf6,color:#f3f4f6,stroke-width:3px
    style UI fill:#1f2937,stroke:#60a5fa,color:#f3f4f6,stroke-width:3px
```

å¯¹äºæˆ‘ä»¬çš„MVP,æˆ‘ä»¬é€‰æ‹©äº†**Jaeger All-in-One**éƒ¨ç½²,å°†æ‰€æœ‰ç»„ä»¶æ‰“åŒ…åœ¨ä¸€ä¸ªå®¹å™¨ä¸­,ä½¿ç”¨å†…ç½®çš„Badgerå­˜å‚¨(ä¸€ä¸ªåµŒå…¥å¼æ•°æ®åº“)ã€‚

**Jaeger All-in-Oneéƒ¨ç½²:**

```yaml
# jaeger-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: monitoring
  labels:
    app: jaeger
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:1.51
        env:
        # å¯ç”¨OpenTelemetryåè®®æ”¯æŒ
        - name: COLLECTOR_OTLP_ENABLED
          value: "true"
        
        # å­˜å‚¨é…ç½®(ä½¿ç”¨BadgeråµŒå…¥å¼DB)
        - name: SPAN_STORAGE_TYPE
          value: badger
        - name: BADGER_EPHEMERAL
          value: "false"
        - name: BADGER_DIRECTORY_VALUE
          value: /badger/data
        - name: BADGER_DIRECTORY_KEY
          value: /badger/key
        
        # é‡‡æ ·é…ç½®
        - name: COLLECTOR_ZIPKIN_HOST_PORT
          value: ":9411"
        
        ports:
        # Jaeger UI
        - containerPort: 16686
          name: ui
          protocol: TCP
        
        # Jaeger Agent (æ¥æ”¶åº”ç”¨Span)
        - containerPort: 6831
          name: agent-compact
          protocol: UDP
        - containerPort: 6832
          name: agent-binary
          protocol: UDP
        
        # Jaeger Collector
        - containerPort: 14268
          name: collector
          protocol: TCP
        
        # OTLP gRPC (æ¨è,æ€§èƒ½æ›´å¥½)
        - containerPort: 4317
          name: otlp-grpc
          protocol: TCP
        
        # OTLP HTTP
        - containerPort: 4318
          name: otlp-http
          protocol: TCP
        
        # å¥åº·æ£€æŸ¥
        - containerPort: 14269
          name: admin
          protocol: TCP
        
        volumeMounts:
        - name: badger-data
          mountPath: /badger
        
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        
        livenessProbe:
          httpGet:
            path: /
            port: 14269
          initialDelaySeconds: 30
          periodSeconds: 10
        
        readinessProbe:
          httpGet:
            path: /
            port: 14269
          initialDelaySeconds: 10
          periodSeconds: 5
      
      volumes:
      - name: badger-data
        persistentVolumeClaim:
          claimName: jaeger-badger-pvc
---
# æŒä¹…åŒ–å­˜å‚¨(ä¿å­˜Traceæ•°æ®)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jaeger-badger-pvc
  namespace: monitoring
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
# Service: æš´éœ²Jaegerç«¯ç‚¹
apiVersion: v1
kind: Service
metadata:
  name: jaeger
  namespace: monitoring
  labels:
    app: jaeger
spec:
  type: LoadBalancer
  ports:
  # Jaeger UI
  - port: 16686
    targetPort: 16686
    name: ui
    protocol: TCP
  
  # Agent UDPç«¯å£
  - port: 6831
    targetPort: 6831
    name: agent-compact
    protocol: UDP
  
  # OTLP gRPC(åº”ç”¨å‘é€Span)
  - port: 4317
    targetPort: 4317
    name: otlp-grpc
    protocol: TCP
  
  # OTLP HTTP
  - port: 4318
    targetPort: 4318
    name: otlp-http
    protocol: TCP
  
  selector:
    app: jaeger
```

**éƒ¨ç½²Jaeger:**

```bash
# åˆ›å»ºmonitoringå‘½åç©ºé—´(å¦‚æœè¿˜æ²¡æœ‰)
kubectl create namespace monitoring

# éƒ¨ç½²Jaeger
kubectl apply -f jaeger-deployment.yaml

# ç­‰å¾…Podå°±ç»ª
kubectl wait --for=condition=ready pod -l app=jaeger -n monitoring --timeout=120s

# è·å–Jaeger UIçš„å¤–éƒ¨IP
kubectl get svc jaeger -n monitoring

# è¾“å‡ºç±»ä¼¼:
# NAME     TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)
# jaeger   LoadBalancer   10.0.145.23    52.123.45.67     16686:30686/TCP...

# è®¿é—® http://52.123.45.67:16686 å³å¯æ‰“å¼€Jaeger UI
```

### Part 4:é›†æˆOpenTelemetryåˆ°Django

Jaegeréƒ¨ç½²å®Œæˆå,ä¸‹ä¸€æ­¥æ˜¯è®©æˆ‘ä»¬çš„Djangoåº”ç”¨å‘é€Traceæ•°æ®ã€‚OpenTelemetryæä¾›äº†Python SDK,å¯ä»¥è‡ªåŠ¨å’Œæ‰‹åŠ¨æ’æ¡©(Instrumentation)ã€‚

#### **è‡ªåŠ¨æ’æ¡©:é›¶ä»£ç æ”¹åŠ¨**

OpenTelemetryçš„æ€æ‰‹çº§ç‰¹æ€§æ˜¯**è‡ªåŠ¨æ’æ¡©**ã€‚å®ƒå¯ä»¥è‡ªåŠ¨è¿½è¸ª:
- HTTPè¯·æ±‚(Djangoè§†å›¾)
- æ•°æ®åº“æŸ¥è¯¢(PostgreSQLã€Redis)
- HTTPå®¢æˆ·ç«¯è°ƒç”¨(requestsåº“)

**å®‰è£…OpenTelemetryä¾èµ–:**

```bash
# è¿›å…¥è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# æ ¸å¿ƒåŒ…
pip install opentelemetry-api
pip install opentelemetry-sdk
pip install opentelemetry-instrumentation

# Djangoè‡ªåŠ¨æ’æ¡©
pip install opentelemetry-instrumentation-django

# æ•°æ®åº“æ’æ¡©
pip install opentelemetry-instrumentation-psycopg2

# Redisæ’æ¡©
pip install opentelemetry-instrumentation-redis

# HTTPå®¢æˆ·ç«¯æ’æ¡©
pip install opentelemetry-instrumentation-requests

# Jaegerå¯¼å‡ºå™¨
pip install opentelemetry-exporter-otlp-proto-grpc

# å†»ç»“ä¾èµ–
pip freeze > requirements.txt
```

**é…ç½®OpenTelemetry(settings.py):**

```python
# settings.py
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.resources import Resource
from opentelemetry.instrumentation.django import DjangoInstrumentor
from opentelemetry.instrumentation.psycopg2 import Psycopg2Instrumentor
from opentelemetry.instrumentation.redis import RedisInstrumentor
from opentelemetry.instrumentation.requests import RequestsInstrumentor
import os

# 1. å®šä¹‰æœåŠ¡èµ„æº(æœåŠ¡çš„å…ƒæ•°æ®)
resource = Resource.create({
    "service.name": "xiaodiantong-storefront",  # æœåŠ¡åç§°
    "service.version": "2.5.0",           # ç‰ˆæœ¬å·
    "deployment.environment": os.getenv("ENVIRONMENT", "production"),
    "service.namespace": "dukaan",        # å‘½åç©ºé—´
    "service.instance.id": os.getenv("HOSTNAME", "unknown"),  # Podåç§°
})

# 2. åˆ›å»ºTracer Provider
tracer_provider = TracerProvider(resource=resource)

# 3. é…ç½®Spanå¯¼å‡ºå™¨(å‘é€åˆ°Jaeger)
otlp_exporter = OTLPSpanExporter(
    endpoint="http://jaeger.monitoring.svc.cluster.local:4317",  # Jaeger OTLP gRPCç«¯ç‚¹
    insecure=True,  # å†…éƒ¨ç½‘ç»œ,ä¸ä½¿ç”¨TLS
)

# 4. ä½¿ç”¨æ‰¹å¤„ç†å¯¼å‡ºå™¨(å¼‚æ­¥å‘é€,ä¸é˜»å¡è¯·æ±‚)
span_processor = BatchSpanProcessor(
    otlp_exporter,
    max_queue_size=2048,        # é˜Ÿåˆ—æœ€å¤§Spanæ•°
    schedule_delay_millis=5000, # æ¯5ç§’å‘é€ä¸€æ¬¡æ‰¹æ¬¡
    max_export_batch_size=512,  # æ¯æ‰¹æœ€å¤š512ä¸ªSpan
)
tracer_provider.add_span_processor(span_processor)

# 5. è®¾ç½®å…¨å±€Tracer Provider
trace.set_tracer_provider(tracer_provider)

# 6. è‡ªåŠ¨æ’æ¡©(æ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç !)
DjangoInstrumentor().instrument()        # è‡ªåŠ¨è¿½è¸ªDjangoè¯·æ±‚
Psycopg2Instrumentor().instrument()      # è‡ªåŠ¨è¿½è¸ªSQLæŸ¥è¯¢
RedisInstrumentor().instrument()         # è‡ªåŠ¨è¿½è¸ªRedisæ“ä½œ
RequestsInstrumentor().instrument()      # è‡ªåŠ¨è¿½è¸ªHTTPå®¢æˆ·ç«¯è°ƒç”¨

# 7. å¯é€‰:é…ç½®é‡‡æ ·ç­–ç•¥
# åœ¨ç”Ÿäº§ç¯å¢ƒ,è¿½è¸ª100%è¯·æ±‚ä¼šäº§ç”Ÿå¤§é‡æ•°æ®,å¯ä»¥é…ç½®é‡‡æ ·ç‡
from opentelemetry.sdk.trace.sampling import TraceIdRatioBased

# é‡‡æ ·10%çš„è¯·æ±‚
tracer_provider.sampler = TraceIdRatioBased(0.1)
```

å°±è¿™æ ·!ç°åœ¨æ¯ä¸ªDjangoè¯·æ±‚éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºTraceå’ŒSpan,æ— éœ€ä¿®æ”¹ä»»ä½•ä¸šåŠ¡ä»£ç ã€‚

#### **æ‰‹åŠ¨æ’æ¡©:è¿½è¸ªä¸šåŠ¡é€»è¾‘**

è‡ªåŠ¨æ’æ¡©å¾ˆå¼ºå¤§,ä½†å®ƒåªèƒ½è¿½è¸ªæ¡†æ¶çº§åˆ«çš„æ“ä½œã€‚å¯¹äºä¸šåŠ¡é€»è¾‘,æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ›å»ºSpanã€‚

**ç¤ºä¾‹1:è¿½è¸ªè®¢å•å¤„ç†æµç¨‹**

```python
# views.py
from django.http import JsonResponse
from opentelemetry import trace
from opentelemetry.trace import Status, StatusCode
import time

# è·å–Tracerå®ä¾‹
tracer = trace.get_tracer(__name__)

def create_order(request):
    # å½“å‰è¯·æ±‚å·²ç»æœ‰ä¸€ä¸ªSpan(ç”±DjangoInstrumentoråˆ›å»º)
    # æˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸‹åˆ›å»ºå­Span
    
    with tracer.start_as_current_span("create_order") as span:
        # æ·»åŠ ä¸šåŠ¡å±æ€§åˆ°Span
        user_id = request.user.id
        span.set_attribute("user.id", user_id)
        span.set_attribute("http.method", request.method)
        span.set_attribute("order.type", "standard")
        
        try:
            # æ­¥éª¤1:ç”Ÿæˆè®¢å•ID
            with tracer.start_as_current_span("generate_order_id"):
                order_id = generate_unique_order_id()
                span.set_attribute("order.id", order_id)
            
            # æ­¥éª¤2:éªŒè¯åº“å­˜
            with tracer.start_as_current_span("check_inventory") as inv_span:
                inv_span.set_attribute("items.count", len(request.POST.getlist('items')))
                
                start_time = time.time()
                inventory_result = check_inventory_availability(request.POST.getlist('items'))
                duration = time.time() - start_time
                
                inv_span.set_attribute("inventory.check_duration_ms", duration * 1000)
                inv_span.set_attribute("inventory.available", inventory_result.all_available)
                
                if not inventory_result.all_available:
                    # è®°å½•åº“å­˜ä¸è¶³äº‹ä»¶
                    inv_span.add_event(
                        "inventory_insufficient",
                        attributes={
                            "missing_items": str(inventory_result.missing_items),
                        }
                    )
                    span.set_status(Status(StatusCode.ERROR, "Inventory insufficient"))
                    return JsonResponse({
                        'status': 'error',
                        'message': 'éƒ¨åˆ†å•†å“åº“å­˜ä¸è¶³'
                    }, status=400)
            
            # æ­¥éª¤3:å¤„ç†æ”¯ä»˜
            with tracer.start_as_current_span("process_payment") as pay_span:
                amount = float(request.POST['amount'])
                pay_span.set_attribute("payment.amount", amount)
                pay_span.set_attribute("payment.currency", "INR")
                pay_span.set_attribute("payment.method", request.POST.get('method', 'card'))
                
                try:
                    payment_result = process_stripe_payment(
                        user_id=user_id,
                        amount=amount,
                        order_id=order_id
                    )
                    
                    pay_span.set_attribute("payment.transaction_id", payment_result.transaction_id)
                    pay_span.set_attribute("payment.gateway", "stripe")
                    pay_span.set_status(Status(StatusCode.OK))
                    
                except PaymentError as e:
                    # æ”¯ä»˜å¤±è´¥,è®°å½•å¼‚å¸¸
                    pay_span.record_exception(e)
                    pay_span.set_status(Status(StatusCode.ERROR, f"Payment failed: {e.code}"))
                    pay_span.set_attribute("payment.error_code", e.code)
                    raise
            
            # æ­¥éª¤4:åˆ›å»ºè®¢å•è®°å½•
            with tracer.start_as_current_span("create_order_record"):
                order = Order.objects.create(
                    id=order_id,
                    user_id=user_id,
                    total=amount,
                    status='confirmed',
                    payment_transaction_id=payment_result.transaction_id
                )
            
            # æ­¥éª¤5:å‘é€ç¡®è®¤é‚®ä»¶(å¼‚æ­¥)
            with tracer.start_as_current_span("send_confirmation_email"):
                send_order_confirmation_email.delay(order_id)
            
            # æˆåŠŸ,è®¾ç½®SpançŠ¶æ€
            span.set_status(Status(StatusCode.OK))
            span.set_attribute("order.status", "confirmed")
            
            return JsonResponse({
                'status': 'success',
                'order_id': order_id
            })
            
        except PaymentError as e:
            # è®°å½•å¼‚å¸¸åˆ°Span
            span.record_exception(e)
            span.set_status(Status(StatusCode.ERROR, "Payment processing failed"))
            
            return JsonResponse({
                'status': 'error',
                'message': 'æ”¯ä»˜å¤„ç†å¤±è´¥'
            }, status=500)
            
        except Exception as e:
            # è®°å½•æœªçŸ¥å¼‚å¸¸
            span.record_exception(e)
            span.set_status(Status(StatusCode.ERROR, "Internal server error"))
            
            return JsonResponse({
                'status': 'error',
                'message': 'ç³»ç»Ÿé”™è¯¯'
            }, status=500)
```

è¿™æ®µä»£ç åˆ›å»ºçš„Traceçœ‹èµ·æ¥åƒè¿™æ ·:

```
Trace: POST /api/orders/create
â”œâ”€ Span: create_order (æ€»è€—æ—¶: 1.2s)
â”‚  â”œâ”€ Span: generate_order_id (15ms)
â”‚  â”œâ”€ Span: check_inventory (234ms)
â”‚  â”‚  â””â”€ Span: SELECT * FROM inventory... (è‡ªåŠ¨æ’æ¡©,198ms)
â”‚  â”œâ”€ Span: process_payment (856ms)
â”‚  â”‚  â””â”€ Span: POST https://api.stripe.com/v1/charges (è‡ªåŠ¨æ’æ¡©,823ms)
â”‚  â”œâ”€ Span: create_order_record (67ms)
â”‚  â”‚  â””â”€ Span: INSERT INTO orders... (è‡ªåŠ¨æ’æ¡©,52ms)
â”‚  â””â”€ Span: send_confirmation_email (8ms)
```

#### **Spançš„æœ€ä½³å®è·µ**

æèŠ³æ€»ç»“äº†å‡ æ¡Spanä½¿ç”¨çš„æœ€ä½³å®è·µ:

**1. ä¸ºSpanå‘½åè¦æ¸…æ™°ä¸”ä¸€è‡´**

```python
# âŒ ä¸å¥½çš„å‘½å
with tracer.start_as_current_span("func1"):
    ...

# âœ… å¥½çš„å‘½å
with tracer.start_as_current_span("validate_user_credentials"):
    ...
```

**2. æ·»åŠ å…³é”®ä¸šåŠ¡å±æ€§**

```python
span.set_attribute("user.id", user_id)
span.set_attribute("order.id", order_id)
span.set_attribute("payment.amount", amount)
span.set_attribute("inventory.sku", product_sku)
```

è¿™äº›å±æ€§å¯ä»¥åœ¨Jaeger UIä¸­æœç´¢å’Œè¿‡æ»¤ã€‚

**3. è®°å½•å…³é”®äº‹ä»¶**

```python
span.add_event(
    "cache_miss",
    attributes={
        "cache.key": cache_key,
        "cache.ttl": 300,
    }
)
```

**4. æ­£ç¡®è®¾ç½®SpançŠ¶æ€**

```python
# æˆåŠŸ
span.set_status(Status(StatusCode.OK))

# å¤±è´¥(å¸¦æè¿°)
span.set_status(Status(StatusCode.ERROR, "Database connection timeout"))

# è®°å½•å¼‚å¸¸
try:
    risky_operation()
except Exception as e:
    span.record_exception(e)  # è‡ªåŠ¨æå–å¼‚å¸¸ç±»å‹ã€æ¶ˆæ¯ã€å †æ ˆ
    span.set_status(Status(StatusCode.ERROR))
    raise
```

**5. é¿å…è¿‡åº¦è¿½è¸ª**

ä¸è¦ä¸ºæ¯ä¸ªå°å‡½æ•°éƒ½åˆ›å»ºSpan,è¿™ä¼šäº§ç”Ÿå¤§é‡æ•°æ®ä¸”éš¾ä»¥é˜…è¯»ã€‚åªè¿½è¸ªæœ‰æ„ä¹‰çš„ä¸šåŠ¡æ“ä½œ:
- âœ… ç”¨æˆ·è¯·æ±‚å¤„ç†
- âœ… å¤–éƒ¨æœåŠ¡è°ƒç”¨
- âœ… æ•°æ®åº“æ“ä½œ
- âœ… ç¼“å­˜æ“ä½œ
- âŒ ç®€å•çš„æ•°æ®è½¬æ¢å‡½æ•°
- âŒ æ¨¡æ¿æ¸²æŸ“å†…éƒ¨ç»†èŠ‚

### Part 5:æœåŠ¡é—´è¿½è¸ªâ€”â€”ä¼ æ’­Trace Context

æœ€å…³é”®çš„éƒ¨åˆ†æ¥äº†:**å¦‚ä½•åœ¨å¾®æœåŠ¡é—´ä¼ æ’­è¿½è¸ªä¸Šä¸‹æ–‡**?

å½“StorefrontæœåŠ¡è°ƒç”¨InventoryæœåŠ¡æ—¶,å®ƒå¿…é¡»å‘Šè¯‰Inventory:"å˜¿,æˆ‘æ­£åœ¨å¤„ç†Trace XYZ,è¿™æ˜¯æˆ‘çš„Span ABC,ä½ çš„æ“ä½œåº”è¯¥æ˜¯æˆ‘çš„å­Spanã€‚"

å¹¸è¿çš„æ˜¯,OpenTelemetryçš„`RequestsInstrumentor`è‡ªåŠ¨å¤„ç†äº†è¿™ä¸€åˆ‡!å½“ä½ ä½¿ç”¨`requests`åº“å‘èµ·HTTPè°ƒç”¨æ—¶,å®ƒä¼šè‡ªåŠ¨æ·»åŠ `traceparent` header:

```python
# storefront_service/inventory_client.py
import requests
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

def check_inventory(product_ids):
    with tracer.start_as_current_span("call_inventory_service") as span:
        span.set_attribute("inventory.product_count", len(product_ids))
        
        # RequestsInstrumentorè‡ªåŠ¨æ³¨å…¥traceparent header!
        response = requests.post(
            'http://inventory-service/api/check',
            json={'product_ids': product_ids},
            timeout=5
        )
        
        span.set_attribute("http.status_code", response.status_code)
        
        if response.status_code != 200:
            span.set_status(Status(StatusCode.ERROR, f"HTTP {response.status_code}"))
        
        return response.json()
```

åœ¨InventoryæœåŠ¡ç«¯,`DjangoInstrumentor`ä¼šè‡ªåŠ¨æå–`traceparent` header,åˆ›å»ºå­Span:

```python
# inventory_service/views.py
from django.http import JsonResponse
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

def check_inventory_api(request):
    # å½“å‰Spanè‡ªåŠ¨æˆä¸ºStorefrontè°ƒç”¨Spançš„å­Span!
    with tracer.start_as_current_span("check_inventory_availability") as span:
        product_ids = request.POST.getlist('product_ids')
        span.set_attribute("product_ids.count", len(product_ids))
        
        # æŸ¥è¯¢æ•°æ®åº“(è‡ªåŠ¨åˆ›å»ºå­Span)
        products = Product.objects.filter(id__in=product_ids)
        
        available = all(p.stock > 0 for p in products)
        span.set_attribute("inventory.all_available", available)
        
        return JsonResponse({
            'available': available,
            'products': [{'id': p.id, 'stock': p.stock} for p in products]
        })
```

**Traceä¼ æ’­ç¤ºæ„å›¾:**

```mermaid
%%{init: {'theme':'dark'}}%%
sequenceDiagram
    participant User as ç”¨æˆ·
    participant SF as StorefrontæœåŠ¡
    participant Inv as InventoryæœåŠ¡
    participant DB as PostgreSQL
    participant Jaeger as Jaeger

    User->>SF: GET /store/products
    activate SF
    Note over SF: åˆ›å»ºTrace<br/>trace_id=abc123<br/>Span: http_request
    
    SF->>Jaeger: å‘é€Span(å¼‚æ­¥)
    
    SF->>Inv: POST /api/check<br/>Header: traceparent: abc123
    activate Inv
    Note over Inv: æå–trace_id=abc123<br/>åˆ›å»ºå­Span:<br/>check_inventory
    
    Inv->>DB: SELECT * FROM products
    activate DB
    Note over Inv: åˆ›å»ºå­Span:<br/>sql_query
    DB-->>Inv: è¿”å›ç»“æœ
    deactivate DB
    
    Inv->>Jaeger: å‘é€Span(å¼‚æ­¥)
    Inv-->>SF: è¿”å›åº“å­˜æ•°æ®
    deactivate Inv
    
    SF-->>User: è¿”å›å•†å“åˆ—è¡¨
    deactivate SF
    
    Note over Jaeger: èšåˆæ‰€æœ‰Span<br/>æ„å»ºå®Œæ•´Traceæ ‘
    
    style SF fill:#1f2937,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
    style Inv fill:#374151,stroke:#10b981,color:#f3f4f6,stroke-width:2px
    style Jaeger fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:3px
```

### Part 6:Jaeger UIâ€”â€”è¿½è¸ªçš„è§†è§‰é­”æ³•

éƒ¨ç½²å®Œæˆä¸€å‘¨å,æˆ‘æ‰“å¼€Jaeger UI,çœ‹ç€æ•°æ®æµå…¥ã€‚ç•Œé¢ç®€æ´ä¼˜é›…,ä½†åŠŸèƒ½å¼ºå¤§ã€‚

#### **Jaeger UIæ ¸å¿ƒåŠŸèƒ½**

**1. æœç´¢Trace**

ä¸»æœç´¢é¡µé¢å…è®¸ä½ é€šè¿‡å¤šç§æ¡ä»¶è¿‡æ»¤Trace:
- **Service**:é€‰æ‹©æœåŠ¡(å¦‚storefrontã€inventory)
- **Operation**:é€‰æ‹©æ“ä½œ(å¦‚HTTP GET /productsã€check_inventory)
- **Tags**:æŒ‰æ ‡ç­¾æœç´¢(å¦‚http.status_code=500ã€user.id=12345)
- **Min/Max Duration**:æŒ‰è€—æ—¶è¿‡æ»¤(å¦‚åªçœ‹>5ç§’çš„è¯·æ±‚)
- **Lookback**:æ—¶é—´èŒƒå›´(æœ€è¿‘1å°æ—¶ã€ä»Šå¤©ã€è‡ªå®šä¹‰)

**ç¤ºä¾‹æœç´¢:**

```
Service: storefront
Tags: http.status_code=500 user.id=87654
Min Duration: 5s
Lookback: Last 24 hours

ç»“æœ:æ‰¾åˆ°23ä¸ªç¬¦åˆæ¡ä»¶çš„Trace
```

**2. Traceè¯¦æƒ…é¡µâ€”â€”ç€‘å¸ƒå›¾**

ç‚¹å‡»ä»»æ„Trace,ä¼šæ‰“å¼€è¯¦æƒ…é¡µ,æ˜¾ç¤ºå®Œæ•´çš„Spanæ ‘å’Œç€‘å¸ƒå›¾:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Trace: 4bf92f3577b34da6a3ce929d0e0e4736
Duration: 20.34s | Spans: 15 | Services: 3 | Errors: 1
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Timeline:
0s         5s         10s        15s        20s
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚

â–¼ storefront: GET /store/myshop/products [20.34s]
  â”‚ Tags: http.method=GET, user.id=87654
  â”‚
  â”œâ”€ storefront: create_order [20.31s]
  â”‚  â”‚ Tags: order.id=ORD-99232, order.type=standard
  â”‚  â”‚
  â”‚  â”œâ”€ storefront: generate_order_id [15ms]
  â”‚  â”‚
  â”‚  â”œâ”€ storefront: check_inventory [234ms]
  â”‚  â”‚  â””â”€ storefront: POST http://inventory-service/api/check [231ms]
  â”‚  â”‚     â”‚ Tags: http.status_code=200
  â”‚  â”‚     â”‚
  â”‚  â”‚     â””â”€â–¼ inventory: check_inventory_availability [198ms]
  â”‚  â”‚        â”‚ Tags: product_ids.count=5
  â”‚  â”‚        â”‚
  â”‚  â”‚        â””â”€ inventory: sql SELECT FROM products [187ms]
  â”‚  â”‚           Tags: db.statement=SELECT * FROM products WHERE id IN (...)
  â”‚  â”‚
  â”‚  â”œâ”€ storefront: process_payment [18.95s] âš ï¸ SLOW
  â”‚  â”‚  â””â”€ storefront: POST https://api.stripe.com/v1/charges [18.92s] âš ï¸âš ï¸âš ï¸
  â”‚  â”‚     Tags: http.status_code=200, payment.amount=1500
  â”‚  â”‚     [è­¦å‘Š:å¤–éƒ¨APIè°ƒç”¨è€—æ—¶è¿‡é•¿]
  â”‚  â”‚
  â”‚  â”œâ”€ storefront: create_order_record [67ms]
  â”‚  â”‚  â””â”€ storefront: sql INSERT INTO orders [52ms]
  â”‚  â”‚
  â”‚  â””â”€ storefront: send_confirmation_email [8ms]
  â”‚
  â””â”€ storefront: render_response [23ms]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç“¶é¢ˆåˆ†æ:
âš ï¸ Stripe APIè°ƒç”¨å æ€»è€—æ—¶93%(18.92s / 20.34s)
   å»ºè®®:è€ƒè™‘å¼‚æ­¥æ”¯ä»˜å¤„ç†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**3. æœåŠ¡ä¾èµ–å›¾**

Jaegerå¯ä»¥æ ¹æ®è¿½è¸ªæ•°æ®è‡ªåŠ¨ç”ŸæˆæœåŠ¡ä¾èµ–æ‹“æ‰‘å›¾:

```mermaid
%%{init: {'theme':'dark'}}%%
graph LR
    SF[Storefront<br/>1.2K req/min<br/>å¹³å‡: 234ms]
    Pay[Payment<br/>856 req/min<br/>å¹³å‡: 145ms]
    Inv[Inventory<br/>1.1K req/min<br/>å¹³å‡: 89ms]
    DB[(PostgreSQL<br/>2.8K queries/min<br/>å¹³å‡: 12ms)]
    Redis[(Redis<br/>5.2K ops/min<br/>å¹³å‡: 2ms)]
    Stripe[Stripe API<br/>856 req/min<br/>å¹³å‡: 892ms]
    
    SF -->|86%| Inv
    SF -->|71%| Pay
    SF -->|94%| Redis
    Pay -->|98%| Stripe
    Inv -->|89%| DB
    Pay -->|67%| DB
    
    style SF fill:#1f2937,stroke:#60a5fa,color:#f3f4f6,stroke-width:2px
    style Pay fill:#374151,stroke:#10b981,color:#f3f4f6,stroke-width:2px
    style Inv fill:#374151,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style Stripe fill:#1f2937,stroke:#ef4444,color:#f3f4f6,stroke-width:3px
```

è¿™å¼ å›¾ç«‹å³æ˜¾ç¤º:
- Stripe APIæ˜¯æœ€æ…¢çš„ä¾èµ–(å¹³å‡892ms)
- Storefrontå¯¹Redisçš„ä¾èµ–ç‡å¾ˆé«˜(94%çš„è¯·æ±‚éƒ½è®¿é—®Redis)
- Paymentå’ŒInventoryéƒ½ä¾èµ–åŒä¸€ä¸ªPostgreSQLæ•°æ®åº“

**4. å¯¹æ¯”Trace**

Jaegerå…è®¸ä½ å¹¶æ’å¯¹æ¯”ä¸¤ä¸ªTrace,æ‰¾å‡ºå·®å¼‚:

```
å¿«é€Ÿè¯·æ±‚ (123ms)          vs         æ…¢é€Ÿè¯·æ±‚ (20.3s)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Redis GET products:myshop  |    Redis GET products:myshop
  12ms âœ…                   |      18ms âœ…
                           |
Inventory check            |    Inventory check
  45ms âœ…                   |      18234ms âš ï¸âš ï¸âš ï¸
  â””â”€ SQL query 32ms        |      â””â”€ Wait for connection 18200ms
                           |        â””â”€ SQL query 34ms
                           |
Payment processing         |    Payment processing
  54ms âœ…                   |      856ms âœ…
  â””â”€ Stripe API 48ms       |      â””â”€ Stripe API 823ms

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å·®å¼‚æ ¹å› :æ•°æ®åº“è¿æ¥æ± è€—å°½,ç­‰å¾…18.2ç§’è·å–è¿æ¥
```

### Part 7:çœŸå®æ¡ˆä¾‹â€”â€”20ç§’è°œé¢˜çš„ç­”æ¡ˆ

è¿˜è®°å¾—é‚£ä¸ª20ç§’çš„æ…¢è¯·æ±‚å—?Jaegeréƒ¨ç½²ä¸€å‘¨å,åŒæ ·çš„é—®é¢˜åˆå‡ºç°äº†ã€‚ä½†è¿™æ¬¡,æˆ‘åªç”¨äº†**30ç§’**å°±æ‰¾åˆ°äº†æ ¹å› ã€‚

æˆ‘æ‰“å¼€Jaeger UI,è¾“å…¥æœç´¢æ¡ä»¶:

```
Service: storefront
Min Duration: 10s
Lookback: Last 1 hour
```

ç«‹å³æ‰¾åˆ°12ä¸ªæ…¢Traceã€‚æˆ‘ç‚¹å¼€ç¬¬ä¸€ä¸ª,ç€‘å¸ƒå›¾æ¸…æ™°åœ°æ˜¾ç¤º:

```
Trace: GET /store/myshop/products [21.2s]
â””â”€ Inventory: check_stock [19.8s]
   â””â”€ Inventory: database connection wait [19.6s] âš ï¸âš ï¸âš ï¸
      â””â”€ Inventory: SELECT query [45ms]
```

**é—®é¢˜ä¸€ç›®äº†ç„¶:**InventoryæœåŠ¡åœ¨ç­‰å¾…æ•°æ®åº“è¿æ¥ã€‚æˆ‘ç«‹å³æ£€æŸ¥äº†PostgreSQLè¿æ¥æ± é…ç½®:

```python
# inventory_service/settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'inventory_db',
        'CONN_MAX_AGE': 600,
        'OPTIONS': {
            'connect_timeout': 5,
            'options': '-c statement_timeout=30000'
        },
    }
}
```

ç­‰ç­‰,`CONN_MAX_AGE`: 600ç§’æ„å‘³ç€è¿æ¥ä¼šä¿æŒ10åˆ†é’Ÿ,ä½†Djangoé»˜è®¤æ¯ä¸ªworkeråªèƒ½æŒæœ‰æœ‰é™æ•°é‡çš„è¿æ¥ã€‚åœ¨é«˜å¹¶å‘ä¸‹,è¿æ¥æ± å¾ˆå®¹æ˜“è€—å°½ã€‚

æˆ‘æŸ¥çœ‹äº†Gunicorné…ç½®:

```python
# gunicorn_config.py
workers = 4  # åªæœ‰4ä¸ªworker!
```

4ä¸ªworker,æ¯ä¸ªæœ€å¤šæŒæœ‰1ä¸ªæ•°æ®åº“è¿æ¥,æ€»å…±åªæœ‰4ä¸ªè¿æ¥!ä½†å³°å€¼å¹¶å‘å¯èƒ½æœ‰50+è¯·æ±‚,æ€ªä¸å¾—ä¼šæ’é˜Ÿç­‰å¾…ã€‚

**è§£å†³æ–¹æ¡ˆ:**

```python
# æ–¹æ¡ˆ1:å¢åŠ Gunicorn workers
workers = 12  # 3å€workers

# æ–¹æ¡ˆ2:ä½¿ç”¨è¿æ¥æ± ä¸­é—´ä»¶(æ¨è)
# pip install django-db-connection-pool
DATABASES = {
    'default': {
        'ENGINE': 'dj_db_conn_pool.backends.postgresql',
        'POOL_OPTIONS': {
            'POOL_SIZE': 20,       # è¿æ¥æ± å¤§å°
            'MAX_OVERFLOW': 10,    # é¢å¤–è¿æ¥æ•°
        }
    }
}
```

æˆ‘é€‰æ‹©äº†æ–¹æ¡ˆ2,éƒ¨ç½²åç«‹å³è§æ•ˆã€‚æ…¢è¯·æ±‚ä»æ¯å°æ—¶12æ¬¡é™åˆ°0ã€‚

ä½†Jaegerçš„ä»·å€¼ä¸æ­¢äºæ­¤ã€‚æˆ‘æ‰“å¼€"æœåŠ¡ä¾èµ–å›¾",å‘ç°äº†æ›´æ·±å±‚çš„é—®é¢˜:

```mermaid
%%{init: {'theme':'dark'}}%%
graph LR
    SF[Storefront] -->|è°ƒç”¨| Inv[Inventory]
    Pay[Payment] -->|è°ƒç”¨| Inv
    Analytics[Analytics] -->|è°ƒç”¨| Inv
    Inv -->|æŸ¥è¯¢| DB[(PostgreSQLä¸»åº“)]
    
    style Inv fill:#1f2937,stroke:#ef4444,color:#f3f4f6,stroke-width:3px
    style DB fill:#374151,stroke:#ef4444,color:#f3f4f6,stroke-width:3px
```

**InventoryæœåŠ¡æ˜¯çƒ­ç‚¹!**ä¸‰ä¸ªæœåŠ¡éƒ½ä¾èµ–å®ƒ,è€Œå®ƒåˆæ˜¯å•ç‚¹æ•…éšœã€‚å¦‚æœInventoryæŒ‚äº†,æ•´ä¸ªç³»ç»Ÿéƒ½ä¼šå—å½±å“ã€‚

æˆ‘åœ¨ä¸‹ä¸€æ¬¡å›¢é˜Ÿä¼šè®®ä¸Šæå‡ºäº†è¿™ä¸ªå‘ç°ã€‚æˆ‘ä»¬å†³å®š:
1. ä¸ºInventoryæœåŠ¡æ·»åŠ Redisç¼“å­˜å±‚
2. å®æ–½è¯»å†™åˆ†ç¦»,AnalyticsæœåŠ¡èµ°ä»åº“
3. å°†Inventoryæ‹†åˆ†ä¸ºä¸¤ä¸ªæœåŠ¡:Inventory-Readå’ŒInventory-Write

è¿™äº›æ¶æ„æ”¹è¿›éƒ½æ˜¯Jaegerå¯è§†åŒ–é©±åŠ¨çš„ã€‚

### Part 8:Traceä¸Logçš„é›†æˆâ€”â€”å®Œæ•´çš„å¯è§‚æµ‹æ€§

æœ‰äº†åˆ†å¸ƒå¼è¿½è¸ªå,æˆ‘ä»¬ä»ç„¶éœ€è¦æ—¥å¿—(Loki)ã€‚å®ƒä»¬å„æœ‰ä¼˜åŠ¿:

- **è¿½è¸ª**:å›ç­”"ç“¶é¢ˆåœ¨å“ªé‡Œ?è¯·æ±‚ç»è¿‡äº†å“ªäº›æœåŠ¡?"
- **æ—¥å¿—**:å›ç­”"å‘ç”Ÿäº†ä»€ä¹ˆå…·ä½“é”™è¯¯?å‚æ•°æ˜¯ä»€ä¹ˆ?"

æœ€å¼ºå¤§çš„ç»„åˆæ˜¯:**å°†Trace IDæ³¨å…¥åˆ°æ—¥å¿—ä¸­**,å®ç°åŒå‘è·³è½¬ã€‚

**åœ¨æ—¥å¿—ä¸­åŒ…å«Trace ID:**

```python
# settings.pyä¸­çš„æ—¥å¿—é…ç½®
import logging
from opentelemetry import trace

class TraceIDLogFilter(logging.Filter):
    """
    è‡ªåŠ¨å°†Trace IDæ·»åŠ åˆ°æ—¥å¿—è®°å½•ä¸­
    """
    def filter(self, record):
        span = trace.get_current_span()
        if span and span.get_span_context().is_valid:
            trace_id = format(span.get_span_context().trace_id, '032x')
            span_id = format(span.get_span_context().span_id, '016x')
            record.trace_id = trace_id
            record.span_id = span_id
        else:
            record.trace_id = "0" * 32
            record.span_id = "0" * 16
        return True

# æ›´æ–°JSONFormatter
class JSONFormatter(logging.Formatter):
    def format(self, record):
        log_obj = {
            "timestamp": datetime.utcnow().isoformat() + 'Z',
            "level": record.levelname,
            "msg": record.getMessage(),
            "trace_id": getattr(record, 'trace_id', None),  # âœ¨ Trace ID
            "span_id": getattr(record, 'span_id', None),    # âœ¨ Span ID
            "module": record.module,
            "function": record.funcName,
        }
        
        # æ·»åŠ å…¶ä»–è‡ªå®šä¹‰å­—æ®µ
        if hasattr(record, 'order_id'):
            log_obj['order_id'] = record.order_id
        if hasattr(record, 'user_id'):
            log_obj['user_id'] = record.user_id
        
        return json.dumps(log_obj, ensure_ascii=False)

LOGGING = {
    'version': 1,
    'filters': {
        'trace_id': {
            '()': TraceIDLogFilter,
        },
    },
    'formatters': {
        'json': {
            '()': JSONFormatter,
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'json',
            'filters': ['trace_id'],  # åº”ç”¨Trace IDè¿‡æ»¤å™¨
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
}
```

ç°åœ¨,æ¯æ¡æ—¥å¿—éƒ½åŒ…å«Trace ID:

```json
{
  "timestamp": "2023-12-20T14:23:45.123Z",
  "level": "ERROR",
  "msg": "æ”¯ä»˜ç½‘å…³è¿”å›é”™è¯¯",
  "trace_id": "4bf92f3577b34da6a3ce929d0e0e4736",
  "span_id": "00f067aa0ba902b7",
  "order_id": "ORD-12345",
  "error_code": "insufficient_funds"
}
```

**Grafanaä¸­é…ç½®Traceåˆ°Logçš„è·³è½¬:**

```yaml
# grafana-datasources.yaml
apiVersion: 1
datasources:
- name: Jaeger
  type: jaeger
  url: http://jaeger:16686
  jsonData:
    # ä»Traceè·³è½¬åˆ°ç›¸å…³æ—¥å¿—
    tracesToLogs:
      datasourceUid: loki
      tags: ['trace_id']
      filterByTraceID: true
      filterBySpanID: false

- name: Loki
  type: loki
  url: http://loki:3100
  jsonData:
    # ä»æ—¥å¿—è·³è½¬åˆ°Trace
    derivedFields:
    - datasourceUid: jaeger
      matcherRegex: '"trace_id":"([0-9a-f]{32})"'
      name: TraceID
      url: '$${__value.raw}'
```

**å·¥ä½œæµç¨‹:**

1. ç”¨æˆ·æŠ¥å‘Šé—®é¢˜:"è®¢å•ORD-12345åˆ›å»ºå¤±è´¥"
2. åœ¨Lokiä¸­æœç´¢:`{namespace="production"} |= "ORD-12345"`
3. æ‰¾åˆ°é”™è¯¯æ—¥å¿—,ç‚¹å‡»æ—¥å¿—ä¸­çš„"TraceID"é“¾æ¥
4. è‡ªåŠ¨è·³è½¬åˆ°Jaeger,æ˜¾ç¤ºå®Œæ•´çš„è¯·æ±‚ç€‘å¸ƒå›¾
5. åœ¨ç€‘å¸ƒå›¾ä¸­æ‰¾åˆ°æ…¢Span,ç‚¹å‡»"Logs"
6. è‡ªåŠ¨è·³è½¬å›Loki,æ˜¾ç¤ºè¯¥Spanæ‰§è¡ŒæœŸé—´çš„æ‰€æœ‰æ—¥å¿—

**å®Œæ•´çš„å¯è§‚æµ‹æ€§å¾ªç¯!**

```mermaid
%%{init: {'theme':'dark'}}%%
graph LR
    User[ç”¨æˆ·æŠ¥å‘Šé—®é¢˜] --> Loki[Lokiæ—¥å¿—æœç´¢]
    Loki -->|ç‚¹å‡»Trace ID| Jaeger[Jaegerè¿½è¸ªè¯¦æƒ…]
    Jaeger -->|ç‚¹å‡»Span| Loki_Detail[LokiæŸ¥çœ‹Spanæ—¥å¿—]
    Loki_Detail -->|ç‚¹å‡»ç›¸å…³Trace| Jaeger
    
    Jaeger --> Insights[å‘ç°ç“¶é¢ˆ<br/>è¯†åˆ«æ…¢Span]
    Loki_Detail --> Root_Cause[æŸ¥çœ‹è¯¦ç»†é”™è¯¯<br/>æå–å‚æ•°]
    
    Insights --> Fix[åˆ¶å®šè§£å†³æ–¹æ¡ˆ]
    Root_Cause --> Fix
    
    style Loki fill:#1f2937,stroke:#f59e0b,color:#f3f4f6,stroke-width:2px
    style Jaeger fill:#1f2937,stroke:#60a5fa,color:#f3f4f6,stroke-width:3px
    style Fix fill:#374151,stroke:#10b981,color:#f3f4f6,stroke-width:3px
```

### Part 9:çœŸå®æ”¶ç›Šâ€”â€”æ•°å­—ä¼šè¯´è¯

å…­ä¸ªæœˆå,æˆ‘è®©æèŠ³åšäº†ä¸€æ¬¡å›é¡¾æ€§åˆ†æã€‚å¼•å…¥åˆ†å¸ƒå¼è¿½è¸ªå‰åçš„å¯¹æ¯”:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿæ”¶ç›Šåˆ†æ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æŒ‡æ ‡                          å¼•å…¥å‰         å¼•å…¥å        æ”¹å–„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€§èƒ½é—®é¢˜å®šä½æ—¶é—´(MTTD)       45åˆ†é’Ÿ        2åˆ†é’Ÿ         95.6% â†“
ç“¶é¢ˆè¯†åˆ«å‡†ç¡®ç‡               ~60%          ~98%          63% â†‘
éœ€è¦æŸ¥çœ‹çš„æ—¥å¿—æ–‡ä»¶æ•°         15ä¸ª          0ä¸ª           100% â†“
è·¨æœåŠ¡è°ƒè¯•æ—¶é—´               2å°æ—¶         10åˆ†é’Ÿ        91.7% â†“
é”™è¯¯æ ¹å› åˆ†ææˆåŠŸç‡           ~70%          ~95%          35.7% â†‘

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ¶æ„æ´å¯Ÿ(æ–°å¢èƒ½åŠ›)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… è‡ªåŠ¨ç”ŸæˆæœåŠ¡ä¾èµ–æ‹“æ‰‘å›¾
âœ… è¯†åˆ«çƒ­ç‚¹æœåŠ¡å’Œå•ç‚¹æ•…éšœ
âœ… å‘ç°éšè—çš„æ€§èƒ½ç“¶é¢ˆ(å¦‚è¿æ¥æ± è€—å°½)
âœ… é‡åŒ–å¤–éƒ¨APIè°ƒç”¨å½±å“(Stripeå 93%è€—æ—¶)
âœ… è¿½è¸ªé”™è¯¯ä¼ æ’­è·¯å¾„

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æˆæœ¬
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åŸºç¡€è®¾æ–½æˆæœ¬/æœˆ             $0            $120          æ–°å¢
(JaegeræœåŠ¡å™¨)                            (3å°Ã—$40)

å­˜å‚¨æˆæœ¬/æœˆ                 $0            $45           æ–°å¢
(Traceæ•°æ®,7å¤©ä¿ç•™)                        (S3)

å·¥ç¨‹å¸ˆå·¥æ—¶èŠ‚çœ/å‘¨           0             12å°æ—¶        èŠ‚çœ
(ä»·å€¼)                                    $960/å‘¨

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ROIè®¡ç®—:
  æˆæœ¬: $165/æœˆ
  èŠ‚çœ: $960/å‘¨ Ã— 4å‘¨ = $3,840/æœˆ
  å‡€æ”¶ç›Š: $3,675/æœˆ = $44,100/å¹´
  æŠ•èµ„å›æŠ¥ç‡: 2,227%
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

ä½†æ•°å­—ä¹‹å¤–,æ›´é‡è¦çš„æ˜¯**å›¢é˜Ÿä¿¡å¿ƒçš„æå‡**ã€‚

åœ¨å¼•å…¥åˆ†å¸ƒå¼è¿½è¸ªå‰,æ€§èƒ½è°ƒä¼˜åƒæ˜¯åœ¨é»‘æš—ä¸­æ‘¸ç´¢ã€‚æˆ‘ä»¬ä¼šåšå‡ºçŒœæµ‹:"å¯èƒ½æ˜¯æ•°æ®åº“æ…¢?""ä¹Ÿè®¸æ˜¯Redisç¼“å­˜æœªå‘½ä¸­?""Stripe APIä¼šä¸ä¼šè¶…æ—¶?"

ç°åœ¨,æˆ‘ä»¬æœ‰äº†æ•°æ®æ”¯æŒçš„å†³ç­–ã€‚æˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ¯ä¸ªç»„ä»¶çš„è€—æ—¶å æ¯”,å¯ä»¥é‡åŒ–ä¼˜åŒ–çš„å½±å“ã€‚

æ›´é‡è¦çš„æ˜¯,**æˆ‘ä»¬èƒ½åœ¨ç”¨æˆ·æŠ•è¯‰ä¹‹å‰å‘ç°é—®é¢˜**ã€‚é€šè¿‡Jaegerçš„æœç´¢åŠŸèƒ½,æˆ‘ä»¬å¯ä»¥ä¸»åŠ¨æŸ¥è¯¢:
- è¿‡å»1å°æ—¶è€—æ—¶>5ç§’çš„è¯·æ±‚æœ‰å¤šå°‘?
- Stripe APIè°ƒç”¨å¤±è´¥ç‡æ˜¯å¤šå°‘?
- å“ªäº›TraceåŒ…å«æ•°æ®åº“é”™è¯¯?

è¿™è®©æˆ‘ä»¬ä»"è¢«åŠ¨æ•‘ç«"è½¬å˜ä¸º"ä¸»åŠ¨é¢„é˜²"ã€‚

---

<div style="border: 2px solid #60a5fa; border-radius: 8px; padding: 20px; margin: 30px 0; background: linear-gradient(to right, #1e3a8a08, #1e40af08);">

### ğŸ“Œ ç¼–è€…æ³¨:åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿå®æˆ˜å®Œæ•´æŒ‡å—

*æœ¬æŒ‡å—æä¾›äº†OpenTelemetry + Jaegerçš„å®Œæ•´å®æ–½æ–¹æ¡ˆ,å¸®åŠ©ä½ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¿«é€Ÿæ­å»ºåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿã€‚*

---

#### **ä¸€ã€å¿«é€Ÿå†³ç­–:æˆ‘çš„é¡¹ç›®éœ€è¦åˆ†å¸ƒå¼è¿½è¸ªå—?**

| åœºæ™¯ | æ˜¯å¦éœ€è¦ | ç†ç”± |
|------|---------|------|
| **å•ä½“åº”ç”¨,<5ä¸ªæœåŠ¡** | âŒ ä¸æ€¥éœ€ | æ—¥å¿—+APMå·¥å…·è¶³å¤Ÿ |
| **å¾®æœåŠ¡æ¶æ„,5-20ä¸ªæœåŠ¡** | âœ… å¼ºçƒˆæ¨è | è·¨æœåŠ¡è°ƒè¯•å›°éš¾ |
| **å¾®æœåŠ¡æ¶æ„,>20ä¸ªæœåŠ¡** | âœ…âœ… å¿…é¡» | æ²¡æœ‰è¿½è¸ªå°±æ˜¯ç¾éš¾ |
| **é—´æ­‡æ€§æ€§èƒ½é—®é¢˜** | âœ… éœ€è¦ | æ—¥å¿—éš¾ä»¥å®šä½ç“¶é¢ˆ |
| **å¤šå›¢é˜Ÿåä½œ** | âœ… éœ€è¦ | æ˜ç¡®æœåŠ¡è¾¹ç•Œå’Œä¾èµ– |
| **SLAè¦æ±‚ä¸¥æ ¼** | âœ… éœ€è¦ | éœ€è¦ç²¾ç¡®çš„æ€§èƒ½åˆ†æ |

**å°åº—é€šçš„åœºæ™¯:**9ä¸ªè¾¹ç¼˜é›†ç¾¤ã€8ä¸ªå¾®æœåŠ¡ã€é—´æ­‡æ€§æ€§èƒ½é—®é¢˜ â†’ å¿…é¡»å¼•å…¥è¿½è¸ª

---

#### **äºŒã€OpenTelemetryå®æ–½Checklist**

##### **é˜¶æ®µ1:é€‰æ‹©è¿½è¸ªåç«¯(1-2å°æ—¶)**

| åç«¯ç³»ç»Ÿ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **Jaeger** | å¼€æºã€æˆç†Ÿã€Kuberneteså‹å¥½ | éœ€è¦è‡ªå·±è¿ç»´ | ä¸­å°å‹å›¢é˜Ÿ |
| **Zipkin** | è½»é‡ã€ç®€å• | åŠŸèƒ½è¾ƒå°‘ | ç®€å•è¿½è¸ªéœ€æ±‚ |
| **Tempo** (Grafana) | ä¸Grafanaæ— ç¼é›†æˆ | ç›¸å¯¹è¾ƒæ–° | å·²ç”¨Grafanaçš„å›¢é˜Ÿ |
| **Datadog APM** | åŠŸèƒ½æœ€å¼ºã€SaaS | éå¸¸è´µ($31/ä¸»æœº/æœˆ) | å¤§å‹ä¼ä¸š |
| **New Relic** | åŠŸèƒ½ä¸°å¯Œ | è´µ($49/æœˆèµ·) | ä¸­å¤§å‹ä¼ä¸š |

**å°åº—é€šçš„é€‰æ‹©:**Jaeger(å¼€æºã€è‡ªæ‰˜ç®¡ã€ä¸Kubernetesé›†æˆå¥½)

##### **é˜¶æ®µ2:éƒ¨ç½²Jaeger(åŠå¤©)**

```bash
# æ–¹æ¡ˆA:å¿«é€Ÿæµ‹è¯•(All-in-One,å•å®¹å™¨)
kubectl create namespace observability
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: observability
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:1.51
        ports:
        - containerPort: 16686
          name: ui
        - containerPort: 4317
          name: otlp-grpc
        - containerPort: 4318
          name: otlp-http
        env:
        - name: COLLECTOR_OTLP_ENABLED
          value: "true"
        - name: SPAN_STORAGE_TYPE
          value: memory  # âš ï¸ ä»…ç”¨äºæµ‹è¯•,é‡å¯åæ•°æ®ä¸¢å¤±
---
apiVersion: v1
kind: Service
metadata:
  name: jaeger
  namespace: observability
spec:
  type: LoadBalancer
  ports:
  - port: 16686
    name: ui
  - port: 4317
    name: otlp-grpc
  selector:
    app: jaeger
EOF

# ç­‰å¾…éƒ¨ç½²å®Œæˆ
kubectl wait --for=condition=ready pod -l app=jaeger -n observability --timeout=120s

# è·å–UIåœ°å€
kubectl get svc jaeger -n observability
# è®¿é—® http://<EXTERNAL-IP>:16686
```

**æ–¹æ¡ˆB:ç”Ÿäº§ç¯å¢ƒ(ä½¿ç”¨Helm,é«˜å¯ç”¨)**

```bash
# æ·»åŠ Jaeger Helmä»“åº“
helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
helm repo update

# åˆ›å»ºvalues.yaml
cat > jaeger-values.yaml <<EOF
provisionDataStore:
  cassandra: false
  elasticsearch: true  # ä½¿ç”¨Elasticsearchå­˜å‚¨

storage:
  type: elasticsearch
  elasticsearch:
    host: elasticsearch-master.observability
    port: 9200
    scheme: http

query:
  replicas: 2
  resources:
    limits:
      cpu: 500m
      memory: 512Mi

collector:
  replicas: 3
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi

ingester:
  enabled: true
  replicas: 2

agent:
  enabled: true
EOF

# å®‰è£…Jaeger
helm install jaeger jaegertracing/jaeger -n observability -f jaeger-values.yaml
```

##### **é˜¶æ®µ3:åº”ç”¨é›†æˆOpenTelemetry(1-2å¤©)**

**Python/Djangoé›†æˆ:**

```bash
# å®‰è£…ä¾èµ–
pip install \
  opentelemetry-api \
  opentelemetry-sdk \
  opentelemetry-instrumentation-django \
  opentelemetry-instrumentation-psycopg2 \
  opentelemetry-instrumentation-redis \
  opentelemetry-instrumentation-requests \
  opentelemetry-exporter-otlp-proto-grpc

pip freeze > requirements.txt
```

**æœ€å°åŒ–é…ç½®(settings.py):**

```python
# settings.py
from opentelemetry import trace
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.resources import Resource
from opentelemetry.instrumentation.django import DjangoInstrumentor
from opentelemetry.instrumentation.psycopg2 import Psycopg2Instrumentor
from opentelemetry.instrumentation.redis import RedisInstrumentor
from opentelemetry.instrumentation.requests import RequestsInstrumentor
import os

# 1. åˆ›å»ºResource(æœåŠ¡æ ‡è¯†)
resource = Resource.create({
    "service.name": os.getenv("SERVICE_NAME", "my-service"),
    "service.version": os.getenv("APP_VERSION", "1.0.0"),
    "deployment.environment": os.getenv("ENVIRONMENT", "production"),
})

# 2. åˆ›å»ºTracerProvider
tracer_provider = TracerProvider(resource=resource)

# 3. é…ç½®å¯¼å‡ºå™¨
otlp_exporter = OTLPSpanExporter(
    endpoint=os.getenv("OTEL_EXPORTER_OTLP_ENDPOINT", "http://jaeger.observability:4317"),
    insecure=True,
)

# 4. æ·»åŠ æ‰¹å¤„ç†Spanå¤„ç†å™¨
tracer_provider.add_span_processor(BatchSpanProcessor(otlp_exporter))

# 5. è®¾ç½®å…¨å±€TracerProvider
trace.set_tracer_provider(tracer_provider)

# 6. è‡ªåŠ¨æ’æ¡©(é›¶ä»£ç æ”¹åŠ¨!)
DjangoInstrumentor().instrument()
Psycopg2Instrumentor().instrument()
RedisInstrumentor().instrument()
RequestsInstrumentor().instrument()
```

**Node.js/Expressé›†æˆ:**

```bash
npm install \
  @opentelemetry/api \
  @opentelemetry/sdk-node \
  @opentelemetry/auto-instrumentations-node \
  @opentelemetry/exporter-trace-otlp-grpc
```

```javascript
// tracing.js
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-grpc');
const { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');
const { Resource } = require('@opentelemetry/resources');
const { SemanticResourceAttributes } = require('@opentelemetry/semantic-conventions');

const sdk = new NodeSDK({
  resource: new Resource({
    [SemanticResourceAttributes.SERVICE_NAME]: process.env.SERVICE_NAME || 'my-service',
    [SemanticResourceAttributes.SERVICE_VERSION]: process.env.APP_VERSION || '1.0.0',
  }),
  traceExporter: new OTLPTraceExporter({
    url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || 'http://jaeger.observability:4317',
  }),
  instrumentations: [getNodeAutoInstrumentations()],
});

sdk.start();

process.on('SIGTERM', () => {
  sdk.shutdown()
    .then(() => console.log('Tracing terminated'))
    .catch((error) => console.log('Error terminating tracing', error))
    .finally(() => process.exit(0));
});
```

**åœ¨åº”ç”¨å…¥å£å¼•å…¥:**

```javascript
// index.js
require('./tracing');  // âš ï¸ å¿…é¡»åœ¨å…¶ä»–å¯¼å…¥ä¹‹å‰
const express = require('express');
// ... å…¶ä»–ä»£ç 
```

##### **é˜¶æ®µ4:éªŒè¯è¿½è¸ªæ•°æ®(15åˆ†é’Ÿ)**

```bash
# 1. è§¦å‘ä¸€ä¸ªæµ‹è¯•è¯·æ±‚
curl http://your-service/api/test

# 2. æ‰“å¼€Jaeger UI
# http://<jaeger-external-ip>:16686

# 3. åœ¨æœç´¢é¡µé¢:
#    Service: é€‰æ‹©ä½ çš„æœåŠ¡å
#    Lookback: Last 5 minutes
#    ç‚¹å‡» "Find Traces"

# 4. åº”è¯¥çœ‹åˆ°æµ‹è¯•è¯·æ±‚çš„Trace
#    ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…,ç¡®è®¤:
#    - Spanæ ‘ç»“æ„æ­£ç¡®
#    - åŒ…å«HTTPã€æ•°æ®åº“ã€Redisç­‰å­Span
#    - è€—æ—¶æ•°æ®å‡†ç¡®
```

##### **é˜¶æ®µ5:æ·»åŠ è‡ªå®šä¹‰Span(æŒ‰éœ€)**

```python
# views.py
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

def complex_business_logic(user_id, order_data):
    with tracer.start_as_current_span("process_order") as span:
        span.set_attribute("user.id", user_id)
        span.set_attribute("order.items_count", len(order_data['items']))
        
        # æ­¥éª¤1
        with tracer.start_as_current_span("validate_inventory"):
            result = validate_inventory(order_data['items'])
        
        # æ­¥éª¤2
        with tracer.start_as_current_span("charge_payment"):
            payment = charge_credit_card(order_data['amount'])
            span.set_attribute("payment.transaction_id", payment.id)
        
        return create_order(order_data)
```

---

#### **ä¸‰ã€Jaegerä½¿ç”¨æŠ€å·§**

##### **1. é«˜æ•ˆæœç´¢Trace**

| æœç´¢æ–¹å¼ | ç¤ºä¾‹ | ç”¨é€” |
|---------|------|------|
| **æŒ‰æœåŠ¡** | Service: payment | æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„æ‰€æœ‰Trace |
| **æŒ‰æ“ä½œ** | Operation: POST /api/orders | æŸ¥çœ‹ç‰¹å®šAPIç«¯ç‚¹ |
| **æŒ‰æ ‡ç­¾** | http.status_code=500 | æŸ¥æ‰¾æ‰€æœ‰å¤±è´¥è¯·æ±‚ |
| **æŒ‰è€—æ—¶** | Min Duration: 5s | æŸ¥æ‰¾æ…¢è¯·æ±‚ |
| **ç»„åˆæŸ¥è¯¢** | Service: storefront<br/>Tags: user.id=12345<br/>Min Duration: 2s | æŸ¥æ‰¾ç‰¹å®šç”¨æˆ·çš„æ…¢è¯·æ±‚ |

##### **2. é˜…è¯»ç€‘å¸ƒå›¾çš„æŠ€å·§**

```
çœ‹ç€‘å¸ƒå›¾æ—¶å…³æ³¨:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. æ€»è€—æ—¶åˆ†å¸ƒ
   â”œâ”€ æœ€é•¿çš„Spané€šå¸¸æ˜¯ç“¶é¢ˆ
   â”œâ”€ çœ‹Spanå®½åº¦,ä¸åªçœ‹åç§°
   â””â”€ å…³æ³¨é¢œè‰²(çº¢è‰²=é”™è¯¯)

2. ä¸²è¡Œvså¹¶è¡Œ
   â”œâ”€ å‚ç›´æ’åˆ—=ä¸²è¡Œæ‰§è¡Œ(ä¸å¯é¿å…)
   â”œâ”€ æœ‰ç©ºéš™=ç­‰å¾…æ—¶é—´(å¯ä¼˜åŒ–!)
   â””â”€ å¹¶è¡ŒSpanåº”è¯¥æ—¶é—´é‡å 

3. æœåŠ¡è¾¹ç•Œ
   â”œâ”€ è·¨æœåŠ¡è°ƒç”¨ä¼šæœ‰æ˜æ˜¾çš„HTTP Span
   â”œâ”€ æ£€æŸ¥æœåŠ¡é—´è°ƒç”¨æ¬¡æ•°(N+1é—®é¢˜)
   â””â”€ å…³æ³¨æœåŠ¡è°ƒç”¨å¤±è´¥ç‡

4. æ•°æ®åº“æŸ¥è¯¢
   â”œâ”€ æŸ¥æ‰¾æ…¢æŸ¥è¯¢(>100mséœ€è¦ä¼˜åŒ–)
   â”œâ”€ ç»Ÿè®¡æŸ¥è¯¢æ¬¡æ•°(ORMå¯èƒ½äº§ç”Ÿå¤§é‡æŸ¥è¯¢)
   â””â”€ æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦å¯ä»¥åˆå¹¶
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

##### **3. å¸¸è§æ€§èƒ½æ¨¡å¼è¯†åˆ«**

**æ¨¡å¼1:N+1æŸ¥è¯¢é—®é¢˜**

```
Traceæ˜¾ç¤º:
â”œâ”€ Span: List users [1.2s]
   â”œâ”€ SQL: SELECT * FROM users [10ms]
   â”œâ”€ SQL: SELECT * FROM orders WHERE user_id=1 [5ms]
   â”œâ”€ SQL: SELECT * FROM orders WHERE user_id=2 [5ms]
   â”œâ”€ SQL: SELECT * FROM orders WHERE user_id=3 [5ms]
   ... (é‡å¤100æ¬¡)
   â””â”€ SQL: SELECT * FROM orders WHERE user_id=100 [5ms]

é—®é¢˜:å¾ªç¯ä¸­çš„å•ç‹¬æŸ¥è¯¢
è§£å†³:ä½¿ç”¨JOINæˆ–select_related/prefetch_related
```

**æ¨¡å¼2:ä¸²è¡Œç­‰å¾…é—®é¢˜**

```
Traceæ˜¾ç¤º:
â”œâ”€ Span: Load page [3.5s]
   â”œâ”€ Span: Get user data [500ms]
   â”œâ”€ Span: Get products [1200ms]
   â”œâ”€ Span: Get recommendations [1500ms]
   â””â”€ Span: Render template [300ms]

é—®é¢˜:ä¸‰ä¸ªç‹¬ç«‹æŸ¥è¯¢ä¸²è¡Œæ‰§è¡Œ
è§£å†³:å¹¶è¡ŒæŸ¥è¯¢(asyncioã€Promise.allã€goroutine)
```

**æ¨¡å¼3:ç¼“å­˜æœªå‘½ä¸­é£æš´**

```
Traceæ˜¾ç¤º(10ä¸ªè¯·æ±‚):
â”œâ”€ Request 1: Redis GET â†’ MISS â†’ DB query [200ms]
â”œâ”€ Request 2: Redis GET â†’ MISS â†’ DB query [200ms]
â”œâ”€ Request 3: Redis GET â†’ MISS â†’ DB query [200ms]
...

é—®é¢˜:ç¼“å­˜é›ªå´©,æ‰€æœ‰è¯·æ±‚åŒæ—¶æœªå‘½ä¸­
è§£å†³:ç¼“å­˜é¢„çƒ­ã€åˆ†å¸ƒå¼é”ã€è¯·æ±‚åˆå¹¶
```

---

#### **å››ã€é‡‡æ ·ç­–ç•¥**

è¿½è¸ª100%è¯·æ±‚ä¼šäº§ç”Ÿå¤§é‡æ•°æ®ã€‚ç”Ÿäº§ç¯å¢ƒé€šå¸¸ä½¿ç”¨é‡‡æ ·:

```python
from opentelemetry.sdk.trace.sampling import (
    TraceIdRatioBased,
    ParentBased,
    ALWAYS_ON,
    ALWAYS_OFF,
)

# ç­–ç•¥1:å›ºå®šæ¯”ä¾‹é‡‡æ ·(10%)
sampler = TraceIdRatioBased(0.1)

# ç­–ç•¥2:çˆ¶çº§é‡‡æ ·(å¦‚æœçˆ¶Spanè¢«é‡‡æ ·,å­Spanä¹Ÿé‡‡æ ·)
sampler = ParentBased(root=TraceIdRatioBased(0.1))

# ç­–ç•¥3:è‡ªé€‚åº”é‡‡æ ·(é«˜é”™è¯¯ç‡æ—¶æé«˜é‡‡æ ·ç‡)
# éœ€è¦è‡ªå®šä¹‰å®ç°æˆ–ä½¿ç”¨Jaegerçš„è‡ªé€‚åº”é‡‡æ ·
```

**å°åº—é€šçš„é‡‡æ ·ç­–ç•¥:**
- âœ… æ‰€æœ‰é”™è¯¯è¯·æ±‚(5xx):100%é‡‡æ ·
- âœ… æ…¢è¯·æ±‚(>5s):100%é‡‡æ ·
- âœ… æ­£å¸¸è¯·æ±‚:10%é‡‡æ ·
- âœ… å¥åº·æ£€æŸ¥:0%é‡‡æ ·

---

#### **äº”ã€æˆæœ¬ä¼˜åŒ–**

##### **1. Spanæ•°æ®ä¿ç•™ç­–ç•¥**

```yaml
# Jaegeré…ç½®
storage:
  options:
    es:
      max-span-age: 168h  # 7å¤©åè‡ªåŠ¨åˆ é™¤
      
# æˆ–ä½¿ç”¨Elasticsearch ILMç­–ç•¥
PUT _ilm/policy/jaeger-ilm-policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",
            "max_age": "1d"
          }
        }
      },
      "delete": {
        "min_age": "7d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}
```

##### **2. å‡å°‘Spanå¤§å°**

```python
# âŒ ä¸è¦åœ¨Spanä¸­å­˜å‚¨å¤§é‡æ•°æ®
span.set_attribute("response_body", json.dumps(large_object))  # å¯èƒ½å‡ MB!

# âœ… åªå­˜å‚¨å…³é”®å…ƒæ•°æ®
span.set_attribute("response_size_bytes", len(response_body))
span.set_attribute("response_item_count", len(items))
```

##### **3. æ‰¹å¤„ç†ä¼˜åŒ–**

```python
# è°ƒæ•´æ‰¹å¤„ç†å‚æ•°,å‡å°‘ç½‘ç»œå¼€é”€
span_processor = BatchSpanProcessor(
    otlp_exporter,
    max_queue_size=4096,        # å¢åŠ é˜Ÿåˆ—å¤§å°
    schedule_delay_millis=10000, # 10ç§’æ‰¹æ¬¡(è€Œä¸æ˜¯5ç§’)
    max_export_batch_size=1024,  # å¢åŠ æ‰¹æ¬¡å¤§å°
)
```

---

#### **å…­ã€å¸¸è§é—®é¢˜æ’æŸ¥**

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|---------|
| **Jaeger UIçœ‹ä¸åˆ°Trace** | åº”ç”¨æœªå‘é€æ•°æ®æˆ–ç½‘ç»œé—®é¢˜ | æ£€æŸ¥åº”ç”¨æ—¥å¿—ã€ç½‘ç»œè¿é€šæ€§ã€é‡‡æ ·ç‡ |
| **Spanä¹‹é—´æ²¡æœ‰çˆ¶å­å…³ç³»** | Contextæœªæ­£ç¡®ä¼ æ’­ | ç¡®ä¿ä½¿ç”¨`start_as_current_span`,ä¸è¦ç”¨`start_span` |
| **è·¨æœåŠ¡Traceæ–­è£‚** | HTTP Headeræœªä¼ é€’ | ç¡®ä¿ä½¿ç”¨instrumentedçš„HTTPå®¢æˆ·ç«¯(requestsã€httpx) |
| **æ€§èƒ½å¼€é”€å¤§** | é‡‡æ ·ç‡100%æˆ–Spanè¿‡å¤š | é™ä½é‡‡æ ·ç‡ã€å‡å°‘è‡ªå®šä¹‰Span |
| **å­˜å‚¨ç©ºé—´å¢é•¿å¿«** | ä¿ç•™æœŸå¤ªé•¿æˆ–Spanå¤ªå¤§ | ç¼©çŸ­ä¿ç•™æœŸã€ä¼˜åŒ–Spanå¤§å° |

**è°ƒè¯•å‘½ä»¤:**

```bash
# æ£€æŸ¥åº”ç”¨æ˜¯å¦å‘é€Span
kubectl logs <pod-name> | grep -i "span"
kubectl logs <pod-name> | grep -i "otlp"

# æ£€æŸ¥Jaeger Collectoræ˜¯å¦æ¥æ”¶åˆ°æ•°æ®
kubectl logs -n observability jaeger-collector-xxx | grep "span"

# æ‰‹åŠ¨å‘é€æµ‹è¯•Span(ä½¿ç”¨OpenTelemetry CLI)
otel-cli span \
  --endpoint jaeger.observability:4317 \
  --service my-test \
  --name "manual-test-span" \
  --duration 100ms
```

---

#### **ä¸ƒã€è¿›é˜¶åŠŸèƒ½**

##### **1. å°¾é‡‡æ ·(Tail-based Sampling)**

æ™®é€šé‡‡æ ·åœ¨è¯·æ±‚å¼€å§‹æ—¶å†³å®šæ˜¯å¦é‡‡æ ·ã€‚å°¾é‡‡æ ·åœ¨è¯·æ±‚ç»“æŸå,æ ¹æ®ç»“æœå†³å®š:

```yaml
# Jaeger Collectoré…ç½®
sampling:
  strategies:
    - service: storefront
      type: adaptive
      param:
        sampling_rate: 0.001  # é»˜è®¤0.1%
        max_traces_per_second: 100
        # ä½†æ‰€æœ‰é”™è¯¯è¯·æ±‚éƒ½é‡‡æ ·
        policies:
          - type: status_code
            param: "5xx"
            sampling_rate: 1.0
```

##### **2. æœåŠ¡æ€§èƒ½ç›‘æ§(SPM)**

Jaegerå¯ä»¥æ ¹æ®Traceæ•°æ®è‡ªåŠ¨ç”ŸæˆæœåŠ¡æ€§èƒ½æŒ‡æ ‡:

```
æŒ‡æ ‡:
- è¯·æ±‚ç‡(QPS)
- é”™è¯¯ç‡
- P50/P95/P99å»¶è¿Ÿ
- æœåŠ¡ä¾èµ–å…³ç³»

åœ¨Jaeger UIçš„"Monitor"æ ‡ç­¾é¡µæŸ¥çœ‹
```

##### **3. å‘Šè­¦é›†æˆ**

```yaml
# Prometheuså‘Šè­¦è§„åˆ™(åŸºäºJaegerå¯¼å‡ºçš„æŒ‡æ ‡)
groups:
- name: tracing_alerts
  rules:
  - alert: HighTraceErrorRate
    expr: |
      sum(rate(traces_spanmetrics_calls_total{status_code="STATUS_CODE_ERROR"}[5m])) 
      / 
      sum(rate(traces_spanmetrics_calls_total[5m])) 
      > 0.05
    for: 5m
    annotations:
      summary: "è¿½è¸ªé”™è¯¯ç‡è¿‡é«˜"
      description: "{{ $labels.service_name }}çš„é”™è¯¯ç‡è¾¾åˆ°{{ $value | humanizePercentage }}"
```

---

**æ€»ç»“:**
- âœ… åˆ†å¸ƒå¼è¿½è¸ªå¯¹å¾®æœåŠ¡æ¶æ„è‡³å…³é‡è¦
- âœ… OpenTelemetryæ˜¯è¡Œä¸šæ ‡å‡†,æ”¯æŒå¤šè¯­è¨€
- âœ… Jaegeræ˜“äºéƒ¨ç½²,ä¸Kubernetesé›†æˆå¥½
- âœ… è‡ªåŠ¨æ’æ¡©å¯ä»¥é›¶ä»£ç æ”¹åŠ¨å®ç°åŸºç¡€è¿½è¸ª
- âš ï¸ æ³¨æ„é‡‡æ ·ç‡å’Œæ•°æ®ä¿ç•™ç­–ç•¥æ§åˆ¶æˆæœ¬
- âš ï¸ è¿½è¸ªä¸æ—¥å¿—ã€æŒ‡æ ‡ç»“åˆä½¿ç”¨,å½¢æˆå®Œæ•´å¯è§‚æµ‹æ€§

</div>

---

## ç¬¬21ç« :å…³é”®è¦ç‚¹

- **æ—¥å¿—å‘Šè¯‰ä½ å‘ç”Ÿäº†ä»€ä¹ˆ,è¿½è¸ªå‘Šè¯‰ä½ ç“¶é¢ˆåœ¨å“ªé‡Œ**:ä¸¤è€…æ˜¯äº’è¡¥çš„,ä¸æ˜¯æ›¿ä»£å…³ç³»ã€‚æ—¥å¿—æä¾›è¯¦ç»†ä¸Šä¸‹æ–‡,è¿½è¸ªæä¾›å…¨å±€è§†å›¾å’Œæ€§èƒ½åˆ†æã€‚

- **OpenTelemetryæ˜¯åˆ†å¸ƒå¼è¿½è¸ªçš„æ ‡å‡†**:å®ƒæ”¯æŒå¤šç§è¯­è¨€å’Œæ¡†æ¶,æä¾›è‡ªåŠ¨å’Œæ‰‹åŠ¨æ’æ¡©,å¹¶ä¸”æ˜¯å‚å•†ä¸­ç«‹çš„(å¯ä»¥åˆ‡æ¢åç«¯è€Œä¸æ”¹ä»£ç )ã€‚

- **è‡ªåŠ¨æ’æ¡©æ˜¯æ€æ‰‹çº§ç‰¹æ€§**:å¯¹äºHTTPã€æ•°æ®åº“ã€ç¼“å­˜ç­‰å¸¸è§æ“ä½œ,è‡ªåŠ¨æ’æ¡©å¯ä»¥é›¶ä»£ç æ”¹åŠ¨å®ç°è¿½è¸ªã€‚åªåœ¨å…³é”®ä¸šåŠ¡é€»è¾‘å¤„æ·»åŠ æ‰‹åŠ¨Spanã€‚

- **Context Propagationæ˜¯åˆ†å¸ƒå¼è¿½è¸ªçš„æ ¸å¿ƒ**:Trace IDå¿…é¡»åœ¨æœåŠ¡é—´ä¼ æ’­,æ‰èƒ½æ„å»ºå®Œæ•´çš„è°ƒç”¨é“¾ã€‚ä½¿ç”¨æ ‡å‡†çš„HTTP Header(traceparent)ç¡®ä¿å…¼å®¹æ€§ã€‚

- **ç€‘å¸ƒå›¾æ˜¯æ€§èƒ½ä¼˜åŒ–çš„åˆ©å™¨**:å­¦ä¼šé˜…è¯»Jaegerçš„ç€‘å¸ƒå›¾,è¯†åˆ«ä¸²è¡Œç­‰å¾…ã€N+1æŸ¥è¯¢ã€ç¼“å­˜æœªå‘½ä¸­ç­‰å¸¸è§æ€§èƒ½æ¨¡å¼ã€‚å¯è§†åŒ–æ¯”æ–‡å­—æ—¥å¿—ç›´è§‚100å€ã€‚

- **é‡‡æ ·ç­–ç•¥æ§åˆ¶æˆæœ¬**:ç”Ÿäº§ç¯å¢ƒä¸éœ€è¦è¿½è¸ª100%è¯·æ±‚ã€‚ä½¿ç”¨æ™ºèƒ½é‡‡æ ·(æ‰€æœ‰é”™è¯¯ã€æ…¢è¯·æ±‚ã€éƒ¨åˆ†æ­£å¸¸è¯·æ±‚)å¹³è¡¡å¯è§æ€§å’Œæˆæœ¬ã€‚

- **è¿½è¸ªé©±åŠ¨æ¶æ„æ”¹è¿›**:æœåŠ¡ä¾èµ–å›¾å¯ä»¥æ­ç¤ºæ¶æ„ä¸­çš„çƒ­ç‚¹æœåŠ¡ã€å•ç‚¹æ•…éšœã€å†—ä½™è°ƒç”¨ã€‚è¿™äº›æ´å¯Ÿæ¯”æ€§èƒ½ä¼˜åŒ–æœ¬èº«æ›´æœ‰ä»·å€¼ã€‚

